<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>JSON Web Token的认识与攻击 | 闲言语</title><meta name=keywords content><meta name=description content="本文首发 Freebuf 。略有更新。
0x01 初识JWT JWT （ JSON Web Token 的缩写）是一串带有声明信息的字符串，由服务端用加密算法对信息签名来保证其完整性和不可伪造。Token里可以包含所有必要信息，这样服务端就无需保存任何关于用户或会话的信息，JWT可用于身份认证、会话状态维持、信息交换等。
JWT 由三部分构成，分别称为 header 、payload 和 signature ，各部分用. 相连构成一个完整的Token，形如xxxxx.yyyyy.zzzzz 。
分别看下各个部分：
header ：
使用一个JSON格式字符串声明token的类型和签名用的算法等，形如{&#34;alg&#34;: &#34;HS256&#34;, &#34;typ&#34;: &#34;JWT&#34;} 。该字符串经过Base64Url编码后形成JWT的第一部分xxxxx。
Base64Url编码可以用这段代码直观理解：
1 2 3 4 5 6 7 8 9 10 from base64 import * def base64URLen(s): t0=b64encode(s) t1=t0.strip('=').replace('+','-').replace('/','_') return t1 def base64URLde(s): t0=s.replace('-','+').replace('_','/') t1=t0+'='*(4-len(t0)%4)%4 return b64decode(t1) payload :
使用一个JSON格式字符串描述所要声明的信息，分为 registered 、 public 、 和 private 三类，形如{&#34;name&#34;: &#34;John Doe&#34;, &#34;admin&#34;: true} ，具体信息可参考 RFC7519 的 JWT claims 部分。"><meta name=author content><link rel=canonical href=https://ret2neo.cn/post/180503jwt/><link crossorigin=anonymous href=/assets/css/stylesheet.42b1e004fb78db2fc933d33c9db659598f62453f0de6f9db50c85e5936c0d8c3.css integrity="sha256-QrHgBPt42y/JM9M8nbZZWY9iRT8N5vnbUMheWTbA2MM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ret2neo.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ret2neo.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ret2neo.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://ret2neo.cn/apple-touch-icon.png><link rel=mask-icon href=https://ret2neo.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="JSON Web Token的认识与攻击"><meta property="og:description" content="本文首发 Freebuf 。略有更新。
0x01 初识JWT JWT （ JSON Web Token 的缩写）是一串带有声明信息的字符串，由服务端用加密算法对信息签名来保证其完整性和不可伪造。Token里可以包含所有必要信息，这样服务端就无需保存任何关于用户或会话的信息，JWT可用于身份认证、会话状态维持、信息交换等。
JWT 由三部分构成，分别称为 header 、payload 和 signature ，各部分用. 相连构成一个完整的Token，形如xxxxx.yyyyy.zzzzz 。
分别看下各个部分：
header ：
使用一个JSON格式字符串声明token的类型和签名用的算法等，形如{&#34;alg&#34;: &#34;HS256&#34;, &#34;typ&#34;: &#34;JWT&#34;} 。该字符串经过Base64Url编码后形成JWT的第一部分xxxxx。
Base64Url编码可以用这段代码直观理解：
1 2 3 4 5 6 7 8 9 10 from base64 import * def base64URLen(s): t0=b64encode(s) t1=t0.strip('=').replace('+','-').replace('/','_') return t1 def base64URLde(s): t0=s.replace('-','+').replace('_','/') t1=t0+'='*(4-len(t0)%4)%4 return b64decode(t1) payload :
使用一个JSON格式字符串描述所要声明的信息，分为 registered 、 public 、 和 private 三类，形如{&#34;name&#34;: &#34;John Doe&#34;, &#34;admin&#34;: true} ，具体信息可参考 RFC7519 的 JWT claims 部分。"><meta property="og:type" content="article"><meta property="og:url" content="https://ret2neo.cn/post/180503jwt/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-05-03T22:22:34+08:00"><meta property="article:modified_time" content="2018-05-03T22:22:34+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="JSON Web Token的认识与攻击"><meta name=twitter:description content="本文首发 Freebuf 。略有更新。
0x01 初识JWT JWT （ JSON Web Token 的缩写）是一串带有声明信息的字符串，由服务端用加密算法对信息签名来保证其完整性和不可伪造。Token里可以包含所有必要信息，这样服务端就无需保存任何关于用户或会话的信息，JWT可用于身份认证、会话状态维持、信息交换等。
JWT 由三部分构成，分别称为 header 、payload 和 signature ，各部分用. 相连构成一个完整的Token，形如xxxxx.yyyyy.zzzzz 。
分别看下各个部分：
header ：
使用一个JSON格式字符串声明token的类型和签名用的算法等，形如{&#34;alg&#34;: &#34;HS256&#34;, &#34;typ&#34;: &#34;JWT&#34;} 。该字符串经过Base64Url编码后形成JWT的第一部分xxxxx。
Base64Url编码可以用这段代码直观理解：
1 2 3 4 5 6 7 8 9 10 from base64 import * def base64URLen(s): t0=b64encode(s) t1=t0.strip('=').replace('+','-').replace('/','_') return t1 def base64URLde(s): t0=s.replace('-','+').replace('_','/') t1=t0+'='*(4-len(t0)%4)%4 return b64decode(t1) payload :
使用一个JSON格式字符串描述所要声明的信息，分为 registered 、 public 、 和 private 三类，形如{&#34;name&#34;: &#34;John Doe&#34;, &#34;admin&#34;: true} ，具体信息可参考 RFC7519 的 JWT claims 部分。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ret2neo.cn/post/"},{"@type":"ListItem","position":2,"name":"JSON Web Token的认识与攻击","item":"https://ret2neo.cn/post/180503jwt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"JSON Web Token的认识与攻击","name":"JSON Web Token的认识与攻击","description":"本文首发 Freebuf 。略有更新。\n0x01 初识JWT JWT （ JSON Web Token 的缩写）是一串带有声明信息的字符串，由服务端用加密算法对信息签名来保证其完整性和不可伪造。Token里可以包含所有必要信息，这样服务端就无需保存任何关于用户或会话的信息，JWT可用于身份认证、会话状态维持、信息交换等。\nJWT 由三部分构成，分别称为 header 、payload 和 signature ，各部分用. 相连构成一个完整的Token，形如xxxxx.yyyyy.zzzzz 。\n分别看下各个部分：\nheader ：\n使用一个JSON格式字符串声明token的类型和签名用的算法等，形如{\u0026quot;alg\u0026quot;: \u0026quot;HS256\u0026quot;, \u0026quot;typ\u0026quot;: \u0026quot;JWT\u0026quot;} 。该字符串经过Base64Url编码后形成JWT的第一部分xxxxx。\nBase64Url编码可以用这段代码直观理解：\n1 2 3 4 5 6 7 8 9 10 from base64 import * def base64URLen(s): t0=b64encode(s) t1=t0.strip(\u0026#39;=\u0026#39;).replace(\u0026#39;+\u0026#39;,\u0026#39;-\u0026#39;).replace(\u0026#39;/\u0026#39;,\u0026#39;_\u0026#39;) return t1 def base64URLde(s): t0=s.replace(\u0026#39;-\u0026#39;,\u0026#39;+\u0026#39;).replace(\u0026#39;_\u0026#39;,\u0026#39;/\u0026#39;) t1=t0+\u0026#39;=\u0026#39;*(4-len(t0)%4)%4 return b64decode(t1) payload :\n使用一个JSON格式字符串描述所要声明的信息，分为 registered 、 public 、 和 private 三类，形如{\u0026quot;name\u0026quot;: \u0026quot;John Doe\u0026quot;, \u0026quot;admin\u0026quot;: true} ，具体信息可参考 RFC7519 的 JWT claims 部分。","keywords":[],"articleBody":"本文首发 Freebuf 。略有更新。\n0x01 初识JWT JWT （ JSON Web Token 的缩写）是一串带有声明信息的字符串，由服务端用加密算法对信息签名来保证其完整性和不可伪造。Token里可以包含所有必要信息，这样服务端就无需保存任何关于用户或会话的信息，JWT可用于身份认证、会话状态维持、信息交换等。\nJWT 由三部分构成，分别称为 header 、payload 和 signature ，各部分用. 相连构成一个完整的Token，形如xxxxx.yyyyy.zzzzz 。\n分别看下各个部分：\nheader ：\n使用一个JSON格式字符串声明token的类型和签名用的算法等，形如{\"alg\": \"HS256\", \"typ\": \"JWT\"} 。该字符串经过Base64Url编码后形成JWT的第一部分xxxxx。\nBase64Url编码可以用这段代码直观理解：\n1 2 3 4 5 6 7 8 9 10 from base64 import * def base64URLen(s): t0=b64encode(s) t1=t0.strip('=').replace('+','-').replace('/','_') return t1 def base64URLde(s): t0=s.replace('-','+').replace('_','/') t1=t0+'='*(4-len(t0)%4)%4 return b64decode(t1) payload :\n使用一个JSON格式字符串描述所要声明的信息，分为 registered 、 public 、 和 private 三类，形如{\"name\": \"John Doe\", \"admin\": true} ，具体信息可参考 RFC7519 的 JWT claims 部分。\n同样的，该字符串经过Base64Url编码形成JWT的第二部分yyyyy。\nsignature :\n将 xxxxx.yyyyy 使用alg 指定的算法加密，然后再Base64Url编码得到JWT的第三部分zzzzz 。所支持的算法 类型取决于实现，但HS256 和 none 是强制要求实现的。\n0x02 简单应用 在本地运行起简单的基于Express的可发放和处理JWT的服务。\n**安装Node.js。**Node.js是JavaScript运行时环境，采用轻量高效的事件驱动、无阻塞I/O模型，拥有最大的开源库生态nmp。 1 2 Windows平台可在 https://nodejs.org/en/download/ 下载安装包 *nix 平台可根据 https://nodejs.org/en/download/package-manager/ 提示使用包管理器安装 安装Express，一款基于Node.js的快速、灵活、极简的Web框架。 1 2 3 4 5 # http://expressjs.com/en/starter/installing.html mkdir D:\\myapp \u0026\u0026 cd D:\\myapp （全部回车，保持默认配置） npm init npm install express --save 运行本地服务 新建 index.js ，内容如下\n1 2 3 4 const express = require('express') const app = express() app.get('/', (req, res) =\u003e res.send('Hello World!')) app.listen(3000, () =\u003e console.log('Example app listening on port 3000!')) 运行node index.js ，就可从本地访问 http://localhost:3000 。\n安装必要模块： 适用于Node.js的JWT编解码模块 node-jwt-simple 和 cookie解析模块 cookie-parser 1 2 3 # https://github.com/hokaccha/node-jwt-simple npm install jwt-simple npm install cookie-parser 一个简单的本地demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 //index.js //http://expressjs.com/en/4x/api.html //https://github.com/hokaccha/node-jwt-simple //一些初始化的工作 const express = require('express') var jwt = require('jwt-simple') var cookieParser = require('cookie-parser') var jwt_secret = \"this is a secret for jwt\" const app = express() app.use(cookieParser()) app.get('/',(req,res)=\u003eres.redirect('/help')) app.get('/help', (req, res) =\u003e { var RequstedURL=req.protocol+'://'+req.get('Host') res.send([ 'GET '+RequstedURL+'/login?user=name\u0026pass=passwd to get your JSON Web Token ' , 'GET '+RequstedURL+'/whoami to identify yourself' ].join('\n')) }) app.get('/login',(req,res)=\u003e{ var users={ \"admin\":\"admin_password_is_hard_to_guess\", \"test\":\"test123\" } var payload = {\"name\":req.query.user} if(users[req.query.user]===req.query.pass){ res.cookie('jwt',jwt.encode(payload,jwt_secret)) res.send(req.query.user +' logged in') } else{res.send('login failed!')} }) app.get('/whoami',(req,res)=\u003e{ try {res.send(\"you are logged in as :\n\" +jwt.decode(req.cookies.jwt,jwt_secret)['name'])} catch(err) {res.send(\"your JWT is :\n\"+req.cookies.jwt)} }) app.listen(3000, () =\u003e { console.log('Example app listening on port 3000!'); console.log('Example app listening on port 3000!') }) 推荐几个在线工具 https://jwt.io by Sjoerd Langkemper 支持 hs256 算法 支持 rs256 算法 by Kenji Urushima 支持更多算法 kjur/jsjws 0x03 攻击面 发现敏感信息 JWT中的header 和 payload 虽然看起来不可读，但实际上都只经过简单编码，开发者可能误将敏感信息存储在里面。使用上述工具可以方便地解码JWT中前两部分的信息。\n指定算法为none 上面提到算法 none 是JWT规范中强制要求实现的，但有些实现JWT的库直接将使用none 算法的token视为已经过校验。这样攻击者就可以设置alg 为none ，使signature 部分为空，然后构造包含任意payload 的JWT来欺骗服务端。\n将签名算法从非对称类型改为对称类型 使用非对称加密算法（主要基于RSA、ECDSA，如S256）分发JWT的过程是使用私钥（private）加密生成JWT，使用公钥（public）解密验证。\n使用对称加密算法（主要基于HMAC，如HS256）分发JWT的过程是使用同一个密钥（secret）生成和验证JWT。\n如果服务端期待收到的算法类型为RS256，然后以RS256和public去验证JWT，而实际上收到的算法类型是HS256，那么服务端就可能尝试把public当作secret，然后用HS256算法解密验证JWT。\n由于RS256的public人人都可获得，攻击者可以预先以public为密钥，用HS256算法伪造包含任意payload 的JWT，从而成功通过服务端的验证。\n爆破密钥 JWT的安全性依赖于密钥的保密性，任何拥有密钥的人都可以构造任何内容的合法token。\n当一个JSON Web Token 被分发出去，如果密钥不够强壮就存在被爆破的风险，而且整个爆破过程可以离线进行。\n已经有人写了一些工具，推荐如下：\njwtbrute Sjord’ python script John the Ripper 伪造密钥 有时JWT采用header 中的kid 字段关联校验算法的密钥，这个密钥可能是对称加密的密钥，也可能是非对称加密的公钥。如果能够猜测kid 和 密钥的关联性，攻击者就可能修改kid 来欺骗服务端，使其校验时使用攻击者可控的密钥，于是攻击者就可以伪造任意内容的可通过校验的JWT。\n2017 HITB Pasty 关联性：kid是密钥URI的一部分。\n2018强网杯 easyweb 关联性：kid 带入数据库查询对应密钥，可联合查询或者盲注。\n详见 http://findneo.github.io/180430ciscn/#easyweb\n0x04 安全建议 验证函数应忽略JWT中的algo 字段，预先就明确JWT使用的算法，如果需要使用多种算法，可以在header 中使用表示\"key ID\" 的kid 字段，查询每个kid 对应的算法。 JWT/JWS 标准应该移除 header 中的algo 字段。JWT的许多安全缺陷都来自于开发者依赖这一客户端可控的字段。 开发者应升级相应库到最新版本，因为旧版本可能存在致命缺陷。 0x05 参考文章 https://jwt.io/introduction/ https://www.cnblogs.com/anny0404/p/5318692.html https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/ https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/ ","wordCount":"415","inLanguage":"en","datePublished":"2018-05-03T22:22:34+08:00","dateModified":"2018-05-03T22:22:34+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2neo.cn/post/180503jwt/"},"publisher":{"@type":"Organization","name":"闲言语","logo":{"@type":"ImageObject","url":"https://ret2neo.cn/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ret2neo.cn/ accesskey=h title="闲言语 (Alt + H)">闲言语</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ret2neo.cn/mind/ title=随笔><span>随笔</span></a></li><li><a href=https://ret2neo.cn/about title=关于><span>关于</span></a></li><li><a href=https://ret2neo.cn/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>JSON Web Token的认识与攻击</h1><div class=post-meta><span title='2018-05-03 22:22:34 +0800 CST'>May 3, 2018</span>&nbsp;|&nbsp;<a href=https://github.dev/findneo/priblog/content/post/180503jwt.md rel="noopener noreferrer" target=_blank>edit</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#0x01-%e5%88%9d%e8%af%86jwt aria-label="0x01 初识JWT">0x01 初识JWT</a></li><li><a href=#0x02-%e7%ae%80%e5%8d%95%e5%ba%94%e7%94%a8 aria-label="0x02 简单应用">0x02 简单应用</a></li><li><a href=#0x03-%e6%94%bb%e5%87%bb%e9%9d%a2 aria-label="0x03 攻击面">0x03 攻击面</a><ul><li><a href=#%e5%8f%91%e7%8e%b0%e6%95%8f%e6%84%9f%e4%bf%a1%e6%81%af aria-label=发现敏感信息>发现敏感信息</a></li><li><a href=#%e6%8c%87%e5%ae%9a%e7%ae%97%e6%b3%95%e4%b8%banone aria-label=指定算法为none>指定算法为none</a></li><li><a href=#%e5%b0%86%e7%ad%be%e5%90%8d%e7%ae%97%e6%b3%95%e4%bb%8e%e9%9d%9e%e5%af%b9%e7%a7%b0%e7%b1%bb%e5%9e%8b%e6%94%b9%e4%b8%ba%e5%af%b9%e7%a7%b0%e7%b1%bb%e5%9e%8b aria-label=将签名算法从非对称类型改为对称类型>将签名算法从非对称类型改为对称类型</a></li><li><a href=#%e7%88%86%e7%a0%b4%e5%af%86%e9%92%a5 aria-label=爆破密钥>爆破密钥</a></li><li><a href=#%e4%bc%aa%e9%80%a0%e5%af%86%e9%92%a5 aria-label=伪造密钥>伪造密钥</a><ul><li><a href=#2017-hitb-pasty aria-label="2017 HITB Pasty">2017 HITB Pasty</a></li><li><a href=#2018%e5%bc%ba%e7%bd%91%e6%9d%af-easyweb aria-label="2018强网杯 easyweb">2018强网杯 easyweb</a></li></ul></li></ul></li><li><a href=#0x04-%e5%ae%89%e5%85%a8%e5%bb%ba%e8%ae%ae aria-label="0x04 安全建议">0x04 安全建议</a></li><li><a href=#0x05-%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0 aria-label="0x05 参考文章">0x05 参考文章</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><strong>本文首发 <a href=http://www.freebuf.com/column/170359.html>Freebuf</a> 。略有更新。</strong></p><h1 id=0x01-初识jwt>0x01 初识JWT<a hidden class=anchor aria-hidden=true href=#0x01-初识jwt>#</a></h1><p>JWT （ <code>JSON Web Token</code> 的缩写）是一串带有声明信息的字符串，由服务端用加密算法对信息签名来保证其完整性和不可伪造。Token里可以包含所有必要信息，这样服务端就无需保存任何关于用户或会话的信息，JWT可用于身份认证、会话状态维持、信息交换等。</p><p>JWT 由三部分构成，分别称为 <code>header</code> 、<code>payload</code> 和 <code>signature</code> ，各部分用<code>.</code> 相连构成一个完整的Token，形如<code>xxxxx.yyyyy.zzzzz</code> 。</p><p>分别看下各个部分：</p><p><strong>header</strong> ：</p><p>使用一个JSON格式字符串声明token的类型和签名用的算法等，形如<code>{"alg": "HS256", "typ": "JWT"}</code> 。该字符串经过Base64Url编码后形成JWT的第一部分<code>xxxxx</code>。</p><p>Base64Url编码可以用这段代码直观理解：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> base64 <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>base64URLen</span>(s):
</span></span><span style=display:flex><span>	t0<span style=color:#f92672>=</span>b64encode(s)
</span></span><span style=display:flex><span>	t1<span style=color:#f92672>=</span>t0<span style=color:#f92672>.</span>strip(<span style=color:#e6db74>&#39;=&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;+&#39;</span>,<span style=color:#e6db74>&#39;-&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;/&#39;</span>,<span style=color:#e6db74>&#39;_&#39;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> t1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>base64URLde</span>(s):
</span></span><span style=display:flex><span>	t0<span style=color:#f92672>=</span>s<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;-&#39;</span>,<span style=color:#e6db74>&#39;+&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;_&#39;</span>,<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span>	t1<span style=color:#f92672>=</span>t0<span style=color:#f92672>+</span><span style=color:#e6db74>&#39;=&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>4</span><span style=color:#f92672>-</span>len(t0)<span style=color:#f92672>%</span><span style=color:#ae81ff>4</span>)<span style=color:#f92672>%</span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> b64decode(t1)
</span></span></code></pre></td></tr></table></div></div><p><strong>payload</strong> :</p><p>使用一个JSON格式字符串描述所要声明的信息，分为 <code>registered</code> 、<code> public</code> 、 和 <code>private</code> 三类，形如<code>{"name": "John Doe", "admin": true}</code> ，具体信息可参考 <a href=https://tools.ietf.org/html/rfc7519#section-4>RFC7519 的 JWT claims</a> 部分。</p><p>同样的，该字符串经过Base64Url编码形成JWT的第二部分<code>yyyyy</code>。</p><p><strong>signature</strong> :</p><p>将 <code>xxxxx.yyyyy</code> 使用<code>alg</code> 指定的算法加密，然后再Base64Url编码得到JWT的第三部分<code>zzzzz</code> 。所支持的算法 类型取决于实现，但<code>HS256</code> 和 <code>none</code> 是强制要求实现的。</p><h1 id=0x02-简单应用>0x02 简单应用<a hidden class=anchor aria-hidden=true href=#0x02-简单应用>#</a></h1><p>在本地运行起简单的基于Express的可发放和处理JWT的服务。</p><ol><li>**安装Node.js。**Node.js是JavaScript运行时环境，采用轻量高效的事件驱动、无阻塞I/O模型，拥有最大的开源库生态nmp。</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>Windows平台可在</span> <span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//nodejs.org/en/download/ 下载安装包 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>*</span><span style=color:#a6e22e>nix</span> <span style=color:#a6e22e>平台可根据</span> <span style=color:#a6e22e>https</span><span style=color:#f92672>:</span><span style=color:#75715e>//nodejs.org/en/download/package-manager/ 提示使用包管理器安装
</span></span></span></code></pre></td></tr></table></div></div><ol><li><strong>安装Express</strong>，一款基于Node.js的快速、灵活、极简的Web框架。</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># http://expressjs.com/en/starter/installing.html</span>
</span></span><span style=display:flex><span>mkdir D:<span style=color:#ae81ff>\m</span>yapp <span style=color:#f92672>&amp;&amp;</span> cd D:<span style=color:#ae81ff>\m</span>yapp 
</span></span><span style=display:flex><span>	（全部回车，保持默认配置）
</span></span><span style=display:flex><span>npm init 
</span></span><span style=display:flex><span>npm install express --save
</span></span></code></pre></td></tr></table></div></div><ol><li><strong>运行本地服务</strong></li></ol><p>新建 <code>index.js</code> ，内容如下</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;Hello World!&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>, () =&gt; <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Example app listening on port 3000!&#39;</span>))
</span></span></code></pre></td></tr></table></div></div><p>运行<code>node index.js</code> ，就可从本地访问 <code>http://localhost:3000</code> 。</p><ol><li><strong>安装必要模块：</strong> 适用于Node.js的JWT编解码模块 <code>node-jwt-simple</code> 和 cookie解析模块 <code>cookie-parser</code></li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># https://github.com/hokaccha/node-jwt-simple</span>
</span></span><span style=display:flex><span>npm install jwt-simple
</span></span><span style=display:flex><span>npm install cookie-parser
</span></span></code></pre></td></tr></table></div></div><ol><li><strong>一个简单的本地demo</strong></li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-43>43</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>//index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e>//http://expressjs.com/en/4x/api.html
</span></span></span><span style=display:flex><span><span style=color:#75715e>//https://github.com/hokaccha/node-jwt-simple
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//一些初始化的工作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>jwt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;jwt-simple&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cookieParser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;cookie-parser&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>jwt_secret</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;this is a secret for jwt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>cookieParser</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/&#39;</span>,(<span style=color:#a6e22e>req</span>,<span style=color:#a6e22e>res</span>)=&gt;<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>redirect</span>(<span style=color:#e6db74>&#39;/help&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/help&#39;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>RequstedURL</span><span style=color:#f92672>=</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>protocol</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;://&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;Host&#39;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>([ 
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#39;GET &#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>RequstedURL</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/login?user=name&amp;pass=passwd to get your JSON Web Token &#39;</span> , 
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#39;GET &#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>RequstedURL</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/whoami to identify yourself&#39;</span>
</span></span><span style=display:flex><span>		].<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;&lt;br&gt;&#39;</span>))
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/login&#39;</span>,(<span style=color:#a6e22e>req</span>,<span style=color:#a6e22e>res</span>)=&gt;{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>users</span><span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;admin&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;admin_password_is_hard_to_guess&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;test&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;test123&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>:</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>user</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>users</span>[<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>user</span>]<span style=color:#f92672>===</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>pass</span>){
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>cookie</span>(<span style=color:#e6db74>&#39;jwt&#39;</span>,<span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>encode</span>(<span style=color:#a6e22e>payload</span>,<span style=color:#a6e22e>jwt_secret</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span><span style=color:#e6db74>&#39; logged in&#39;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span>{<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#39;login failed!&#39;</span>)}
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/whoami&#39;</span>,(<span style=color:#a6e22e>req</span>,<span style=color:#a6e22e>res</span>)=&gt;{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> {<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;you are logged in as :&lt;br&gt;&#34;</span> <span style=color:#f92672>+</span><span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>cookies</span>.<span style=color:#a6e22e>jwt</span>,<span style=color:#a6e22e>jwt_secret</span>)[<span style=color:#e6db74>&#39;name&#39;</span>])}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>catch</span>(<span style=color:#a6e22e>err</span>) {<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;your JWT is :&lt;br&gt;&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>cookies</span>.<span style=color:#a6e22e>jwt</span>)}
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>, () =&gt; {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Example app listening on port 3000!&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Example app listening on port 3000!&#39;</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><ul><li>推荐几个在线工具<ul><li><a href=https://jwt.io>https://jwt.io</a></li><li>by Sjoerd Langkemper<ul><li>支持 <a href=http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php>hs256</a> 算法</li><li>支持 <a href=http://demo.sjoerdlangkemper.nl/jwtdemo/rs256.php>rs256</a> 算法</li></ul></li><li>by Kenji Urushima<ul><li>支持更多算法 <a href=https://kjur.github.io/jsjws/tool_jwt.html>kjur/jsjws</a></li></ul></li></ul></li></ul><h1 id=0x03-攻击面>0x03 攻击面<a hidden class=anchor aria-hidden=true href=#0x03-攻击面>#</a></h1><h2 id=发现敏感信息>发现敏感信息<a hidden class=anchor aria-hidden=true href=#发现敏感信息>#</a></h2><p>JWT中的<code>header</code> 和 <code>payload</code> 虽然看起来不可读，但实际上都只经过简单编码，开发者可能误将敏感信息存储在里面。使用上述工具可以方便地解码JWT中前两部分的信息。</p><h2 id=指定算法为none>指定算法为none<a hidden class=anchor aria-hidden=true href=#指定算法为none>#</a></h2><p>上面提到算法 <code>none</code> 是JWT规范中强制要求实现的，但有些实现JWT的库直接将使用<code>none</code> 算法的token视为已经过校验。这样攻击者就可以设置<code>alg</code> 为<code>none</code> ，使<code>signature</code> 部分为空，然后构造包含任意<code>payload</code> 的JWT来欺骗服务端。</p><p><img loading=lazy src=47c7a7e8e1faf9fc8.png alt></p><h2 id=将签名算法从非对称类型改为对称类型>将签名算法从非对称类型改为对称类型<a hidden class=anchor aria-hidden=true href=#将签名算法从非对称类型改为对称类型>#</a></h2><p>使用非对称加密算法（主要基于RSA、ECDSA，如S256）分发JWT的过程是使用私钥（private）加密生成JWT，使用公钥（public）解密验证。</p><p>使用对称加密算法（主要基于HMAC，如HS256）分发JWT的过程是使用同一个密钥（secret）生成和验证JWT。</p><p>如果服务端期待收到的算法类型为RS256，然后以RS256和public去验证JWT，而实际上收到的算法类型是HS256，那么服务端就可能尝试把public当作secret，然后用HS256算法解密验证JWT。</p><p>由于RS256的public人人都可获得，攻击者可以预先以public为密钥，用HS256算法伪造包含任意<code>payload</code> 的JWT，从而成功通过服务端的验证。</p><p><img loading=lazy src=4aedec775bedd6d2e.png alt></p><h2 id=爆破密钥>爆破密钥<a hidden class=anchor aria-hidden=true href=#爆破密钥>#</a></h2><p>JWT的安全性依赖于密钥的保密性，任何拥有密钥的人都可以构造任何内容的合法token。</p><p>当一个JSON Web Token 被分发出去，如果密钥不够强壮就存在被爆破的风险，而且整个爆破过程可以离线进行。</p><p>已经有人写了一些工具，推荐如下：</p><ul><li><a href=https://github.com/jmaxxz/jwtbrute>jwtbrute</a></li><li><a href=https://github.com/Sjord/jwtcrack/blob/master/crackjwt.py>Sjord&rsquo; python script</a></li><li><a href=https://github.com/magnumripper/JohnTheRipper>John the Ripper</a></li></ul><h2 id=伪造密钥>伪造密钥<a hidden class=anchor aria-hidden=true href=#伪造密钥>#</a></h2><p>有时JWT采用<code>header</code> 中的<code>kid</code> 字段关联校验算法的密钥，这个密钥可能是对称加密的密钥，也可能是非对称加密的公钥。如果能够猜测<code>kid</code> 和 密钥的关联性，攻击者就可能修改<code>kid</code> 来欺骗服务端，使其校验时使用攻击者可控的密钥，于是攻击者就可以伪造任意内容的可通过校验的JWT。</p><h3 id=2017-hitb-pasty>2017 HITB Pasty<a hidden class=anchor aria-hidden=true href=#2017-hitb-pasty>#</a></h3><p>关联性：kid是密钥URI的一部分。</p><p><img loading=lazy src=a865d8a6c778bbf68.png alt></p><h3 id=2018强网杯-easyweb>2018强网杯 easyweb<a hidden class=anchor aria-hidden=true href=#2018强网杯-easyweb>#</a></h3><p>关联性：kid 带入数据库查询对应密钥，可联合查询或者盲注。</p><p>详见 <a href=http://findneo.github.io/180430ciscn/#easyweb>http://findneo.github.io/180430ciscn/#easyweb</a></p><h1 id=0x04-安全建议>0x04 安全建议<a hidden class=anchor aria-hidden=true href=#0x04-安全建议>#</a></h1><ul><li>验证函数应忽略JWT中的<code>algo</code> 字段，预先就明确JWT使用的算法，如果需要使用多种算法，可以在<code>header</code> 中使用表示"key ID" 的<code>kid</code> 字段，查询每个<code>kid</code> 对应的算法。</li><li>JWT/JWS 标准应该移除 <code>header</code> 中的<code>algo</code> 字段。JWT的许多安全缺陷都来自于开发者依赖这一客户端可控的字段。</li><li>开发者应升级相应库到最新版本，因为旧版本可能存在致命缺陷。</li></ul><h1 id=0x05-参考文章>0x05 参考文章<a hidden class=anchor aria-hidden=true href=#0x05-参考文章>#</a></h1><ul><li><a href=https://jwt.io/introduction/>https://jwt.io/introduction/</a></li><li><a href=https://www.cnblogs.com/anny0404/p/5318692.html>https://www.cnblogs.com/anny0404/p/5318692.html</a></li><li><a href=https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/>https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/</a></li><li><a href=https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/>https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ret2neo.cn/post/180512kaliondocker/><span class=title>« Prev</span><br><span>在win10家庭版上的Docker中使用Kali</span></a>
<a class=next href=https://ret2neo.cn/post/180430ciscn/><span class=title>Next »</span><br><span>第十一届全国大学生信息安全竞赛“创新实践能力赛”</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://ret2neo.cn/>闲言语</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2303473689051162" crossorigin=anonymous></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>